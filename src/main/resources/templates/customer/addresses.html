<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head"></head>
<body class="bg-light">

<nav th:replace="fragments/header :: navbar"></nav>

<!-- Profile & Password Modals -->
<div th:replace="fragments/header :: profile-modal"></div>
<div th:replace="fragments/header :: password-modal"></div>

<div class="container mt-4">
    <h3>üìç Qu·∫£n l√Ω ƒë·ªãa ch·ªâ</h3>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Danh s√°ch ƒë·ªãa ch·ªâ</h5>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addressModal">
                            Th√™m ƒë·ªãa ch·ªâ m·ªõi
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="addressesList">
                            <!-- Addresses will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Address Modal -->
    <div class="modal fade" id="addressModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Th√™m/S·ª≠a ƒë·ªãa ch·ªâ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addressForm">
                        <input type="hidden" id="addressId">
                        <div class="mb-3">
                            <label class="form-label">T√™n ng∆∞·ªùi nh·∫≠n</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
                            <textarea class="form-control" id="address" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">T·ªânh/Th√†nh ph·ªë</label>
                                    <input type="text" class="form-control" id="city">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Qu·∫≠n/Huy·ªán</label>
                                    <input type="text" class="form-control" id="district">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Ph∆∞·ªùng/X√£</label>
                                    <input type="text" class="form-control" id="ward">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">M√£ b∆∞u ƒëi·ªán</label>
                            <input type="text" class="form-control" id="postalCode">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isDefault">
                            <label class="form-check-label" for="isDefault">
                                ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveAddress()">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let addresses = [];
        let editingAddressId = null;

        async function loadAddresses() {
            try {
                const response = await fetch('/api/customer/addresses', {
                    credentials: 'include'
                });
                addresses = await response.json();
                renderAddresses();
            } catch (error) {
                console.error('Error loading addresses:', error);
            }
        }

        function renderAddresses() {
            const container = document.getElementById('addressesList');
            if (addresses.length === 0) {
                container.innerHTML = '<p class="text-muted">Ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o. H√£y th√™m ƒë·ªãa ch·ªâ ƒë·∫ßu ti√™n!</p>';
                return;
            }

            container.innerHTML = addresses.map(addr => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>${addr.name} ${addr.isDefault ? '<span class="badge bg-primary">M·∫∑c ƒë·ªãnh</span>' : ''}</h6>
                                <p class="mb-1">${addr.phone}</p>
                                <p class="mb-1">${addr.address}</p>
                                <small class="text-muted">${addr.city}, ${addr.district}, ${addr.ward}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="editAddress(${addr.id})">S·ª≠a</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteAddress(${addr.id})">X√≥a</button>
                                ${!addr.isDefault ? `<button class="btn btn-sm btn-outline-success" onclick="setDefault(${addr.id})">ƒê·∫∑t m·∫∑c ƒë·ªãnh</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editAddress(id) {
            const address = addresses.find(addr => addr.id === id);
            if (address) {
                editingAddressId = id;
                document.getElementById('addressId').value = address.id;
                document.getElementById('name').value = address.name;
                document.getElementById('phone').value = address.phone;
                document.getElementById('address').value = address.address;
                document.getElementById('city').value = address.city || '';
                document.getElementById('district').value = address.district || '';
                document.getElementById('ward').value = address.ward || '';
                document.getElementById('postalCode').value = address.postalCode || '';
                document.getElementById('isDefault').checked = address.isDefault;
                
                const modal = new bootstrap.Modal(document.getElementById('addressModal'));
                modal.show();
            }
        }

        async function saveAddress() {
            const formData = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                district: document.getElementById('district').value,
                ward: document.getElementById('ward').value,
                postalCode: document.getElementById('postalCode').value,
                isDefault: document.getElementById('isDefault').checked
            };

            try {
                const url = editingAddressId ? 
                    `/api/customer/addresses/${editingAddressId}` : 
                    '/api/customer/addresses';
                const method = editingAddressId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    await loadAddresses();
                    bootstrap.Modal.getInstance(document.getElementById('addressModal')).hide();
                    editingAddressId = null;
                    document.getElementById('addressForm').reset();
                } else {
                    alert('L·ªói khi l∆∞u ƒë·ªãa ch·ªâ');
                }
            } catch (error) {
                console.error('Error saving address:', error);
                alert('L·ªói khi l∆∞u ƒë·ªãa ch·ªâ');
            }
        }

        async function deleteAddress(id) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë·ªãa ch·ªâ n√†y?')) {
                try {
                    const response = await fetch(`/api/customer/addresses/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        await loadAddresses();
                    } else {
                        alert('L·ªói khi x√≥a ƒë·ªãa ch·ªâ');
                    }
                } catch (error) {
                    console.error('Error deleting address:', error);
                    alert('L·ªói khi x√≥a ƒë·ªãa ch·ªâ');
                }
            }
        }

        async function setDefault(id) {
            try {
                const response = await fetch(`/api/customer/addresses/${id}/set-default`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    await loadAddresses();
                } else {
                    alert('L·ªói khi ƒë·∫∑t ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh');
                }
            } catch (error) {
                console.error('Error setting default address:', error);
                alert('L·ªói khi ƒë·∫∑t ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh');
            }
        }

        // Load addresses on page load
        loadAddresses();
    </script>
</div>

<footer th:replace="fragments/footer :: footer"></footer>

<!-- Profile Script -->
<script th:replace="fragments/header :: profile-script"></script>

</body>
</html>
