<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/header_customer :: head"></head>
  <style>
    /* Clean & Professional Profile Styles */
    body {
      background-color: #f5f7fa;
    }
    
    .profile-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px 12px 0 0;
      margin: -1px -1px 0 -1px;
    }
    
    .nav-tabs-profile {
      border-bottom: 2px solid #e1e8ed;
      margin-bottom: 0;
      background: white;
      padding: 0 1.5rem;
    }
    
    .nav-tabs-profile .nav-link {
      border: none;
      color: #7f8c8d;
      font-weight: 500;
      padding: 1rem 1.5rem;
      transition: all 0.2s ease;
    }
    
    .nav-tabs-profile .nav-link:hover {
      color: #3498db;
    }
    
    .nav-tabs-profile .nav-link.active {
      color: #3498db;
      border-bottom: 3px solid #3498db;
      background: transparent;
    }
    
    .avatar-upload-container {
      position: relative;
      width: 120px;
      height: 120px;
    }
    
    .avatar-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-upload-avatar {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 0.5rem 1.2rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-upload-avatar:hover {
      background-color: #2980b9;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    
    .address-card {
      border: 1px solid #e1e8ed;
      border-radius: 10px;
      padding: 1.2rem;
      margin-bottom: 1rem;
      transition: all 0.2s ease;
      background: white;
    }
    
    .address-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }
    
    .badge-default {
      background-color: #3498db;
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .btn-action {
      padding: 0.4rem 1rem;
      font-size: 0.875rem;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .form-control-clean {
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control-clean:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .form-label-clean {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }
  </style>
  <body>
    <nav th:replace="fragments/header_customer :: navbar"></nav>

    <!-- Profile & Password Modals -->
    <div th:replace="fragments/change_password_modal :: change-password-modal"></div>

    <div class="container mt-4 mb-5">
      <div class="row justify-content-center">
        <!-- CONTENT -->
        <main class="col-12 col-lg-10 col-xl-10">
          <div class="card" style="border-radius: 12px; border: 1px solid #e1e8ed; overflow: hidden;">
            <!-- Header -->
            <div class="profile-header">
              <h3 class="mb-1">
                <i class="bi bi-person-circle me-2"></i>Hồ sơ của tôi
              </h3>
              <p class="mb-0 opacity-75">Quản lý thông tin cá nhân và địa chỉ của bạn</p>
            </div>
            
            <!-- Tabs -->
            <ul class="nav nav-tabs nav-tabs-profile" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" 
                        data-bs-target="#info" type="button" role="tab">
                  <i class="bi bi-person me-2"></i>Thông tin cá nhân
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="addresses-tab" data-bs-toggle="tab" 
                        data-bs-target="#addresses" type="button" role="tab">
                  <i class="bi bi-geo-alt me-2"></i>Địa chỉ của tôi
                </button>
              </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content">
              <!-- Tab 1: Thông tin cá nhân -->
              <div class="tab-pane fade show active" id="info" role="tabpanel">
                <div class="card-body p-4">
              <!-- Avatar Section -->
                  <div class="text-center mb-4 pb-4 border-bottom">
                    <div class="avatar-upload-container mx-auto mb-3">
                      <img
                        id="avatarPreview"
                        src="/images/default-avatar.png"
                        alt="Avatar"
                        class="avatar-preview"
                      />
                    </div>
                    <h5 class="mb-1" id="displayName">Tên người dùng</h5>
                    <p class="text-muted mb-3" id="displayEmail">email@example.com</p>
                      <button
                        type="button"
                      class="btn btn-upload-avatar"
                        onclick="document.getElementById('avatarInput').click()"
                      >
                      <i class="bi bi-camera me-2"></i>Thay đổi ảnh đại diện
                      </button>
                  <input
                    type="file"
                    id="avatarInput"
                    accept="image/*"
                    style="display: none"
                    onchange="previewAvatar(this)"
                  />
                    <div class="mt-2">
                      <small class="text-muted">JPG, PNG tối đa 5MB</small>
                </div>
              </div>

              <!-- Profile Form -->
              <form id="profileFormMain">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label-clean">Tên đăng nhập</label>
                    <input
                      type="text"
                          class="form-control form-control-clean"
                      id="profileUsernameMain"
                      readonly
                    />
                  </div>
                      <div class="col-md-6">
                        <label class="form-label-clean">Email</label>
                    <input
                      type="email"
                          class="form-control form-control-clean"
                      id="profileEmailMain"
                      required
                    />
                  </div>
                      <div class="col-md-6">
                        <label class="form-label-clean">Họ và tên</label>
                    <input
                      type="text"
                          class="form-control form-control-clean"
                      id="profileFullNameMain"
                      required
                    />
                  </div>
                      <div class="col-md-6">
                        <label class="form-label-clean">Số điện thoại</label>
                    <input
                      type="tel"
                          class="form-control form-control-clean"
                      id="profilePhoneMain"
                          placeholder="VD: 0901234567"
                    />
                  </div>
                </div>

                    <div id="profileAlertMain" class="alert d-none mt-3"></div>

                    <div class="mt-4">
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="saveButtonMain"
                    onclick="saveProfileMain()"
                        style="padding: 0.75rem 2rem; border-radius: 8px; font-weight: 500;"
                  >
                        <i class="bi bi-check-circle me-2"></i>Lưu thay đổi
                  </button>
                </div>
              </form>
                </div>
              </div>
              
              <!-- Tab 2: Địa chỉ -->
              <div class="tab-pane fade" id="addresses" role="tabpanel">
                <div class="card-body p-4">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">
                      <i class="bi bi-geo-alt me-2"></i>Danh sách địa chỉ
                    </h5>
                    <button 
                      id="btnAddAddress" 
                      class="btn btn-primary" 
                      data-bs-toggle="modal" 
                      data-bs-target="#addressModal"
                      style="padding: 0.6rem 1.5rem; border-radius: 8px; font-weight: 500;"
                    >
                      <i class="bi bi-plus-circle me-2"></i>Thêm địa chỉ mới
                    </button>
                  </div>
                  
                  <div id="addressesAlert" class="alert d-none"></div>
                  <div id="addressesList">
                    <!-- Loading skeleton -->
                    <div class="placeholder-glow">
                      <div class="address-card">
                        <span class="placeholder col-3"></span>
                        <p class="placeholder col-5 mb-1"></p>
                        <p class="placeholder col-8 mb-1"></p>
                        <p class="placeholder col-4 mb-0"></p>
                      </div>
                      <div class="address-card">
                        <span class="placeholder col-2"></span>
                        <p class="placeholder col-6 mb-1"></p>
                        <p class="placeholder col-7 mb-1"></p>
                        <p class="placeholder col-3 mb-0"></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
    
    <!-- Address Modal -->
    <div class="modal fade" id="addressModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 12px; border: 1px solid #e1e8ed;">
          <div class="modal-header" style="background-color: #f8f9fa; border-bottom: 2px solid #e1e8ed;">
            <h5 id="addressModalTitle" class="modal-title fw-bold">Thêm địa chỉ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
          </div>
          <div class="modal-body p-4">
            <form id="addressForm">
              <input type="hidden" id="addressId">

              <div class="mb-3">
                <label class="form-label-clean">Họ và tên</label>
                <input type="text" class="form-control form-control-clean" id="name" required>
              </div>

              <div class="mb-3">
                <label class="form-label-clean">Số điện thoại</label>
                <input type="tel" class="form-control form-control-clean" id="phone" required placeholder="VD: 0901234567">
                <div class="form-text">Chỉ nhập số, 9–11 ký tự.</div>
              </div>

              <div class="mb-3">
                <label class="form-label-clean">Địa chỉ chi tiết</label>
                <textarea class="form-control form-control-clean" id="address" rows="3" required placeholder="Số nhà, đường, ..."></textarea>
              </div>

              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label-clean">Tỉnh/Thành phố</label>
                  <input type="text" class="form-control form-control-clean" id="city">
                </div>
                <div class="col-md-4">
                  <label class="form-label-clean">Quận/Huyện</label>
                  <input type="text" class="form-control form-control-clean" id="district">
                </div>
                <div class="col-md-4">
                  <label class="form-label-clean">Phường/Xã</label>
                  <input type="text" class="form-control form-control-clean" id="ward">
                </div>
              </div>

              <div class="mb-3 mt-3">
                <label class="form-label-clean">Mã bưu điện</label>
                <input type="text" class="form-control form-control-clean" id="postalCode" placeholder="VD: 700000">
              </div>

              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="isDefault">
                <label class="form-check-label" for="isDefault">Đặt làm địa chỉ mặc định</label>
              </div>
            </form>
            <div id="addressFormAlert" class="alert d-none mt-3"></div>
          </div>
          <div class="modal-footer" style="background-color: #f8f9fa; border-top: 2px solid #e1e8ed;">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius: 8px;">Hủy</button>
            <button type="button" class="btn btn-primary" id="btnSaveAddress" style="border-radius: 8px; font-weight: 500;">
              <i class="bi bi-check-circle me-2"></i>Lưu
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer th:replace="fragments/footer :: footer"></footer>

    <!-- Change Password Script -->
    <script th:replace="fragments/change_password_modal :: change-password-script"></script>
    
    <script>
      // ========== Profile Variables ==========
      let addresses = [];
      let editingAddressId = null;

      // ========== Profile Functions ==========
      function previewAvatar(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById("avatarPreview").src = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
          window.selectedAvatarFile = input.files[0];
        }
      }

      function showAlertProfile(type, message) {
        const alertBox = document.getElementById("profileAlertMain");
        alertBox.className = `alert alert-${type}`;
        alertBox.textContent = message;
        alertBox.classList.remove("d-none");
        setTimeout(() => {
          alertBox.classList.add("d-none");
        }, 3000);
      }

      async function saveProfileMain() {
        const saveButton = document.getElementById("saveButtonMain");
        const originalText = saveButton.innerHTML;

        saveButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Đang lưu...';
        saveButton.disabled = true;

        try {
          const email = document.getElementById("profileEmailMain").value;
          const fullName = document.getElementById("profileFullNameMain").value;
          const phone = document.getElementById("profilePhoneMain").value;

          const profileData = { email, fullName, phone };
          const profileResponse = await fetch("/api/customer/profile", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(profileData),
          });

          const profileText = await profileResponse.text();
         
          if (!profileResponse.ok) {
            showAlertProfile("danger", "Lỗi cập nhật thông tin: " + profileText);
            return;
          }

          if (!window.selectedAvatarFile) {
            showAlertProfile("success", "Cập nhật thông tin thành công!");
            setTimeout(() => { window.location.reload(); }, 2000);
            return;
          }

          if (window.selectedAvatarFile) {
            const avatarFormData = new FormData();
            avatarFormData.append("avatar", window.selectedAvatarFile);

            const avatarResponse = await fetch("/api/customer/profile/avatar", {
              method: "POST",
              credentials: "include",
              body: avatarFormData,
            });

            if (avatarResponse.ok) {
              const user = await avatarResponse.json();
              if (user.avatarUrl) {
                document.getElementById("avatarPreview").src = user.avatarUrl;
              }
            } else {
              const avatarError = await avatarResponse.text();
              showAlertProfile("warning", "Thông tin đã cập nhật nhưng ảnh đại diện thất bại: " + avatarError);
              return;
            }
          }

          showAlertProfile("success", "Cập nhật thông tin và ảnh đại diện thành công!");
          window.selectedAvatarFile = null;
          document.getElementById("avatarInput").value = "";
          setTimeout(() => { window.location.reload(); }, 2000);
        } catch (error) {
          console.error("Error saving profile:", error);
          showAlertProfile("danger", "Lỗi khi cập nhật thông tin: " + error.message);
        } finally {
          saveButton.innerHTML = originalText;
          saveButton.disabled = false;
        }
      }

      async function loadUserProfile() {
        try {
          const response = await fetch("/api/customer/profile", { credentials: "include" });
          if (response.ok) {
            const user = await response.json();
            document.getElementById("profileUsernameMain").value = user.username || "";
            document.getElementById("profileEmailMain").value = user.email || "";
            document.getElementById("profileFullNameMain").value = user.fullName || "";
            document.getElementById("profilePhoneMain").value = user.phone || "";
            
            // Update display name and email
            document.getElementById("displayName").textContent = user.fullName || user.username || "Tên người dùng";
            document.getElementById("displayEmail").textContent = user.email || "email@example.com";
            
            // Update avatar
            if (user.avatarUrl) {
              document.getElementById("avatarPreview").src = user.avatarUrl;
            }
          }
        } catch (error) {
          console.error("Error loading profile:", error);
        }
      }

      // ========== Address Management Functions ==========
      function showAlertAddress(el, type, msg) {
        el.className = `alert alert-${type}`;
        el.textContent = msg;
        el.classList.remove('d-none');
      }

      function hideAlertAddress(el) {
        el.classList.add('d-none');
      }

      function maskPhone(p) {
        return p ? p.replace(/(\d{3})\d{3,4}(\d{2})$/, "$1****$2") : "";
      }

      function validateForm() {
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const addr = document.getElementById('address').value.trim();
        const postal = document.getElementById('postalCode').value.trim();

        if (!name || !phone || !addr) return { ok: false, msg: "Vui lòng nhập đủ Tên, SĐT và Địa chỉ chi tiết." };
        if (!/^\d{9,11}$/.test(phone)) return { ok: false, msg: "Số điện thoại không hợp lệ. Chỉ số, 9–11 ký tự." };
        if (postal && !/^\d{4,8}$/.test(postal)) return { ok: false, msg: "Mã bưu điện không hợp lệ." };

        return { ok: true };
      }

      async function loadAddresses() {
        const container = document.getElementById('addressesList');
        const pageAlert = document.getElementById('addressesAlert');
        hideAlertAddress(pageAlert);

        try {
          const res = await fetch('/api/customer/addresses', { credentials: 'include' });
          if (!res.ok) throw new Error(await res.text() || 'Không tải được địa chỉ');
          addresses = await res.json();
          renderAddresses();
        } catch (err) {
          console.error('Error loading addresses:', err);
          showAlertAddress(pageAlert, 'danger', 'Không thể tải danh sách địa chỉ. Vui lòng thử lại.');
          container.innerHTML = '<p class="text-danger mb-0">Lỗi khi tải danh sách.</p>';
        }
      }

      function renderAddresses() {
        const container = document.getElementById('addressesList');
        if (!Array.isArray(addresses) || addresses.length === 0) {
          container.innerHTML = '<p class="text-muted mb-0">Chưa có địa chỉ nào. Hãy thêm địa chỉ đầu tiên!</p>';
          return;
        }

        container.innerHTML = addresses.map(addr => {
          const lines = [
            `<h6 class="mb-1">${addr.name || ''} ${addr.isDefault ? '<span class="badge-default">Mặc định</span>' : ''}</h6>`,
            `<p class="mb-1"><i class="bi bi-telephone me-2"></i>${addr.phone ? maskPhone(addr.phone) : ''}</p>`,
            `<p class="mb-1"><i class="bi bi-geo-alt me-2"></i>${addr.address || ''}</p>`,
            `<small class="text-muted">${[addr.ward, addr.district, addr.city].filter(Boolean).join(', ')}</small>`
          ].join('');

          return `
          <div class="address-card">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div>${lines}</div>
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-sm btn-outline-primary btn-action" onclick="editAddress(${addr.id})">
                  <i class="bi bi-pencil me-1"></i>Sửa
                </button>
                <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteAddress(${addr.id})">
                  <i class="bi bi-trash me-1"></i>Xóa
                </button>
                ${addr.isDefault ? '' : `<button class="btn btn-sm btn-outline-success btn-action" onclick="setDefault(${addr.id})">
                  <i class="bi bi-star me-1"></i>Mặc định
                </button>`}
              </div>
            </div>
          </div>`;
        }).join('');
      }

      function openAddModal() {
        editingAddressId = null;
        document.getElementById('addressForm').reset();
        document.getElementById('addressId').value = '';
        document.getElementById('addressModalTitle').textContent = 'Thêm địa chỉ';
        hideAlertAddress(document.getElementById('addressFormAlert'));
      }

      function editAddress(id) {
        const address = addresses.find(a => String(a.id) === String(id));
        if (!address) return;

        editingAddressId = id;
        document.getElementById('addressId').value = address.id;
        document.getElementById('name').value = address.name || '';
        document.getElementById('phone').value = address.phone || '';
        document.getElementById('address').value = address.address || '';
        document.getElementById('city').value = address.city || '';
        document.getElementById('district').value = address.district || '';
        document.getElementById('ward').value = address.ward || '';
        document.getElementById('postalCode').value = address.postalCode || '';
        document.getElementById('isDefault').checked = !!address.isDefault;

        document.getElementById('addressModalTitle').textContent = 'Sửa địa chỉ';
        hideAlertAddress(document.getElementById('addressFormAlert'));

        const modal = new bootstrap.Modal(document.getElementById('addressModal'));
        modal.show();
      }

      async function saveAddress() {
        const formAlert = document.getElementById('addressFormAlert');
        hideAlertAddress(formAlert);

        const v = validateForm();
        if (!v.ok) {
          showAlertAddress(formAlert, 'warning', v.msg);
          return;
        }

        const body = {
          name: document.getElementById('name').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          address: document.getElementById('address').value.trim(),
          city: document.getElementById('city').value.trim(),
          district: document.getElementById('district').value.trim(),
          ward: document.getElementById('ward').value.trim(),
          postalCode: document.getElementById('postalCode').value.trim(),
          isDefault: document.getElementById('isDefault').checked
        };

        try {
          const url = editingAddressId ? `/api/customer/addresses/${editingAddressId}` : '/api/customer/addresses';
          const method = editingAddressId ? 'PUT' : 'POST';

          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(body)
          });

          if (!res.ok) throw new Error(await res.text() || 'Lưu địa chỉ thất bại');

          await loadAddresses();

          const modalEl = document.getElementById('addressModal');
          const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
          modal.hide();

          editingAddressId = null;
          document.getElementById('addressForm').reset();
        } catch (err) {
          console.error('Error saving address:', err);
          showAlertAddress(formAlert, 'danger', err.message || 'Lỗi khi lưu địa chỉ');
        }
      }

      async function deleteAddress(id) {
        if (!confirm('Bạn có chắc muốn xóa địa chỉ này?')) return;
        try {
          const res = await fetch(`/api/customer/addresses/${id}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          if (!res.ok) throw new Error(await res.text() || 'Xóa địa chỉ thất bại');
          await loadAddresses();
        } catch (err) {
          console.error('Error deleting address:', err);
          alert('Lỗi khi xóa địa chỉ');
        }
      }

      async function setDefault(id) {
        try {
          const res = await fetch(`/api/customer/addresses/${id}/set-default`, {
            method: 'POST',
            credentials: 'include'
          });
          if (!res.ok) throw new Error(await res.text() || 'Đặt mặc định thất bại');
          await loadAddresses();
        } catch (err) {
          console.error('Error setting default address:', err);
          alert('Lỗi khi đặt địa chỉ mặc định');
        }
      }

      // ========== Event bindings ==========
      document.getElementById('btnAddAddress').addEventListener('click', openAddModal);
      document.getElementById('btnSaveAddress').addEventListener('click', saveAddress);

      // Load addresses when switching to addresses tab
      document.getElementById('addresses-tab').addEventListener('shown.bs.tab', function () {
        if (addresses.length === 0) {
          loadAddresses();
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        loadUserProfile();
      });
    </script>
  </body>
</html>

