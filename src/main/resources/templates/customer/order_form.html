<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/header_customer :: head"></head>
  <style>
    /* Modern Professional Order Form Styles */
    body {
      min-height: 100vh;
      padding-bottom: 3rem;
    }
    
    .order-container {
      margin-top: 2rem;
      margin-bottom: 2rem;
    }
    
    .order-card {
      border-radius: 16px;
      border: none;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      background: white;
    }
    
    .order-card-header {
      color: #2c3e50;
      padding: 2rem;
      border: none;
    }
    
    .order-card-header h4 {
      margin: 0;
      font-weight: 700;
      font-size: 1.75rem;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 3px solid;
      font-weight: 700;
      font-size: 1.25rem;
    }
    
    .section-header.primary { border-color: #667eea; color: #667eea; }
    .section-header.success { border-color: #10b981; color: #10b981; }
    .section-header.info { border-color: #3b82f6; color: #3b82f6; }
    .section-header.warning { border-color: #f59e0b; color: #f59e0b; }
    
    .section-header i {
      font-size: 1.5rem;
    }
    
    .form-label-modern {
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    
    .form-control-modern {
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control-modern:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      outline: none;
    }
    
    .form-control-modern:read-only {
      background-color: #f9fafb;
      border-color: #e5e7eb;
    }
    
    .form-select-modern {
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      transition: all 0.3s ease;
      background-position: right 1rem center;
    }
    
    .form-select-modern:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      outline: none;
    }
    
    .address-card-modern {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }
    
    .address-card-modern:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    
    .btn-change-address {
      color: #667eea;
      font-weight: 600;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
      border: 2px solid #667eea;
      background: white;
    }
    
    .btn-change-address:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
    }
    
    .form-check-modern {
      padding: 1rem;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    
    .form-check-modern:hover {
      border-color: #667eea;
      background: #f3f4f6;
    }
    
    .form-check-input {
      width: 1.25rem;
      height: 1.25rem;
      margin-top: 0.15rem;
      cursor: pointer;
    }
    
    .form-check-input:checked {
      background-color: #667eea;
      border-color: #667eea;
    }
    
    .summary-card {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .summary-card-header {
      background: #f8f9fa;
      color: #2c3e50;
      padding: 1rem 1.5rem;
      font-weight: 700;
      border-bottom: 3px solid #667eea;
    }
    
    .summary-card-body {
      padding: 1.5rem;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .summary-item:last-child {
      border-bottom: none;
    }
    
    .summary-item.total {
      background: #f3f4f6;
      margin: 0 -1.5rem;
      padding: 1rem 1.5rem;
      font-size: 1.25rem;
      font-weight: 700;
      border-top: 3px solid #667eea;
    }
    
    .btn-primary-modern {
      background: #667eea;
      border: none;
      border-radius: 12px;
      padding: 1rem 2rem;
      font-weight: 700;
      font-size: 1.1rem;
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary-modern:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      background: #5568d3;
      color: white;
    }
    
    .btn-secondary-modern {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem 2rem;
      font-weight: 700;
      font-size: 1.1rem;
      color: #6b7280;
      transition: all 0.3s ease;
    }
    
    .btn-secondary-modern:hover {
      border-color: #667eea;
      color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .btn-danger-modern {
      background: white;
      border: 2px solid #ef4444;
      border-radius: 12px;
      padding: 1rem 2rem;
      font-weight: 700;
      font-size: 1.1rem;
      color: #ef4444;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-danger-modern:hover {
      background: #ef4444;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .image-preview-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      background: white;
    }
    
    .image-preview-header {
      background: #f9fafb;
      border-bottom: 2px solid #e5e7eb;
      padding: 1rem;
    }
    
    .badge-modern {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .text-required {
      color: #ef4444;
      font-weight: 700;
    }
    
    /* Modal improvements */
    .modal-content {
      border-radius: 16px;
      border: none;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
      background: #f8f9fa;
      color: #2c3e50;
      border-radius: 16px 16px 0 0;
      padding: 1.5rem;
      border-bottom: 3px solid #667eea;
    }
    
    .modal-header .btn-close {
      opacity: 1;
    }
    
    .modal-footer {
      background: #f9fafb;
      border-top: 2px solid #e5e7eb;
      padding: 1rem 1.5rem;
      border-radius: 0 0 16px 16px;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
      .order-card-header h4 {
        font-size: 1.5rem;
      }
      
      .section-header {
        font-size: 1.1rem;
      }
      
      .btn-primary-modern,
      .btn-secondary-modern,
      .btn-danger-modern {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
      }
    }
  </style>
  <body>
    <nav th:replace="fragments/header_customer :: navbar"></nav>

    <!-- Profile & Password Modals -->
    <div th:replace="fragments/change_password_modal :: change-password-modal"></div>

    <div class="container order-container">
      <div class="row">
        <div class="col-lg-10 col-xl-10 mx-auto">
          <div class="card order-card">
            <div class="card-header order-card-header">
              <h4><i class="fas fa-shipping-fast me-2"></i> Tạo đơn hàng mới</h4>
            </div>
            <div class="card-body" style="padding: 2rem;">
              <form id="orderForm" enctype="multipart/form-data">
                <!-- Sender Information Section -->
                <div class="row mb-4">
                  <div class="col-12">
                    <h5 class="section-header primary"><i class="fas fa-user"></i> Thông tin người gửi</h5>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label-modern">Tên người gửi <span class="text-required">*</span></label>
                      <input type="text" class="form-control form-control-modern" name="senderName" id="senderName" readonly>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label-modern">Số điện thoại <span class="text-required">*</span></label>
                      <input type="tel" class="form-control form-control-modern" name="senderPhone" id="senderPhone" readonly>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="mb-3">
                      <label class="form-label-modern">Địa chỉ lấy hàng <span class="text-required">*</span></label>
                      <div class="address-card-modern">
                        <div class="d-flex align-items-start justify-content-between">
                          <div class="flex-grow-1">
                            <div id="defaultAddressInfo">
                              <div class="fw-bold mb-1" style="color: #374151; font-size: 1.05rem;" id="defaultAddressName">Đang tải...</div>
                              <div class="fw-bold mb-1" style="color: #6b7280;" id="defaultAddressPhone">Đang tải...</div>
                              <div style="color: #9ca3af;" id="defaultAddressDetail">Đang tải...</div>
                            </div>
                          </div>
                          <div class="ms-3">
                            <button type="button" class="btn btn-change-address" onclick="openAddressModal()">
                              <i class="fas fa-edit me-1"></i> Thay Đổi
                            </button>
                          </div>
                        </div>
                      </div>
                      <input type="hidden" name="pickupAddress" id="pickupAddress" required>
                    </div>
                  </div>
            </div>

                <!-- Recipient Information Section -->
                <div class="row mb-4">
                  <div class="col-12">
                    <h5 class="section-header success"><i class="fas fa-map-marker-alt"></i> Thông tin người nhận</h5>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label-modern">Tên người nhận <span class="text-required">*</span></label>
                      <input type="text" class="form-control form-control-modern" name="recipientName" id="recipientName" required placeholder="Nhập tên người nhận">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label-modern">Số điện thoại <span class="text-required">*</span></label>
                      <input type="tel" class="form-control form-control-modern" name="recipientPhone" id="recipientPhone" required placeholder="VD: 0901234567">
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="mb-3">
                      <label class="form-label-modern">Địa chỉ giao hàng <span class="text-required">*</span></label>
                      <textarea class="form-control form-control-modern" name="recipientAddress" id="recipientAddress" rows="3" placeholder="Nhập địa chỉ giao hàng chi tiết..." required></textarea>
                    </div>
                  </div>
            </div>

                <!-- Service Information Section -->
                <div class="row mb-4">
                  <div class="col-12">
                    <h5 class="section-header info"><i class="fas fa-box"></i> Thông tin dịch vụ</h5>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label-modern">Loại dịch vụ <span class="text-required">*</span></label>
                      <select class="form-select form-select-modern" name="serviceType" id="serviceType" required>
                <option value="">Chọn loại dịch vụ</option>
                        <option value="CHUAN">📦 Chuẩn - Giao trong 2-3 ngày</option>
                        <option value="NHANH">⚡ Nhanh - Giao trong 1 ngày</option>
                        <option value="TIET_KIEM">💰 Tiết kiệm - Giao trong 3-5 ngày</option>
              </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label-modern">Cân nặng (kg) <span class="text-required">*</span></label>
                      <input type="number" class="form-control form-control-modern" name="weight" id="weight" min="0" step="0.1" placeholder="VD: 1.5">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label-modern" id="codAmountLabel">Tiền hàng (₫)</label>
                      <input type="number" class="form-control form-control-modern" name="codAmount" id="codAmount" min="0" value="0" placeholder="VD: 500000">
                      <small class="text-muted" id="codAmountHelp" style="font-size: 0.875rem;">Giá trị hàng hóa cần vận chuyển</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label-modern">Phí vận chuyển (₫)</label>
                      <input type="number" class="form-control form-control-modern" name="shipmentFee" id="shipmentFee" readonly style="background: #f3f4f6; font-weight: 600; color: #3b82f6;">
                      <small class="text-muted" style="font-size: 0.875rem;">Phí sẽ được tính tự động</small>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-check-modern">
                      <div class="d-flex align-items-center">
                        <input class="form-check-input me-2" type="checkbox" id="recipientPays" onchange="toggleRecipientPayment()">
                        <label class="form-check-label fw-bold mb-0" for="recipientPays" style="cursor: pointer; color: #374151;">
                          <i class="fas fa-exchange-alt me-2" style="color: #667eea;"></i> Người nhận thanh toán phí vận chuyển
                        </label>
                      </div>
                      <small class="text-muted d-block mt-2" style="font-size: 0.875rem; margin-left: 2rem;">Khi bật, người nhận sẽ thanh toán thay vì người gửi</small>
                    </div>
                  </div>
                </div>

                <!-- Payment Information Section (chỉ hiện khi không check "Người nhận thanh toán") -->
                <div class="row mb-4" id="paymentInfoSection">
                  <div class="col-12">
                    <h5 class="section-header success"><i class="fas fa-credit-card"></i> Phương thức thanh toán</h5>
                  </div>
                  <div class="col-12">
                    <div class="mb-3">
                      <label class="form-label-modern">Chọn phương thức thanh toán <span class="text-required">*</span></label>
                      <select class="form-select form-select-modern" name="paymentMethod" id="paymentMethod" required>
                        <option value="CASH" selected>💵 Tiền mặt</option>
                        <option value="BANK_TRANSFER">🏦 Chuyển khoản ngân hàng</option>
                        <option value="VNPAY">💳 VNPay</option>
                        <option value="MOMO">📱 MoMo</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Additional Information Section -->
                <div class="row mb-4">
                  <div class="col-12">
                    <h5 class="section-header warning"><i class="fas fa-clipboard"></i> Thông tin bổ sung</h5>
                  </div>
                  <div class="col-12">
                    <div class="mb-3">
                      <label class="form-label-modern">Ghi chú</label>
                      <textarea class="form-control form-control-modern" name="notes" id="notes" rows="3" placeholder="Ghi chú thêm về đơn hàng..."></textarea>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="mb-3">
                      <label class="form-label-modern">Ảnh sản phẩm gửi</label>
                      <input type="file" class="form-control form-control-modern" name="image" id="image" accept="image/*" onchange="previewImage(this)">
                      <small class="text-muted" style="font-size: 0.875rem;">📸 Tải lên ảnh sản phẩm (JPG, PNG, tối đa 5MB)</small>
                      
                      <!-- Image preview container -->
                      <div id="imagePreviewContainer" class="mt-3" style="display: none;">
                        <div class="image-preview-card">
                          <div class="image-preview-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-image me-2"></i>Xem trước ảnh</h6>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeImage()" style="border-radius: 8px;">
                              <i class="fas fa-times me-1"></i> Xóa
                            </button>
                          </div>
                          <div class="card-body text-center p-3">
                            <img id="imagePreview" src="" alt="Preview" class="img-fluid rounded" style="max-height: 300px; max-width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div class="mt-2">
                              <small class="text-muted" id="imageInfo"></small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Summary Section -->
                <div class="row mb-4">
                  <div class="col-12">
                    <div class="summary-card">
                      <div class="summary-card-header">
                        <h6 class="mb-0"><i class="fas fa-receipt me-2"></i>Tóm tắt đơn hàng</h6>
                      </div>
                      <div class="summary-card-body">
                        <div class="summary-item">
                          <span style="color: #6b7280; font-weight: 500;">Loại dịch vụ:</span>
                          <span id="summaryServiceType" style="font-weight: 600; color: #374151;">-</span>
                        </div>
                        <div class="summary-item">
                          <span style="color: #6b7280; font-weight: 500;">Cân nặng:</span>
                          <span id="summaryWeight" style="font-weight: 600; color: #374151;">0 kg</span>
                        </div>
                        <div class="summary-item">
                          <span style="color: #6b7280; font-weight: 500;">Phí vận chuyển:</span>
                          <span id="summaryShipmentFee" style="font-weight: 600; color: #3b82f6;">0 ₫</span>
                        </div>
                        <div class="summary-item">
                          <span id="summaryCodLabel" style="color: #6b7280; font-weight: 500;">Tiền hàng:</span>
                          <span id="summaryCodAmount" style="font-weight: 600; color: #3b82f6;">0 ₫</span>
                        </div>
                        <div class="summary-item">
                          <span style="color: #6b7280; font-weight: 500;">Thuế VAT (10%):</span>
                          <span id="summaryTaxAmount" style="font-weight: 600; color: #f59e0b;">-</span>
                        </div>
                        <div class="summary-item total">
                          <span style="color: #374151;">Tổng cộng:</span>
                          <span id="summaryFinalAmount" style="color: #667eea;">-</span>
                        </div>
                        <div class="summary-item" style="background: #f9fafb; margin: 0 -1.5rem; padding: 1rem 1.5rem; border-top: 2px dashed #e5e7eb;">
                          <span style="color: #374151; font-weight: 600;">👤 Người thanh toán:</span>
                          <span id="summaryPayer" class="badge-modern" style=" color: white;"><strong>Người gửi</strong></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="row">
                  <div class="col-12">
                    <div class="d-flex gap-3 flex-wrap">
                      <button type="submit" class="btn btn-primary-modern">
                        <i class="fas fa-paper-plane me-2"></i> Tạo đơn hàng
                      </button>
                      <button type="button" class="btn btn-secondary-modern" onclick="resetForm()">
                        <i class="fas fa-redo me-2"></i> Làm mới
                      </button>
                      <a href="/web/customer/dashboard" class="btn btn-danger-modern" id="btnCancel">
                        <i class="fas fa-times me-2"></i> Hủy
                      </a>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Address Selection Modal -->
      <div class="modal fade" id="addressModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="fas fa-map-marker-alt me-2"></i>Chọn địa chỉ lấy hàng</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0" style="color: #374151; font-weight: 600;">Danh sách địa chỉ</h6>
                <button type="button" class="btn btn-sm" onclick="openAddAddressModal()" style="background: #10b981; color: white; border: none; border-radius: 8px; padding: 0.5rem 1rem; font-weight: 600;">
                  <i class="fas fa-plus me-1"></i> Thêm địa chỉ
                </button>
              </div>
              <div id="addressList">
                <!-- Addresses will be loaded here -->
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary-modern" data-bs-dismiss="modal">
                <i class="fas fa-times me-2"></i>Đóng
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Address Modal -->
      <div class="modal fade" id="addAddressModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addressModalTitle"><i class="fas fa-plus-circle me-2"></i>Thêm địa chỉ mới</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
              <form id="addAddressForm">
                <input type="hidden" id="addressId" value="">
                <div class="mb-3">
                  <label class="form-label-modern">Họ và tên <span class="text-required">*</span></label>
                  <input type="text" class="form-control form-control-modern" id="name" required placeholder="VD: Nguyễn Văn A">
                </div>
                <div class="mb-3">
                  <label class="form-label-modern">Số điện thoại <span class="text-required">*</span></label>
                  <input type="tel" class="form-control form-control-modern" id="phone" required placeholder="VD: 0901234567">
                  <small class="text-muted" style="font-size: 0.875rem;">Chỉ nhập số, 9–11 ký tự</small>
                </div>
                <div class="mb-3">
                  <label class="form-label-modern">Địa chỉ chi tiết <span class="text-required">*</span></label>
                  <textarea class="form-control form-control-modern" id="address" rows="3" required placeholder="Số nhà, đường, ..."></textarea>
                </div>
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label-modern">Tỉnh/Thành phố</label>
                      <input type="text" class="form-control form-control-modern" id="city" placeholder="Tỉnh/TP">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label-modern">Quận/Huyện</label>
                      <input type="text" class="form-control form-control-modern" id="district" placeholder="Quận/Huyện">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label-modern">Phường/Xã</label>
                      <input type="text" class="form-control form-control-modern" id="ward" placeholder="Phường/Xã">
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label-modern">Mã bưu điện</label>
                  <input type="text" class="form-control form-control-modern" id="postalCode" placeholder="VD: 700000">
                </div>
                <div class="mb-3">
                  <div class="form-check-modern">
                    <div class="d-flex align-items-center">
                      <input class="form-check-input me-2" type="checkbox" id="isDefault">
                      <label class="form-check-label mb-0" for="isDefault" style="cursor: pointer; color: #374151; font-weight: 500;">
                        <i class="fas fa-star me-1" style="color: #f59e0b;"></i> Đặt làm địa chỉ mặc định
                      </label>
                    </div>
                  </div>
                </div>
                <div id="addressFormAlert" class="alert d-none" role="alert"></div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary-modern" data-bs-dismiss="modal">
                <i class="fas fa-times me-2"></i>Hủy
              </button>
              <button type="button" class="btn btn-primary-modern" onclick="saveNewAddress(event); return false;">
                <i class="fas fa-save me-2"></i>Lưu địa chỉ
              </button>
            </div>
          </div>
        </div>
      </div>

          <script>
            const form = document.getElementById("orderForm");
            const serviceTypeSelect = document.getElementById("serviceType");
            const shipmentFeeInput = document.getElementById("shipmentFee");
            const pickupAddressInput = document.getElementById("pickupAddress");
            const codAmountInput = document.getElementById("codAmount");
            const weightInput = document.getElementById("weight");

            let currentUser = null;
            let defaultAddress = null;
            
            // Cloudinary configuration - Sử dụng backend API thay vì upload trực tiếp
            // const CLOUDINARY_CONFIG = {
            //   cloudName: 'YOUR_CLOUD_NAME',
            //   uploadPreset: 'uteexpress',
            //   folder: 'orders'
            // };

            // Load user info and default address on page load
            document.addEventListener('DOMContentLoaded', function() {
              loadUserInfo();
              loadDefaultAddress();
              
              toggleRecipientPayment();
            });

            // Load user information
            async function loadUserInfo() {
              try {
                const response = await fetch('/api/customer/profile', {
                  credentials: 'include'
                });
                if (response.ok) {
                  const user = await response.json();
                  currentUser = user;
                  
                  // Auto-fill sender information
                  document.getElementById('senderName').value = user.fullName || user.username || '';
                  document.getElementById('senderPhone').value = user.phone || '';
                } else {
                  console.warn('Không thể tải thông tin người dùng');
                }
              } catch (error) {
                console.error('Lỗi khi tải thông tin người dùng:', error);
              }
            }

            // Load default address
            async function loadDefaultAddress() {
              try {
                const response = await fetch('/api/customer/addresses', {
                  credentials: 'include'
                });
                if (response.ok) {
                  const addressesData = await response.json();
                  // Update global addresses array
                  addresses = addressesData;
                 
                  
                  // Find default address
                  defaultAddress = addresses.find(addr => addr.isDefault) || addresses[0];
                  
                  if (defaultAddress) {
                    updateDefaultAddressDisplay(defaultAddress);
                    pickupAddressInput.value = defaultAddress.id; // Store address ID instead of address text
                    calculateShippingFee();
                    updateSummary();
                  } else {
                    // No addresses available
                    updateDefaultAddressDisplay(null);
                    pickupAddressInput.value = '';
                  }
                } else {
                  console.warn('Không thể tải danh sách địa chỉ');
                  updateDefaultAddressDisplay(null);
                  pickupAddressInput.value = '';
                }
              } catch (error) {
                console.error('Lỗi khi tải địa chỉ:', error);
                updateDefaultAddressDisplay(null);
                pickupAddressInput.value = '';
              }
            }

            // Update default address display
            function updateDefaultAddressDisplay(address) {
              if (address) {
                document.getElementById('defaultAddressName').textContent = address.name || 'Không có tên';
                document.getElementById('defaultAddressPhone').textContent = address.phone || 'Không có SĐT';
                document.getElementById('defaultAddressDetail').textContent = address.address || 'Không có địa chỉ';
                } else {
                document.getElementById('defaultAddressName').textContent = 'Chưa chọn địa chỉ';
                document.getElementById('defaultAddressPhone').textContent = '';
                document.getElementById('defaultAddressDetail').textContent = 'Vui lòng thêm địa chỉ lấy hàng';
              }
            }

            // Open address selection modal
            function openAddressModal() {
              loadAddressesForModal();
              const modal = new bootstrap.Modal(document.getElementById('addressModal'));
              modal.show();
            }

            // Load addresses for modal
            async function loadAddressesForModal() {
              try {
                const response = await fetch('/api/customer/addresses', {
                  credentials: 'include'
                });
                if (response.ok) {
                  addresses = await response.json(); // Store in global variable
                  const addressList = document.getElementById('addressList');
                  addressList.innerHTML = '';
                  
                  if (addresses.length === 0) {
                    addressList.innerHTML = `
                      <div class="text-center py-4">
                        <i class="fas fa-map-marker-alt text-muted fa-3x mb-3"></i>
                        <p class="text-muted">Chưa có địa chỉ nào. Hãy thêm địa chỉ đầu tiên!</p>
                      </div>
                    `;
                    return;
                  }
                  
                  addresses.forEach(address => {
                    const addressCard = document.createElement('div');
                    addressCard.className = 'mb-3';
                    addressCard.innerHTML = `
                      <div class="card ${address.isDefault ? 'border-warning' : 'border-light'}">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${address.name || 'Không có tên'}</h6>
                            ${address.isDefault ? '<span class="badge bg-warning">Mặc định</span>' : ''}
                          </div>
                          <p class="card-text text-muted small mb-2">${address.phone || 'Không có SĐT'}</p>
                          <p class="card-text">${address.address || 'Không có địa chỉ'}</p>
                          <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-sm" onclick="selectAddress(${address.id})">
                              <i class="fas fa-check"></i> Chọn địa chỉ này
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="editAddressFromModal(${address.id})">
                              <i class="fas fa-edit"></i> Chỉnh sửa
                            </button>
                          </div>
                        </div>
                      </div>
                    `;
                    addressList.appendChild(addressCard);
                  });
                } else {
                  console.warn('Không thể tải danh sách địa chỉ');
                }
              } catch (error) {
                console.error('Lỗi khi tải địa chỉ:', error);
              }
            }

            // Select address from modal
            function selectAddress(addressId) {
              const selectedAddress = addresses.find(a => String(a.id) === String(addressId));
              if (!selectedAddress) {
                alert('Không tìm thấy địa chỉ được chọn!');
                return;
              }

              // Update pickup address input with address ID
              pickupAddressInput.value = selectedAddress.id;
              
              // Update default address display
              updateDefaultAddressDisplay(selectedAddress);
              
              // Close modal
              const modal = bootstrap.Modal.getInstance(document.getElementById('addressModal'));
              modal.hide();
              
              // Update order summary (không cần tính lại phí vận chuyển)
              updateSummary();
            }

            // Global variables for address management
            let addresses = [];
            let editingAddressId = null;

            // Open add address modal (updated from addresses.html)
            function openAddAddressModal() {
              editingAddressId = null;
              document.getElementById('addAddressForm').reset();
              document.getElementById('addressId').value = '';
              document.getElementById('addressModalTitle').textContent = 'Thêm địa chỉ';
              hideAlert(document.getElementById('addressFormAlert'));
              
              const modal = new bootstrap.Modal(document.getElementById('addAddressModal'));
              modal.show();
            }

            // Edit address from modal (updated from addresses.html)
            function editAddressFromModal(id) {
              const address = addresses.find(a => String(a.id) === String(id));
              if (!address) return;

              editingAddressId = id;
              document.getElementById('addressId').value = address.id;
              document.getElementById('name').value = address.name || '';
              document.getElementById('phone').value = address.phone || '';
              document.getElementById('address').value = address.address || '';
              document.getElementById('city').value = address.city || '';
              document.getElementById('district').value = address.district || '';
              document.getElementById('ward').value = address.ward || '';
              document.getElementById('postalCode').value = address.postalCode || '';
              document.getElementById('isDefault').checked = !!address.isDefault;

              document.getElementById('addressModalTitle').textContent = 'Sửa địa chỉ';
              hideAlert(document.getElementById('addressFormAlert'));

              const modal = new bootstrap.Modal(document.getElementById('addAddressModal'));
              modal.show();
            }

            // Validate address form (updated from addresses.html)
            function validateAddressForm() {
              const name = document.getElementById('name').value.trim();
              const phone = document.getElementById('phone').value.trim();
              const address = document.getElementById('address').value.trim();
              const postalCode = document.getElementById('postalCode').value.trim();

              if (!name || !phone || !address) {
                return { ok: false, msg: 'Vui lòng nhập đủ Tên, SĐT và Địa chỉ chi tiết.' };
              }
              if (!/^\d{9,11}$/.test(phone)) {
                return { ok: false, msg: 'Số điện thoại không hợp lệ. Chỉ số, 9–11 ký tự.' };
              }
              if (postalCode && !/^\d{4,8}$/.test(postalCode)) {
                return { ok: false, msg: 'Mã bưu điện không hợp lệ.' };
              }

              return { ok: true };
            }

            // Show alert
            function showAlert(alertEl, type, msg) {
              alertEl.className = `alert alert-${type}`;
              alertEl.textContent = msg;
              alertEl.classList.remove('d-none');
            }

            // Hide alert
            function hideAlert(alertEl) {
              alertEl.classList.add('d-none');
            }

            // Save address (updated from addresses.html)
            async function saveNewAddress(event) {
              // Prevent event bubbling to parent form
              if (event) {
                event.preventDefault();
                event.stopPropagation();
              }
              const formAlert = document.getElementById('addressFormAlert');
              hideAlert(formAlert);

              const v = validateAddressForm();
              if (!v.ok) { 
                showAlert(formAlert, 'warning', v.msg); 
                return; 
              }

              const body = {
                name: document.getElementById('name').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                address: document.getElementById('address').value.trim(),
                city: document.getElementById('city').value.trim(),
                district: document.getElementById('district').value.trim(),
                ward: document.getElementById('ward').value.trim(),
                postalCode: document.getElementById('postalCode').value.trim(),
                isDefault: document.getElementById('isDefault').checked
              };

              try {
                const url = editingAddressId ? `/api/customer/addresses/${editingAddressId}` : '/api/customer/addresses';
                const method = editingAddressId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                  method,
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error(await res.text() || 'Lưu địa chỉ thất bại');

                // Store editing state before reset
                const wasEditing = editingAddressId !== null;
                
                // Close modal
                const modalEl = document.getElementById('addAddressModal');
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modal.hide();

                editingAddressId = null;
                document.getElementById('addAddressForm').reset();

                // Reload addresses in selection modal
                await loadAddressesForModal();
                
                // Reload default address
                await loadDefaultAddress();

                // Show success message
                alert(wasEditing ? 'Cập nhật địa chỉ thành công!' : 'Thêm địa chỉ thành công!');
              } catch (err) {
                console.error('Error saving address:', err);
                showAlert(formAlert, 'danger', err.message || 'Lỗi khi lưu địa chỉ');
              }
            }

            // Calculate shipping fee when service type, weight or COD amount change
            async function calculateShippingFee() {
              const serviceType = serviceTypeSelect.value;
              const weight = parseFloat(document.getElementById('weight').value) || 0;
              const codAmount = parseFloat(document.getElementById('codAmount').value) || 0;

              // Kiểm tra đủ 3 trường: loại dịch vụ, cân nặng, COD
              if (!serviceType || weight <= 0 || codAmount < 0) {
                shipmentFeeInput.value = '';
                updateSummary();
                return;
              }

              // Tính phí vận chuyển dựa trên: loại dịch vụ, cân nặng, tiền COD
              calculateShippingFeeManually(serviceType, weight, codAmount);
            }

            // Calculate shipping fee based on service type, weight, and COD amount
            function calculateShippingFeeManually(serviceType, weight, codAmount) {
              
              let baseFee = 0;
              
              // Base fee by service type
              switch (serviceType) {
                case 'CHUAN':
                  baseFee = 25000;
                  break;
                case 'NHANH':
                  baseFee = 35000;
                  break;
                case 'TIET_KIEM':
                  baseFee = 20000;
                  break;
                default:
                  baseFee = 25000;
              }
              
              // Weight-based fee
              let weightFee = 0;
              if (weight > 0) {
                if (weight <= 1) {
                  weightFee = 0;
                } else if (weight <= 3) {
                  weightFee = 5000;
                } else if (weight <= 5) {
                  weightFee = 10000;
                } else {
                  weightFee = 15000 + (weight - 5) * 2000;
                }
              }

              // COD fee (2% of COD amount, minimum 5000)
              let codFee = 0;
              if (codAmount > 0) {
                codFee = Math.max(5000, Math.round(codAmount * 0.02));
              }

              // Calculate final fee (chỉ dựa trên 3 yếu tố: loại dịch vụ, cân nặng, COD)
              const finalFee = baseFee + weightFee + codFee;
              
              shipmentFeeInput.value = Math.round(finalFee);
              updateSummary();
              }

            // Update summary section
            function updateSummary() {
              const shipmentFee = parseFloat(shipmentFeeInput.value) || 0;
              const codAmount = parseFloat(codAmountInput.value) || 0;
              const weight = parseFloat(weightInput.value) || 0;
              
              // Calculate tax (10% of shipment fee + cod amount)
              const taxRate = 0.1;
              const taxableAmount = shipmentFee + codAmount;
              const taxAmount = taxableAmount * taxRate;
              
              // Calculate final amount
              const finalAmount = shipmentFee + codAmount + taxAmount;
              
              // Update display
              document.getElementById('summaryShipmentFee').textContent = 
                shipmentFee.toLocaleString('vi-VN') + ' ₫';
              document.getElementById('summaryCodAmount').textContent = 
                codAmount.toLocaleString('vi-VN') + ' ₫';
              document.getElementById('summaryWeight').textContent = 
                weight + ' kg';
              document.getElementById('summaryTaxAmount').textContent = 
                taxAmount.toLocaleString('vi-VN') + ' ₫';
              document.getElementById('summaryFinalAmount').textContent = 
                finalAmount.toLocaleString('vi-VN') + ' ₫';
              
              const serviceTypeText = serviceTypeSelect.options[serviceTypeSelect.selectedIndex].text;
              document.getElementById('summaryServiceType').textContent = 
                serviceTypeText || '-';
              
              // Update payer information
              const recipientPays = document.getElementById('recipientPays').checked;
              const summaryPayer = document.getElementById('summaryPayer');
              if (recipientPays) {
                summaryPayer.innerHTML = '<strong class="text-success">Người nhận</strong>';
                summaryPayer.className = 'text-success';
              } else {
                summaryPayer.innerHTML = '<strong class="text-primary">Người gửi</strong>';
                summaryPayer.className = 'text-primary';
              }
            }

            // Debounce function to limit API calls
            function debounce(func, wait) {
              let timeout;
              return function executedFunction(...args) {
                const later = () => {
                  clearTimeout(timeout);
                  func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
              };
            }

            // Image preview functions
            function previewImage(input) {
              const file = input.files[0];
              const previewContainer = document.getElementById('imagePreviewContainer');
              const previewImg = document.getElementById('imagePreview');
              const imageInfo = document.getElementById('imageInfo');

              if (file) {
                // Check file type
                if (!file.type.startsWith('image/')) {
                  alert('Vui lòng chọn file ảnh hợp lệ!');
                  input.value = '';
                  return;
                }

                // Check file size (max 5MB)
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                  alert('Kích thước file quá lớn! Vui lòng chọn file nhỏ hơn 5MB.');
                  input.value = '';
                  return;
                }

                // Create FileReader to read the file
                const reader = new FileReader();
                reader.onload = function(e) {
                  previewImg.src = e.target.result;
                  previewContainer.style.display = 'block';
                  
                  // Show image info
                  const fileSize = (file.size / 1024 / 1024).toFixed(2);
                  imageInfo.textContent = `Tên file: ${file.name} | Kích thước: ${fileSize} MB`;
                };
                reader.readAsDataURL(file);
              } else {
                previewContainer.style.display = 'none';
              }
            }

            // Remove image function
            function removeImage() {
              const input = document.getElementById('image');
              const previewContainer = document.getElementById('imagePreviewContainer');
              
              input.value = '';
              previewContainer.style.display = 'none';
            }

            // Get payment method text
            function getPaymentMethodText(method) {
              const methods = {
                'CASH': 'Tiền mặt',
                'BANK_TRANSFER': 'Chuyển khoản ngân hàng',
                'VNPAY': 'VNPay',
                'MOMO': 'MoMo',
              };
              return methods[method] || method;
            }

            // Toggle recipient payment function
            function toggleRecipientPayment() {
              const recipientPays = document.getElementById('recipientPays').checked;
              const summaryPayer = document.getElementById('summaryPayer');
              const paymentInfoSection = document.getElementById('paymentInfoSection');
              const paymentMethodSelect = document.getElementById('paymentMethod');
              const codAmountLabel = document.getElementById('codAmountLabel');
              const codAmountHelp = document.getElementById('codAmountHelp');
              const summaryCodLabel = document.getElementById('summaryCodLabel');
              
              
              if (recipientPays) {
                // Người nhận thanh toán - ẩn section thanh toán, hiện COD
                summaryPayer.innerHTML = '<strong class="text-success">Người nhận</strong>';
                summaryPayer.className = 'text-success';
                paymentInfoSection.style.display = 'none';
                paymentMethodSelect.required = false;
                paymentMethodSelect.value = '';
                
                // Thay đổi label và help text cho COD
                codAmountLabel.textContent = 'Tiền COD (₫)';
                codAmountHelp.textContent = 'Số tiền thu hộ từ người nhận';
                summaryCodLabel.textContent = 'Tiền COD:';
              } else {
                // Người gửi thanh toán - hiện section thanh toán, hiện Tiền hàng
                 summaryPayer.innerHTML = '<strong class="text-primary">Người gửi</strong>';
                summaryPayer.className = 'text-primary';
                paymentInfoSection.style.display = 'block';
                paymentMethodSelect.required = true;
                
                // Thay đổi label và help text cho Tiền hàng
                codAmountLabel.textContent = 'Tiền hàng (₫)';
                codAmountHelp.textContent = 'Giá trị hàng hóa cần vận chuyển';
                summaryCodLabel.textContent = 'Tiền hàng:';
              }
              
              // Chỉ cập nhật summary, không tính lại phí vận chuyển
              updateSummary();
            }

            // Reset form
            function resetForm() {
              // Check if form is being processed
              const submitBtn = document.querySelector('button[type="submit"]');
              if (submitBtn && submitBtn.disabled) {
                return;
              }
              
              form.reset();
              pickupAddressInput.value = '';
              
              // Reset address display
              updateDefaultAddressDisplay(null);
              
              // Reset image preview
              const previewContainer = document.getElementById('imagePreviewContainer');
              previewContainer.style.display = 'none';
              
              // Reset recipient payment checkbox (mặc định check)
              document.getElementById('recipientPays').checked = true;
              
              // Reset payment info section
              const paymentInfoSection = document.getElementById('paymentInfoSection');
              const paymentMethodSelect = document.getElementById('paymentMethod');
              paymentInfoSection.style.display = 'none';
              paymentMethodSelect.required = false;
              paymentMethodSelect.value = '';
              
              updateSummary();
            }

            // Event listeners - chỉ cần theo dõi 3 yếu tố: loại dịch vụ, cân nặng, COD
            serviceTypeSelect.addEventListener("change", calculateShippingFee);
            document.getElementById('weight').addEventListener("input", debounce(calculateShippingFee, 1000));
            document.getElementById('codAmount').addEventListener("input", debounce(calculateShippingFee, 1000));

            // Test function để kiểm tra đủ 3 trường
            function testCalculateFee() {
              const serviceType = serviceTypeSelect.value;
              const weight = parseFloat(document.getElementById('weight').value) || 0;
              const codAmount = parseFloat(document.getElementById('codAmount').value) || 0;
              
              if (serviceType && weight > 0 && codAmount >= 0) {
                 calculateShippingFee();
              } 
            }

            // Thêm event listeners để test
            serviceTypeSelect.addEventListener("change", testCalculateFee);
            document.getElementById('weight').addEventListener("input", debounce(testCalculateFee, 500));
            document.getElementById('codAmount').addEventListener("input", debounce(testCalculateFee, 500));

            // Form submission
            form.addEventListener("submit", function(e) {
              e.preventDefault();
              onSubmit();
            });

            // Prevent cancel button click during processing
            document.addEventListener("click", function(e) {
              if (e.target.matches('a[id="btnCancel"]')) {
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn && submitBtn.disabled) {
                  e.preventDefault();
                  return false;
                }
              }
            });

            // Main form submission function
            async function onSubmit() {
              
              // Validate all required fields
              if (!validateForm()) {
                return;
              }
              
              // Collect form data
              const formData = collectFormData();
              
              
              // Show loading state and disable all buttons
              const submitBtn = document.querySelector('button[type="submit"]');
              const resetBtn = document.querySelector('button[onclick="resetForm()"]');
              const cancelBtn = document.getElementById('btnCancel');

              // Store original states
              const originalSubmitText = submitBtn.innerHTML;
              const originalResetText = resetBtn ? resetBtn.innerHTML : '';
              const originalCancelText = cancelBtn ? cancelBtn.innerHTML : '';
              
              // Track success for form reset
              let isSuccess = false;
              
              // Update submit button
              submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';
              submitBtn.disabled = true;
              
              // Disable reset button
              if (resetBtn) {
                resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
                resetBtn.disabled = true;
              }
              
              // Disable cancel button
              if (cancelBtn) {
                cancelBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
                cancelBtn.style.pointerEvents = 'none';
                cancelBtn.style.opacity = '0.6';
              }
              
              try {
                // Create order
                const orderResponse = await createOrder(formData);
                
                // Create invoice
                const invoiceResponse = await createInvoice(orderResponse.id, formData);
                
                // Create payment if sender pays
                if (!formData.recipientPays) {
                  const paymentResponse = await createPayment(orderResponse.id, formData);
                  }
                
                // Show success message
                alert(`✅ Tạo đơn hàng thành công!`);
                
                // Mark as success for form reset
                isSuccess = true;
                
              } catch (error) {
                console.error('❌ Error creating order:', error);
                alert('❌ Lỗi khi tạo đơn hàng: ' + error.message);
              } finally {
                // Reset all button states
                submitBtn.innerHTML = originalSubmitText;
                submitBtn.disabled = false;
                
                // Restore reset button
                if (resetBtn) {
                  resetBtn.innerHTML = originalResetText;
                  resetBtn.disabled = false;
                }
                
                // Restore cancel button
                if (cancelBtn) {
                  cancelBtn.innerHTML = originalCancelText;
                  cancelBtn.style.pointerEvents = 'auto';
                  cancelBtn.style.opacity = '1';
                }
                
                // Reset form if success
                if (isSuccess) {
                   resetForm();
                }
              }
            }

            // Validate form function
            function validateForm() {
              let isValid = true;
              
              // Required fields validation
              const requiredFields = [
                { id: 'recipientName', name: 'Tên người nhận' },
                { id: 'recipientPhone', name: 'Số điện thoại người nhận' },
                { id: 'recipientAddress', name: 'Địa chỉ người nhận' },
                { id: 'serviceType', name: 'Loại dịch vụ' },
                { id: 'weight', name: 'Cân nặng' },
                { id: 'codAmount', name: 'Tiền COD/Tiền hàng' }
              ];
              
              // Validate each required field
              requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                   element.classList.add('is-invalid');
                  isValid = false;
                } else {
                  element.classList.remove('is-invalid');
                 }
              });
              
              // Validate pickup address
              if (!pickupAddressInput.value.trim()) {
                alert('Vui lòng chọn địa chỉ lấy hàng! Bạn có thể thêm địa chỉ mới nếu chưa có.');
                isValid = false;
              } 
              
              // Validate payment method if sender pays
              const recipientPays = document.getElementById('recipientPays').checked;
              if (!recipientPays) {
                const paymentMethod = document.getElementById('paymentMethod').value;
                if (!paymentMethod) {
                  document.getElementById('paymentMethod').classList.add('is-invalid');
                  alert('Vui lòng chọn phương thức thanh toán!');
                  isValid = false;
                } else {
                  document.getElementById('paymentMethod').classList.remove('is-invalid');
                  }
              }
              
              if (!isValid) {
                alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
              }
              
              return isValid;
            }

            // Collect form data function
            function collectFormData() {
              const recipientPays = document.getElementById('recipientPays').checked;
              const currentNotes = document.getElementById('notes').value;
              
              // Payment info is handled separately in createInvoice and createPayment
              
              // Debug COD amount
              const codAmountValue = document.getElementById('codAmount').value;
              const codAmountParsed = parseFloat(codAmountValue) || 0;
            
              // Collect all form data
              const data = {
                // Sender info
                senderName: document.getElementById('senderName').value,
                senderPhone: document.getElementById('senderPhone').value,
                pickupAddress: pickupAddressInput.value,
                
                // Recipient info
                recipientName: document.getElementById('recipientName').value,
                recipientPhone: document.getElementById('recipientPhone').value,
                recipientAddress: document.getElementById('recipientAddress').value,
                
                // Service info
                serviceType: document.getElementById('serviceType').value,
                weight: parseFloat(document.getElementById('weight').value) || 0,
                codAmount: parseFloat(document.getElementById('codAmount').value) || 0,
                shipmentFee: parseFloat(document.getElementById('shipmentFee').value) || 0,
                
                // Payment info
                recipientPays: recipientPays,
                paymentMethod: recipientPays ? null : document.getElementById('paymentMethod').value,
                paymentNote: recipientPays ? null : "",
                
                // Additional info
                notes: currentNotes,
                imageFile: document.getElementById('image').files[0] || null
              };
              
              return data;
            }

            // Upload image via dedicated upload API
            async function uploadImageToCloudinary(imageFile) {
              if (!imageFile) return null;
             
              const formData = new FormData();
              formData.append('image', imageFile); // Sử dụng 'image' cho endpoint mới
              
              try {
                const response = await fetch('/api/customer/upload-image', {
                  method: 'POST',
                  credentials: 'include',
                  body: formData
                });
                
                if (!response.ok) {
                  const errorText = await response.text();
                  console.error('❌ Upload response error:', errorText);
                  throw new Error(`Image upload failed: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                
                return result.imageUrl; // Trả về imageUrl từ upload API
              } catch (error) {
                throw new Error(`Không thể upload ảnh: ${error.message}`);
              }
            }

            // Create order API call
            async function createOrder(formData) {
              
              // Upload image if exists
              let imageUrl = null;
              const imageFile = document.getElementById('image').files[0];
              if (imageFile) {
                imageUrl = await uploadImageToCloudinary(imageFile);
              }
              
              // Get actual address from pickupAddress ID
              let actualSenderAddress = '';
              
              if (formData.pickupAddress) {
                const selectedAddress = addresses.find(addr => String(addr.id) === String(formData.pickupAddress));
                if (selectedAddress) {
                  actualSenderAddress = selectedAddress.address;
                  } 
              } 
              
              const orderData = {
                senderName: formData.senderName,
                senderPhone: formData.senderPhone,
                senderAddress: actualSenderAddress, // Use actual address instead of ID
                recipientName: formData.recipientName,
                recipientPhone: formData.recipientPhone,
                recipientAddress: formData.recipientAddress,
                serviceType: formData.serviceType,
                weight: formData.weight,
                codAmount: formData.codAmount,
                shipmentFee: formData.shipmentFee,
                notes: formData.notes,
                imageUrl: imageUrl
              };
              
              // Check if recipientAddress is empty
              if (!orderData.recipientAddress || orderData.recipientAddress.trim() === '') {
                throw new Error('recipientAddress is required but was empty');
              }
              
              
              const response = await fetch('/api/customer/orders', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(orderData)
              });
              
              if (!response.ok) {
                const error = await response.text();
                throw new Error(`Order creation failed: ${error}`);
              }
              
              return await response.json();
            }

            // Create invoice API call
            async function createInvoice(orderId, formData) {
             
              const invoiceData = {
                orderId: orderId,
                totalAmount: formData.shipmentFee + formData.codAmount,
                taxAmount: (formData.shipmentFee + formData.codAmount) * 0.1,
                discountAmount: 0,
                finalAmount: (formData.shipmentFee + formData.codAmount) * 1.1,
                notes: formData.recipientPays ? 
                  'Thanh toán bởi người nhận hàng' : 
                  'Thanh toán bởi người gửi hàng'
              };
              
              
              const response = await fetch('/api/customer/invoices', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(invoiceData)
              });
              
              if (!response.ok) {
                const error = await response.text();
                throw new Error(`Invoice creation failed: ${error}`);
              }
              
              return await response.json();
            }

            // Create payment API call
            async function createPayment(orderId, formData) {
              
              // Calculate total amount including tax (10%)
              const subtotal = formData.shipmentFee + formData.codAmount;
              const taxAmount = subtotal * 0.1;
              const totalAmount = subtotal + taxAmount;
              
              const paymentData = {
                orderId: orderId,
                amount: totalAmount, // Include tax in payment amount
                method: formData.paymentMethod,
                status: 'PENDING',
                notes: formData.paymentNote || ''
              };
              
              
              const response = await fetch('/api/customer/payments', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(paymentData)
              });
              
              if (!response.ok) {
                const error = await response.text();
                throw new Error(`Payment creation failed: ${error}`);
              }
              
              return await response.json();
            }
          </script>

    <footer th:replace="fragments/footer :: footer"></footer>

    <!-- Profile Script -->
    <script th:replace="fragments/header_customer :: profile-script"></script>
    <!-- Change Password Script -->
    <script th:replace="fragments/change_password_modal :: change-password-script"></script>
  </body>
</html>
