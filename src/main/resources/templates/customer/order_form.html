<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="fragments/header :: *"></th:block>

<h3 class="mb-3">üìù T·∫°o ƒë∆°n h√†ng m·ªõi</h3>

<form id="orderForm" enctype="multipart/form-data" class="p-3 border rounded bg-white">
    <div class="mb-2">
        <label>ƒê·ªãa ch·ªâ l·∫•y h√†ng</label>
        <input type="text" class="form-control" name="pickupAddress" required>
    </div>

    <div class="mb-2">
        <label>ƒê·ªãa ch·ªâ giao h√†ng</label>
        <input type="text" class="form-control" name="deliveryAddress" required>
    </div>

    <div class="mb-2">
        <label>Lo·∫°i d·ªãch v·ª•</label>
        <select class="form-control" name="serviceType" id="serviceType" required>
            <option value="">Ch·ªçn lo·∫°i d·ªãch v·ª•</option>
            <option value="CHUAN">Chu·∫©n (1.0x)</option>
            <option value="NHANH">Nhanh (1.5x)</option>
            <option value="TIET_KIEM">Ti·∫øt ki·ªám (0.8x)</option>
        </select>
    </div>

    <div class="mb-2">
        <label>Ph√≠ v·∫≠n chuy·ªÉn</label>
        <input type="number" class="form-control" name="shipmentFee" id="shipmentFee" readonly>
        <small class="text-muted">Ph√≠ s·∫Ω ƒë∆∞·ª£c t√≠nh t·ª± ƒë·ªông d·ª±a tr√™n ƒë·ªãa ch·ªâ v√† lo·∫°i d·ªãch v·ª•</small>
    </div>

    <div class="mb-2">
        <label>·∫¢nh minh ch·ª©ng (t√πy ch·ªçn)</label>
        <input type="file" class="form-control" name="image">
    </div>

    <button class="btn btn-primary">T·∫°o ƒë∆°n h√†ng</button>
</form>

<script>
    const form = document.getElementById('orderForm');
    const serviceTypeSelect = document.getElementById('serviceType');
    const shipmentFeeInput = document.getElementById('shipmentFee');
    
    // Calculate shipping fee when service type or addresses change
    function calculateShippingFee() {
        const pickupAddress = form.querySelector('input[name="pickupAddress"]').value;
        const deliveryAddress = form.querySelector('input[name="deliveryAddress"]').value;
        const serviceType = serviceTypeSelect.value;
        
        if (pickupAddress && deliveryAddress && serviceType) {
            // In a real implementation, you would call an API to calculate the fee
            // For now, we'll use a simple calculation
            const baseFee = 15000;
            const multipliers = {
                'CHUAN': 1.0,
                'NHANH': 1.5,
                'TIET_KIEM': 0.8
            };
            
            const calculatedFee = Math.round(baseFee * multipliers[serviceType]);
            shipmentFeeInput.value = calculatedFee;
        }
    }
    
    serviceTypeSelect.addEventListener('change', calculateShippingFee);
    form.querySelector('input[name="pickupAddress"]').addEventListener('blur', calculateShippingFee);
    form.querySelector('input[name="deliveryAddress"]').addEventListener('blur', calculateShippingFee);
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('jwt');
        const formData = new FormData(form);
        const res = await fetch('/api/customer/orders', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token },
            body: formData
        });
        if (res.ok) {
            alert("T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng!");
            window.location.href = '/web/customer/dashboard';
        } else {
            alert("L·ªói khi t·∫°o ƒë∆°n h√†ng!");
        }
    });
</script>

<th:block th:replace="fragments/footer :: *"></th:block>
</html>
