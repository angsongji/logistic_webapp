<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/header_customer :: head"></head>
  <body class="bg-light">
    <nav th:replace="fragments/header_customer :: navbar"></nav>

    <!-- Profile & Password Modals -->
    <div th:replace="fragments/header_customer :: profile-modal"></div>
    <div th:replace="fragments/change_password_modal :: change-password-modal"></div>

    <div class="container mt-4">
      <div class="row">
        <div class="col-lg-8 mx-auto">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0"><i class="fas fa-plus-circle"></i> T·∫°o ƒë∆°n h√†ng m·ªõi</h4>
            </div>
            <div class="card-body">
              <form id="orderForm" enctype="multipart/form-data">
                <!-- Sender Information Section -->
                <div class="row mb-4">
                  <div class="col-12">
                    <h5 class="text-primary mb-3"><i class="fas fa-user"></i> Th√¥ng tin ng∆∞·ªùi g·ª≠i</h5>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">T√™n ng∆∞·ªùi g·ª≠i <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" name="senderName" id="senderName" readonly>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
                      <input type="tel" class="form-control" name="senderPhone" id="senderPhone" readonly>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="mb-3">
                      <label class="form-label fw-bold">ƒê·ªãa ch·ªâ l·∫•y h√†ng <span class="text-danger">*</span></label>
                      <div class="card border-0 bg-light">
                        <div class="card-body">
                          <div class="d-flex align-items-start">
                            <div class="flex-grow-1">
                              <div id="defaultAddressInfo" class="mb-2">
                                <div class="fw-bold" id="defaultAddressName">ƒêang t·∫£i...</div>
                                <div class="fw-bold" id="defaultAddressPhone">ƒêang t·∫£i...</div>
                                <div id="defaultAddressDetail">ƒêang t·∫£i...</div>
                              </div>
                            </div>
                            <div class="ms-3">
                              <div>
                                <button type="button" class="btn btn-link p-0 text-primary" onclick="openAddressModal()">
                                  Thay ƒê·ªïi
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <input type="hidden" name="pickupAddress" id="pickupAddress" required>
                    </div>
                  </div>
            </div>

                <!-- Recipient Information Section -->
                <div class="row mb-4">
                  <div class="col-12">
                    <h5 class="text-success mb-3"><i class="fas fa-user-check"></i> Th√¥ng tin ng∆∞·ªùi nh·∫≠n</h5>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">T√™n ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" name="recipientName" id="recipientName" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
                      <input type="tel" class="form-control" name="recipientPhone" id="recipientPhone" required>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="mb-3">
                      <label class="form-label fw-bold">ƒê·ªãa ch·ªâ giao h√†ng <span class="text-danger">*</span></label>
                      <textarea class="form-control" name="recipientAddress" id="recipientAddress" rows="3" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng chi ti·∫øt..." required></textarea>
                    </div>
                  </div>
            </div>

                <!-- Service Information Section -->
                <div class="row mb-4">
                  <div class="col-12">
                    <h5 class="text-info mb-3"><i class="fas fa-shipping-fast"></i> Th√¥ng tin d·ªãch v·ª•</h5>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">Lo·∫°i d·ªãch v·ª• <span class="text-danger">*</span></label>
                      <select class="form-select" name="serviceType" id="serviceType" required>
                <option value="">Ch·ªçn lo·∫°i d·ªãch v·ª•</option>
                        <option value="CHUAN">üì¶ Chu·∫©n (1.0x) - Giao trong 2-3 ng√†y</option>
                        <option value="NHANH">‚ö° Nhanh (1.5x) - Giao trong 1 ng√†y</option>
                        <option value="TIET_KIEM">üí∞ Ti·∫øt ki·ªám (0.8x) - Giao trong 3-5 ng√†y</option>
              </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">C√¢n n·∫∑ng (kg)</label>
                      <input type="number" class="form-control" name="weight" id="weight" min="0" step="0.1" placeholder="0.0">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">Ti·ªÅn COD (‚Ç´)</label>
                      <input type="number" class="form-control" name="codAmount" id="codAmount" min="0" placeholder="0">
                      <small class="text-muted">S·ªë ti·ªÅn thu h·ªô t·ª´ ng∆∞·ªùi nh·∫≠n</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">Ph√≠ v·∫≠n chuy·ªÉn (‚Ç´)</label>
                      <input type="number" class="form-control" name="shipmentFee" id="shipmentFee" readonly>
                      <small class="text-muted">Ph√≠ s·∫Ω ƒë∆∞·ª£c t√≠nh t·ª± ƒë·ªông</small>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="recipientPays" onchange="toggleRecipientPayment()">
                        <label class="form-check-label fw-bold" for="recipientPays">
                          <i class="fas fa-user-check text-primary"></i> Ng∆∞·ªùi nh·∫≠n thanh to√°n
                        </label>
                      </div>
                      <small class="text-muted">Khi b·∫≠t, ng∆∞·ªùi nh·∫≠n s·∫Ω thanh to√°n ph√≠ v·∫≠n chuy·ªÉn thay v√¨ ng∆∞·ªùi g·ª≠i</small>
                    </div>
                  </div>
                </div>

                <!-- Additional Information Section -->
                <div class="row mb-4">
                  <div class="col-12">
                    <h5 class="text-warning mb-3"><i class="fas fa-info-circle"></i> Th√¥ng tin b·ªï sung</h5>
                  </div>
                  <div class="col-12">
                    <div class="mb-3">
                      <label class="form-label fw-bold">Ghi ch√∫</label>
                      <textarea class="form-control" name="notes" id="notes" rows="3" placeholder="Ghi ch√∫ th√™m v·ªÅ ƒë∆°n h√†ng..."></textarea>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="mb-3">
                      <label class="form-label fw-bold">·∫¢nh s·∫£n ph·∫©m g·ª≠i</label>
                      <input type="file" class="form-control" name="image" id="image" accept="image/*" onchange="previewImage(this)">
                      <small class="text-muted">T·∫£i l√™n ·∫£nh s·∫£n ph·∫©m g·ª≠i (t√πy ch·ªçn)</small>
                      
                      <!-- Image preview container -->
                      <div id="imagePreviewContainer" class="mt-3" style="display: none;">
                        <div class="card">
                          <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-image"></i> Xem tr∆∞·ªõc ·∫£nh</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeImage()">
                              <i class="fas fa-times"></i> X√≥a ·∫£nh
                            </button>
                          </div>
                          <div class="card-body text-center">
                            <img id="imagePreview" src="" alt="Preview" class="img-fluid rounded" style="max-height: 300px; max-width: 100%;">
                            <div class="mt-2">
                              <small class="text-muted" id="imageInfo"></small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Summary Section -->
                <div class="row mb-4">
                  <div class="col-12">
                    <div class="card bg-light">
                      <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-calculator"></i> T√≥m t·∫Øt ƒë∆°n h√†ng</h6>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-12">
                            <div class="d-flex justify-content-between">
                              <span>Lo·∫°i d·ªãch v·ª•:</span>
                              <span id="summaryServiceType">-</span>
                            </div>
                            <div class="d-flex justify-content-between">
                              <span>C√¢n n·∫∑ng:</span>
                              <span id="summaryWeight">0 kg</span>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-12">
                            <div class="d-flex justify-content-between">
                              <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                              <span id="summaryShipmentFee">0 ‚Ç´</span>
                            </div>
                            <div class="d-flex justify-content-between">
                              <span>Ti·ªÅn COD:</span>
                              <span id="summaryCodAmount">0 ‚Ç´</span>
                            </div>
                            <div class="d-flex justify-content-between">
                              <span>Thu·∫ø (10%):</span>
                              <span id="summaryTaxAmount"> - </span>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between">
                              <span><strong>T·ªïng:</strong></span>
                              <span id="summaryFinalAmount" class="text-primary"><strong>-</strong></span>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between">
                              <span><strong>Ng∆∞·ªùi thanh to√°n:</strong></span>
                              <span id="summaryPayer" class="text-primary"><strong>Ng∆∞·ªùi g·ª≠i</strong></span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="row">
                  <div class="col-12">
                    <div class="d-flex gap-2">
                      <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-check"></i> T·∫°o ƒë∆°n h√†ng
                      </button>
                      <button type="button" class="btn btn-outline-secondary btn-lg" onclick="resetForm()">
                        <i class="fas fa-undo"></i> Reset
                      </button>
                      <a href="/web/customer/dashboard" class="btn btn-outline-danger btn-lg">
                        <i class="fas fa-times"></i> H·ªßy
                      </a>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
            </div>

      <!-- Address Selection Modal -->
      <div class="modal fade" id="addressModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="fas fa-map-marker-alt"></i> Ch·ªçn ƒë·ªãa ch·ªâ l·∫•y h√†ng</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Ch·ªçn ƒë·ªãa ch·ªâ t·ª´ danh s√°ch</h6>
                <button type="button" class="btn btn-success btn-sm" onclick="openAddAddressModal()">
                  <i class="fas fa-plus"></i> Th√™m ƒë·ªãa ch·ªâ
                </button>
              </div>
              <div id="addressList">
                <!-- Addresses will be loaded here -->
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
          </div>
        </div>
            </div>

      <!-- Add Address Modal -->
      <div class="modal fade" id="addAddressModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addressModalTitle"><i class="fas fa-plus"></i> Th√™m ƒë·ªãa ch·ªâ m·ªõi</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="addAddressForm">
                <input type="hidden" id="addressId" value="">
                <div class="mb-3">
                  <label class="form-label fw-bold">T√™n ƒë·ªãa ch·ªâ <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="name" required placeholder="V√≠ d·ª•: Nh√† ri√™ng, C√¥ng ty...">
                </div>
                <div class="mb-3">
                  <label class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i</label>
                  <input type="tel" class="form-control" id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá">
                </div>
                <div class="mb-3">
                  <label class="form-label fw-bold">ƒê·ªãa ch·ªâ chi ti·∫øt <span class="text-danger">*</span></label>
                  <textarea class="form-control" id="address" rows="3" required placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt..."></textarea>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">Th√†nh ph·ªë</label>
                      <input type="text" class="form-control" id="city" placeholder="Th√†nh ph·ªë">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">Qu·∫≠n/Huy·ªán</label>
                      <input type="text" class="form-control" id="district" placeholder="Qu·∫≠n/Huy·ªán">
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">Ph∆∞·ªùng/X√£</label>
                      <input type="text" class="form-control" id="ward" placeholder="Ph∆∞·ªùng/X√£">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">M√£ b∆∞u ƒëi·ªán</label>
                      <input type="text" class="form-control" id="postalCode" placeholder="M√£ b∆∞u ƒëi·ªán">
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="isDefault">
                    <label class="form-check-label" for="isDefault">
                      ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
                    </label>
                  </div>
                </div>
                <div id="addressFormAlert" class="alert d-none" role="alert"></div>
          </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
              <button type="button" class="btn btn-primary" onclick="saveNewAddress()">
                <i class="fas fa-save"></i> L∆∞u ƒë·ªãa ch·ªâ
              </button>
            </div>
          </div>
        </div>
      </div>

          <script>
            const form = document.getElementById("orderForm");
            const serviceTypeSelect = document.getElementById("serviceType");
            const shipmentFeeInput = document.getElementById("shipmentFee");
            const pickupAddressInput = document.getElementById("pickupAddress");
            const codAmountInput = document.getElementById("codAmount");
            const weightInput = document.getElementById("weight");

            let currentUser = null;
            let defaultAddress = null;

            // Load user info and default address on page load
            document.addEventListener('DOMContentLoaded', function() {
              loadUserInfo();
              loadDefaultAddress();
            });

            // Load user information
            async function loadUserInfo() {
              try {
                const response = await fetch('/api/customer/profile', {
                  credentials: 'include'
                });
                if (response.ok) {
                  const user = await response.json();
                  currentUser = user;
                  
                  // Auto-fill sender information
                  document.getElementById('senderName').value = user.fullName || user.username || '';
                  document.getElementById('senderPhone').value = user.phone || '';
                } else {
                  console.warn('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng');
                }
              } catch (error) {
                console.error('L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng:', error);
              }
            }

            // Load default address
            async function loadDefaultAddress() {
              try {
                const response = await fetch('/api/customer/addresses', {
                  credentials: 'include'
                });
                if (response.ok) {
                  const addresses = await response.json();
                  
                  // Find default address
                  defaultAddress = addresses.find(addr => addr.isDefault) || addresses[0];
                  
                  if (defaultAddress) {
                    updateDefaultAddressDisplay(defaultAddress);
                    pickupAddressInput.value = defaultAddress.address;
                    calculateShippingFee();
                    updateSummary();
                  }
                } else {
                  console.warn('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·ªãa ch·ªâ');
                }
              } catch (error) {
                console.error('L·ªói khi t·∫£i ƒë·ªãa ch·ªâ:', error);
              }
            }

            // Update default address display
            function updateDefaultAddressDisplay(address) {
              document.getElementById('defaultAddressName').textContent = address.name || 'Kh√¥ng c√≥ t√™n';
              document.getElementById('defaultAddressPhone').textContent = address.phone || 'Kh√¥ng c√≥ SƒêT';
              document.getElementById('defaultAddressDetail').textContent = address.address || 'Kh√¥ng c√≥ ƒë·ªãa ch·ªâ';
            }

            // Open address selection modal
            function openAddressModal() {
              loadAddressesForModal();
              const modal = new bootstrap.Modal(document.getElementById('addressModal'));
              modal.show();
            }

            // Load addresses for modal
            async function loadAddressesForModal() {
              try {
                const response = await fetch('/api/customer/addresses', {
                  credentials: 'include'
                });
                if (response.ok) {
                  addresses = await response.json(); // Store in global variable
                  const addressList = document.getElementById('addressList');
                  addressList.innerHTML = '';
                  
                  if (addresses.length === 0) {
                    addressList.innerHTML = `
                      <div class="text-center py-4">
                        <i class="fas fa-map-marker-alt text-muted fa-3x mb-3"></i>
                        <p class="text-muted">Ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o. H√£y th√™m ƒë·ªãa ch·ªâ ƒë·∫ßu ti√™n!</p>
                      </div>
                    `;
                    return;
                  }
                  
                  addresses.forEach(address => {
                    const addressCard = document.createElement('div');
                    addressCard.className = 'mb-3';
                    addressCard.innerHTML = `
                      <div class="card ${address.isDefault ? 'border-warning' : 'border-light'}">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${address.name || 'Kh√¥ng c√≥ t√™n'}</h6>
                            ${address.isDefault ? '<span class="badge bg-warning">M·∫∑c ƒë·ªãnh</span>' : ''}
                          </div>
                          <p class="card-text text-muted small mb-2">${address.phone || 'Kh√¥ng c√≥ SƒêT'}</p>
                          <p class="card-text">${address.address || 'Kh√¥ng c√≥ ƒë·ªãa ch·ªâ'}</p>
                          <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-sm" onclick="selectAddress(${address.id})">
                              <i class="fas fa-check"></i> Ch·ªçn ƒë·ªãa ch·ªâ n√†y
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="editAddressFromModal(${address.id})">
                              <i class="fas fa-edit"></i> Ch·ªânh s·ª≠a
                            </button>
                          </div>
                        </div>
                      </div>
                    `;
                    addressList.appendChild(addressCard);
                  });
                } else {
                  console.warn('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·ªãa ch·ªâ');
                }
              } catch (error) {
                console.error('L·ªói khi t·∫£i ƒë·ªãa ch·ªâ:', error);
              }
            }

            // Select address from modal
            function selectAddress(addressId) {
              const selectedAddress = addresses.find(a => String(a.id) === String(addressId));
              if (!selectedAddress) {
                alert('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ ƒë∆∞·ª£c ch·ªçn!');
                return;
              }

              // Update pickup address input
              pickupAddressInput.value = selectedAddress.id;
              
              // Update default address display
              updateDefaultAddressDisplay(selectedAddress);
              
              // Close modal
              const modal = bootstrap.Modal.getInstance(document.getElementById('addressModal'));
              modal.hide();
              
              // Recalculate shipping fee
              calculateShippingFee();
              
              // Update order summary
              updateOrderSummary();
            }

            // Global variables for address management
            let addresses = [];
            let editingAddressId = null;

            // Open add address modal
            function openAddAddressModal() {
              editingAddressId = null;
              document.getElementById('addAddressForm').reset();
              document.getElementById('addressId').value = '';
              document.getElementById('addressModalTitle').textContent = 'Th√™m ƒë·ªãa ch·ªâ';
              hideAlert(document.getElementById('addressFormAlert'));
              
              const modal = new bootstrap.Modal(document.getElementById('addAddressModal'));
              modal.show();
            }

            // Edit address from modal
            function editAddressFromModal(id) {
              const address = addresses.find(a => String(a.id) === String(id));
              if (!address) return;

              editingAddressId = id;
              document.getElementById('addressId').value = address.id;
              document.getElementById('name').value = address.name || '';
              document.getElementById('phone').value = address.phone || '';
              document.getElementById('address').value = address.address || '';
              document.getElementById('city').value = address.city || '';
              document.getElementById('district').value = address.district || '';
              document.getElementById('ward').value = address.ward || '';
              document.getElementById('postalCode').value = address.postalCode || '';
              document.getElementById('isDefault').checked = !!address.isDefault;

              document.getElementById('addressModalTitle').textContent = 'S·ª≠a ƒë·ªãa ch·ªâ';
              hideAlert(document.getElementById('addressFormAlert'));

              const modal = new bootstrap.Modal(document.getElementById('addAddressModal'));
              modal.show();
            }

            // Validate form
            function validateForm() {
              const name = document.getElementById('name').value.trim();
              const address = document.getElementById('address').value.trim();
              
              if (!name) {
                return { ok: false, msg: 'Vui l√≤ng nh·∫≠p t√™n ƒë·ªãa ch·ªâ' };
              }
              if (!address) {
                return { ok: false, msg: 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt' };
              }
              return { ok: true };
            }

            // Show alert
            function showAlert(alertEl, type, msg) {
              alertEl.className = `alert alert-${type}`;
              alertEl.textContent = msg;
              alertEl.classList.remove('d-none');
            }

            // Hide alert
            function hideAlert(alertEl) {
              alertEl.classList.add('d-none');
            }

            // Save address (reused from addresses.html)
            async function saveNewAddress() {
              const formAlert = document.getElementById('addressFormAlert');
              hideAlert(formAlert);

              const v = validateForm();
              if (!v.ok) { 
                showAlert(formAlert, 'warning', v.msg); 
                return; 
              }

              const body = {
                name: document.getElementById('name').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                address: document.getElementById('address').value.trim(),
                city: document.getElementById('city').value.trim(),
                district: document.getElementById('district').value.trim(),
                ward: document.getElementById('ward').value.trim(),
                postalCode: document.getElementById('postalCode').value.trim(),
                isDefault: document.getElementById('isDefault').checked
              };

              try {
                const url = editingAddressId ? `/api/customer/addresses/${editingAddressId}` : '/api/customer/addresses';
                const method = editingAddressId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                  method,
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error(await res.text() || 'L∆∞u ƒë·ªãa ch·ªâ th·∫•t b·∫°i');

                // Close modal
                const modalEl = document.getElementById('addAddressModal');
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modal.hide();

                editingAddressId = null;
                document.getElementById('addAddressForm').reset();

                // Reload addresses in selection modal
                loadAddressesForModal();
                
                // Reload default address
                loadDefaultAddress();

                alert(editingAddressId ? 'C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ th√†nh c√¥ng!' : 'Th√™m ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
              } catch (err) {
                console.error('Error saving address:', err);
                showAlert(formAlert, 'danger', err.message || 'L·ªói khi l∆∞u ƒë·ªãa ch·ªâ');
              }
            }

            // Calculate shipping fee when service type or addresses change
            async function calculateShippingFee() {
              const pickupAddress = pickupAddressInput.value;
              const deliveryAddress = document.getElementById('recipientAddress').value;
              const weight = parseFloat(document.getElementById('weight').value) || 0;
              const codAmount = parseFloat(document.getElementById('codAmount').value) || 0;

              if (!pickupAddress || !deliveryAddress) {
                shipmentFeeInput.value = '';
                updateSummary();
                return;
              }

              try {
                // Show loading state
                shipmentFeeInput.value = 'ƒêang t√≠nh...';
                shipmentFeeInput.disabled = true;

                // Get selected pickup address details
                const selectedPickupAddress = addresses.find(a => String(a.id) === String(pickupAddress));
                if (!selectedPickupAddress) {
                  shipmentFeeInput.value = '';
                  shipmentFeeInput.disabled = false;
                  updateSummary();
                  return;
                }

                // Prepare request data
                const requestData = {
                  pickupAddress: {
                    address: selectedPickupAddress.address,
                    city: selectedPickupAddress.city,
                    district: selectedPickupAddress.district,
                    ward: selectedPickupAddress.ward
                  },
                  deliveryAddress: deliveryAddress,
                  serviceType: serviceTypeSelect.value,
                  weight: weight,
                  codAmount: codAmount
                };

                // Call API to calculate shipping fee
                const response = await fetch('/api/customer/calculate-shipping-fee', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  credentials: 'include',
                  body: JSON.stringify(requestData)
                });

                if (response.ok) {
                  const result = await response.json();
                  shipmentFeeInput.value = result.shippingFee || 0;
                } else {
                  // Fallback to manual calculation if API fails
                  calculateShippingFeeManually(selectedPickupAddress, deliveryAddress, weight, codAmount);
                }
              } catch (error) {
                console.error('Error calculating shipping fee:', error);
                // Fallback to manual calculation
                const selectedPickupAddress = addresses.find(a => String(a.id) === String(pickupAddress));
                if (selectedPickupAddress) {
                  calculateShippingFeeManually(selectedPickupAddress, deliveryAddress, weight, codAmount);
                } else {
                  shipmentFeeInput.value = '';
                }
              } finally {
                shipmentFeeInput.disabled = false;
                updateSummary();
              }
            }

            // Manual calculation fallback
            function calculateShippingFeeManually(pickupAddress, deliveryAddress, weight, codAmount) {
              let baseFee = 0;
              const serviceType = serviceTypeSelect.value;

              // Base fee by service type
              switch (serviceType) {
                case 'CHUAN':
                  baseFee = 25000;
                  break;
                case 'NHANH':
                  baseFee = 35000;
                  break;
                case 'TIET_KIEM':
                  baseFee = 20000;
                  break;
                default:
                  baseFee = 25000;
              }

              // Weight-based fee
              let weightFee = 0;
              if (weight > 0) {
                if (weight <= 1) {
                  weightFee = 0;
                } else if (weight <= 3) {
                  weightFee = 5000;
                } else if (weight <= 5) {
                  weightFee = 10000;
                } else {
                  weightFee = 15000 + (weight - 5) * 2000;
                }
              }

              // COD fee (2% of COD amount, minimum 5000)
              let codFee = 0;
              if (codAmount > 0) {
                codFee = Math.max(5000, Math.round(codAmount * 0.02));
              }

              // Distance-based fee (simplified)
              let distanceFee = 0;
              const pickupCity = pickupAddress.city || '';
              const deliveryCity = deliveryAddress.split(',')[1]?.trim() || '';
              
              if (pickupCity !== deliveryCity) {
                distanceFee = 10000; // Inter-city fee
              }

              // Calculate final fee
              const finalFee = baseFee + weightFee + codFee + distanceFee;
              shipmentFeeInput.value = Math.round(finalFee);
            }

            // Update summary section
            function updateSummary() {
              const shipmentFee = parseFloat(shipmentFeeInput.value) || 0;
              const codAmount = parseFloat(codAmountInput.value) || 0;
              const weight = parseFloat(weightInput.value) || 0;
              
              // Calculate tax (10% of shipment fee + cod amount)
              const taxRate = 0.1;
              const taxableAmount = shipmentFee + codAmount;
              const taxAmount = taxableAmount * taxRate;
              
              // Calculate final amount
              const finalAmount = shipmentFee + codAmount + taxAmount;
              
              // Update display
              document.getElementById('summaryShipmentFee').textContent = 
                shipmentFee.toLocaleString('vi-VN') + ' ‚Ç´';
              document.getElementById('summaryCodAmount').textContent = 
                codAmount.toLocaleString('vi-VN') + ' ‚Ç´';
              document.getElementById('summaryWeight').textContent = 
                weight + ' kg';
              document.getElementById('summaryTaxAmount').textContent = 
                taxAmount.toLocaleString('vi-VN') + ' ‚Ç´';
              document.getElementById('summaryFinalAmount').textContent = 
                finalAmount.toLocaleString('vi-VN') + ' ‚Ç´';
              
              const serviceTypeText = serviceTypeSelect.options[serviceTypeSelect.selectedIndex].text;
              document.getElementById('summaryServiceType').textContent = 
                serviceTypeText || '-';
              
              // Update payer information
              const recipientPays = document.getElementById('recipientPays').checked;
              const summaryPayer = document.getElementById('summaryPayer');
              if (recipientPays) {
                summaryPayer.innerHTML = '<strong class="text-success">Ng∆∞·ªùi nh·∫≠n</strong>';
                summaryPayer.className = 'text-success';
              } else {
                summaryPayer.innerHTML = '<strong class="text-primary">Ng∆∞·ªùi g·ª≠i</strong>';
                summaryPayer.className = 'text-primary';
              }
            }

            // Debounce function to limit API calls
            function debounce(func, wait) {
              let timeout;
              return function executedFunction(...args) {
                const later = () => {
                  clearTimeout(timeout);
                  func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
              };
            }

            // Image preview functions
            function previewImage(input) {
              const file = input.files[0];
              const previewContainer = document.getElementById('imagePreviewContainer');
              const previewImg = document.getElementById('imagePreview');
              const imageInfo = document.getElementById('imageInfo');

              if (file) {
                // Check file type
                if (!file.type.startsWith('image/')) {
                  alert('Vui l√≤ng ch·ªçn file ·∫£nh h·ª£p l·ªá!');
                  input.value = '';
                  return;
                }

                // Check file size (max 5MB)
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                  alert('K√≠ch th∆∞·ªõc file qu√° l·ªõn! Vui l√≤ng ch·ªçn file nh·ªè h∆°n 5MB.');
                  input.value = '';
                  return;
                }

                // Create FileReader to read the file
                const reader = new FileReader();
                reader.onload = function(e) {
                  previewImg.src = e.target.result;
                  previewContainer.style.display = 'block';
                  
                  // Show image info
                  const fileSize = (file.size / 1024 / 1024).toFixed(2);
                  imageInfo.textContent = `T√™n file: ${file.name} | K√≠ch th∆∞·ªõc: ${fileSize} MB`;
                };
                reader.readAsDataURL(file);
              } else {
                previewContainer.style.display = 'none';
              }
            }

            // Remove image function
            function removeImage() {
              const input = document.getElementById('image');
              const previewContainer = document.getElementById('imagePreviewContainer');
              
              input.value = '';
              previewContainer.style.display = 'none';
            }

            // Toggle recipient payment function
            function toggleRecipientPayment() {
              const recipientPays = document.getElementById('recipientPays').checked;
              const summaryPayer = document.getElementById('summaryPayer');
              
              if (recipientPays) {
                summaryPayer.innerHTML = '<strong class="text-success">Ng∆∞·ªùi nh·∫≠n</strong>';
                summaryPayer.className = 'text-success';
              } else {
                summaryPayer.innerHTML = '<strong class="text-primary">Ng∆∞·ªùi g·ª≠i</strong>';
                summaryPayer.className = 'text-primary';
              }
              
              // Ch·ªâ c·∫≠p nh·∫≠t summary, kh√¥ng t√≠nh l·∫°i ph√≠ v·∫≠n chuy·ªÉn
              updateSummary();
            }

            // Reset form
            function resetForm() {
              form.reset();
              pickupAddressInput.value = '';
              customPickupAddressInput.value = '';
              
              // Reset image preview
              const previewContainer = document.getElementById('imagePreviewContainer');
              previewContainer.style.display = 'none';
              
              // Reset recipient payment checkbox
              document.getElementById('recipientPays').checked = false;
              
              updateSummary();
            }

            // Event listeners
            serviceTypeSelect.addEventListener("change", calculateShippingFee);
            pickupAddressInput.addEventListener("change", calculateShippingFee);
            document.getElementById('recipientAddress').addEventListener("input", debounce(calculateShippingFee, 1000));
            document.getElementById('weight').addEventListener("input", debounce(calculateShippingFee, 1000));
            document.getElementById('codAmount').addEventListener("input", debounce(calculateShippingFee, 1000));
            
            // Update summary when values change
            document.getElementById('weight').addEventListener("input", updateSummary);
            document.getElementById('codAmount').addEventListener("input", updateSummary);

            // Form submission
            form.addEventListener("submit", async (e) => {
              e.preventDefault();
              
              // Validate required fields
              const requiredFields = ['recipientName', 'recipientPhone', 'recipientAddress', 'serviceType'];
              let isValid = true;
              
              requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (!field.value.trim()) {
                  field.classList.add('is-invalid');
                  isValid = false;
                } else {
                  field.classList.remove('is-invalid');
                }
              });

              if (!pickupAddressInput.value.trim()) {
                alert('Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ l·∫•y h√†ng!');
                isValid = false;
              }

              if (!isValid) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
                return;
              }

              try {
                const formData = new FormData(form);
                
                // Add payment method info to notes
                const recipientPays = document.getElementById('recipientPays').checked;
                const currentNotes = document.getElementById('notes').value;
                const paymentInfo = recipientPays ? 
                  "\n\n[THANH TO√ÅN: Ng∆∞·ªùi nh·∫≠n thanh to√°n ph√≠ v·∫≠n chuy·ªÉn]" : 
                  "\n\n[THANH TO√ÅN: Ng∆∞·ªùi g·ª≠i thanh to√°n ph√≠ v·∫≠n chuy·ªÉn]";
                
                formData.set('notes', currentNotes + paymentInfo);
                
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                
                // Show loading state
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o...';
                submitBtn.disabled = true;

                const res = await fetch("/api/customer/orders", {
                  method: "POST",
                  credentials: "include",
                  body: formData,
                });

                if (res.ok) {
                  const result = await res.json();
                  alert("T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: " + result.orderCode);
                  window.location.href = "/web/customer/dashboard";
                } else {
                  const error = await res.text();
                  alert("L·ªói khi t·∫°o ƒë∆°n h√†ng: " + error);
                }
              } catch (error) {
                console.error('Error:', error);
                alert("L·ªói khi t·∫°o ƒë∆°n h√†ng!");
              } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
              }
            });
           </script>
    </div>

    <footer th:replace="fragments/footer :: footer"></footer>

    <!-- Profile Script -->
    <script th:replace="fragments/header_customer :: profile-script"></script>
    <!-- Change Password Script -->
    <script th:replace="fragments/change_password_modal :: change-password-script"></script>
  </body>
</html>
