<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/header :: head"></head>
  <body class="bg-light">
    <nav th:replace="fragments/header :: navbar"></nav>

    <!-- Profile & Password Modals -->
    <div th:replace="fragments/header :: profile-modal"></div>
    <div th:replace="fragments/header :: password-modal"></div>

    <div class="container mt-4">
      <!-- Page Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">üì¶ Qu·∫£n l√Ω ƒë∆°n h√†ng</h3>
        <div class="btn-group" role="group">
          <a href="/web/customer/orders/new" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> T·∫°o ƒë∆°n m·ªõi
          </a>
          <a href="/web/customer/tracking" class="btn btn-primary">
            <i class="bi bi-search"></i> Tra c·ª©u
          </a>
        </div>
      </div>

      <!-- Filter tabs -->
      <ul class="nav nav-tabs mb-3" id="orderTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="all-tab"
            data-bs-toggle="tab"
            data-bs-target="#all"
            type="button"
            role="tab"
          >
            T·∫•t c·∫£
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="pending-tab"
            data-bs-toggle="tab"
            data-bs-target="#pending"
            type="button"
            role="tab"
          >
            Ch·ªù x·ª≠ l√Ω
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="shipping-tab"
            data-bs-toggle="tab"
            data-bs-target="#shipping"
            type="button"
            role="tab"
          >
            ƒêang giao
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="completed-tab"
            data-bs-toggle="tab"
            data-bs-target="#completed"
            type="button"
            role="tab"
          >
            Ho√†n th√†nh
          </button>
        </li>
      </ul>

      <!-- Orders Table -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr class="table-light">
                  <th>M√£ ƒë∆°n</th>
                  <th>ƒê·ªãa ch·ªâ giao</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>T·ªïng ti·ªÅn</th>
                  <th>Ng√†y t·∫°o</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody id="orders-table">
                <tr>
                  <td colspan="6" class="text-center">
                    <div class="spinner-border" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <footer th:replace="fragments/footer :: footer"></footer>

    <!-- Profile Script -->
    <script th:replace="fragments/header :: profile-script"></script>

    <script>
      let allOrders = [];

      async function loadOrders() {
        try {
          const res = await fetch("/api/customer/orders", {
            credentials: "include",
          });
          if (!res.ok) {
            throw new Error("Failed to load orders");
          }
          allOrders = await res.json();
          displayOrders(allOrders);
        } catch (error) {
          console.error("Error loading orders:", error);
          document.getElementById("orders-table").innerHTML =
            '<tr><td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
        }
      }

      function displayOrders(orders) {
        const tbody = document.getElementById("orders-table");
        if (orders.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
          return;
        }

        tbody.innerHTML = orders
          .map((o) => {
            const statusBadge = getStatusBadge(o.status);
            return `
                <tr>
                    <td><strong>#${o.id || "N/A"}</strong></td>
                    <td class="text-truncate" style="max-width: 200px;">${
                      o.deliveryAddress || "N/A"
                    }</td>
                    <td>${statusBadge}</td>
                    <td><strong>${(o.totalAmount || 0).toLocaleString(
                      "vi-VN"
                    )} ‚Ç´</strong></td>
                    <td>${new Date(o.createdAt).toLocaleString("vi-VN")}</td>
                    <td>
                        <a href="/web/customer/tracking?code=${
                          o.orderCode || o.id
                        }" class="btn btn-sm btn-outline-primary">
                            Xem chi ti·∫øt
                        </a>
                    </td>
                </tr>
            `;
          })
          .join("");
      }

      function getStatusBadge(status) {
        const statusMap = {
          PENDING: '<span class="badge bg-warning">Ch·ªù x·ª≠ l√Ω</span>',
          CONFIRMED: '<span class="badge bg-info">ƒê√£ x√°c nh·∫≠n</span>',
          PICKING_UP: '<span class="badge bg-primary">ƒêang l·∫•y h√†ng</span>',
          IN_TRANSIT: '<span class="badge bg-primary">ƒêang giao</span>',
          DELIVERING: '<span class="badge bg-primary">ƒêang giao</span>',
          DELIVERED: '<span class="badge bg-success">Ho√†n th√†nh</span>',
          CANCELLED: '<span class="badge bg-danger">ƒê√£ h·ªßy</span>',
          RETURNED: '<span class="badge bg-secondary">Ho√†n tr·∫£</span>',
        };
        return (
          statusMap[status] ||
          `<span class="badge bg-secondary">${status}</span>`
        );
      }

      // Tab filtering
      document.getElementById("all-tab").addEventListener("click", () => {
        displayOrders(allOrders);
      });

      document.getElementById("pending-tab").addEventListener("click", () => {
        const filtered = allOrders.filter(
          (o) => o.status === "PENDING" || o.status === "CONFIRMED"
        );
        displayOrders(filtered);
      });

      document.getElementById("shipping-tab").addEventListener("click", () => {
        const filtered = allOrders.filter(
          (o) =>
            o.status === "PICKING_UP" ||
            o.status === "IN_TRANSIT" ||
            o.status === "DELIVERING"
        );
        displayOrders(filtered);
      });

      document.getElementById("completed-tab").addEventListener("click", () => {
        const filtered = allOrders.filter((o) => o.status === "DELIVERED");
        displayOrders(filtered);
      });

      loadOrders();
    </script>
  </body>
</html>
