<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/header_customer :: head"></head>
  <style>
    /* Professional & Clean Dashboard Styles */
    body {
      background-color: #f5f7fa;
    }
    
    .page-title {
      color: #2c3e50;
      font-weight: 600;
      margin-bottom: 0;
    }
    
    .btn-create {
      background-color: #3498db;
      border: none;
      color: white;
      padding: 0.6rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-create:hover {
      background-color: #2980b9;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    
    .search-container {
      position: relative;
      margin-bottom: 2rem;
    }
    
    .search-input {
      width: 100%;
      padding: 1rem 3.5rem 1rem 1.2rem;
      border: 2px solid #e1e8ed;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background-color: white;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .search-input::placeholder {
      color: #95a5a6;
    }
    
    .search-icon {
      position: absolute;
      right: 1.2rem;
      top: 50%;
      transform: translateY(-50%);
      color: #95a5a6;
      font-size: 1.2rem;
      pointer-events: none;
    }
    
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1.2rem;
      background-color: #95a5a6;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      margin-bottom: 1rem;
    }
    
    .back-button:hover {
      background-color: #7f8c8d;
      color: white;
      transform: translateY(-1px);
    }
    
    .card-clean {
      border: 1px solid #e1e8ed;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      background: white;
      transition: box-shadow 0.2s ease;
    }
    
    .card-clean:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }
    
    .nav-tabs-clean {
      border-bottom: 2px solid #e1e8ed;
      margin-bottom: 0;
    }
    
    .nav-tabs-clean .nav-link {
      border: none;
      color: #7f8c8d;
      font-weight: 500;
      padding: 1rem 1.5rem;
      transition: all 0.2s ease;
    }
    
    .nav-tabs-clean .nav-link:hover {
      color: #3498db;
    }
    
    .nav-tabs-clean .nav-link.active {
      color: #3498db;
      border-bottom: 3px solid #3498db;
      background: transparent;
    }
    
    .table-clean thead th {
      background-color: #f8f9fa;
      color: #2c3e50;
      font-weight: 600;
      border-bottom: 2px solid #e1e8ed;
      padding: 1rem;
      font-size: 0.9rem;
    }
    
    .table-clean tbody tr {
      transition: background-color 0.2s ease;
    }
    
    .table-clean tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    .table-clean tbody td {
      padding: 1rem;
      vertical-align: middle;
    }
    
    .badge-clean {
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.85rem;
    }
    
    .alert-clean {
      border: none;
      border-radius: 10px;
      padding: 1rem 1.2rem;
    }
    
    .loading-clean {
      padding: 3rem;
      text-align: center;
    }
    
    /* Tracking Result Styling */
    .tracking-card {
      border: 1px solid #e1e8ed;
      border-radius: 12px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    .tracking-header {
      background-color: #3498db;
      color: white;
      padding: 1.2rem 1.5rem;
      border-radius: 12px 12px 0 0;
      font-weight: 600;
    }
    
    .info-label {
      color: #7f8c8d;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.3rem;
    }
    
    .info-value {
      color: #2c3e50;
      font-size: 1rem;
      padding: 0.6rem 0.8rem;
      background-color: #f8f9fa;
      border-radius: 6px;
    }
    
    @media (max-width: 768px) {
      .page-title {
        font-size: 1.5rem;
      }
      
      .search-input {
        padding: 0.9rem 3rem 0.9rem 1rem;
      }
    }
  </style>
  <body>
    <nav th:replace="fragments/header_customer :: navbar"></nav>

    <!-- Profile & Password Modals -->
    <div th:replace="fragments/change_password_modal :: change-password-modal"></div>

    <div class="container mt-4 mb-5">
      <!-- Page Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title">
          <i class="bi bi-box-seam me-2"></i>Quản lý Đơn hàng
        </h2>
        <a href="/web/customer/orders/new" class="btn btn-create">
          <i class="bi bi-plus-circle me-1"></i> Tạo đơn mới
        </a>
      </div>

      <!-- Quick Order Tracking -->
      <div class="search-container">
        <input 
          type="text"
          id="quickSearchOrderCode" 
          class="search-input" 
          placeholder="Nhập mã đơn hàng để tra cứu (nhấn Enter để tìm kiếm)..."
        />
        <i class="bi bi-search search-icon"></i>
      </div>
      
      <!-- Back Button (Hidden by default) -->
      <button id="btnBackToOrders" class="back-button d-none">
        <i class="bi bi-arrow-left"></i> Quay lại danh sách
      </button>

      <!-- Loading State -->
      <div id="trackingLoading" class="loading-clean d-none mb-4">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Đang tải...</span>
        </div>
        <p class="mt-3 text-muted">Đang tìm kiếm đơn hàng...</p>
      </div>

      <!-- Tracking Result Section (Initially Hidden) -->
      <div id="trackingResult" class="d-none mb-4">
        <!-- Content will be populated by JavaScript -->
      </div>

      <!-- Alert Box -->
      <div id="trackingAlert" class="alert alert-warning alert-clean d-none mb-4">
        <i class="bi bi-exclamation-triangle me-2"></i><span></span>
      </div>

      <!-- Orders List Section -->
      <div id="ordersListSection">
        <!-- Filter tabs -->
      <ul class="nav nav-tabs nav-tabs-clean mb-0" id="orderTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="all-tab"
            data-bs-toggle="tab"
            data-bs-target="#all"
            type="button"
            role="tab"
          >
            Tất cả
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="pending-tab"
            data-bs-toggle="tab"
            data-bs-target="#pending"
            type="button"
            role="tab"
          >
            Chờ xử lý
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="shipping-tab"
            data-bs-toggle="tab"
            data-bs-target="#shipping"
            type="button"
            role="tab"
          >
            Đang giao
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="completed-tab"
            data-bs-toggle="tab"
            data-bs-target="#completed"
            type="button"
            role="tab"
          >
            Hoàn thành
          </button>
        </li>
      </ul>

        <!-- Orders Table -->
        <div class="card card-clean border-top-0" style="border-radius: 0 0 12px 12px;">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-clean mb-0">
                <thead>
                  <tr>
                    <th>Mã đơn</th>
                    <th>Địa chỉ giao</th>
                    <th>Trạng thái</th>
                    <th>Tổng tiền</th>
                    <th>Ngày tạo</th>
                    <th>Thao tác</th>
                  </tr>
                </thead>
                <tbody id="orders-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- End Orders List Section -->
    </div>

      <!-- Order Detail Modal -->
      <div
        class="modal fade"
        id="orderDetailModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Chi tiết đơn</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div id="orderDetailContent">
                <style>
                  .modal-order {
                    font-family: system-ui, -apple-system, "Segoe UI", Roboto,
                      "Helvetica Neue", Arial;
                  }
                  .order-card {
                    background: #fff;
                    border-radius: 8px;
                    padding: 18px;
                    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
                  }
                  .order-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 12px;
                  }
                  .order-meta {
                    color: #6c757d;
                    font-size: 13px;
                  }
                  .order-section {
                    margin-top: 14px;
                  }
                  .label-sm {
                    font-weight: 600;
                    color: #495057;
                    font-size: 13px;
                  }
                  .value-sm {
                    color: #212529;
                    font-size: 14px;
                  }
                  .amount-box {
                    background: linear-gradient(90deg, #f8f9fa, #fff);
                    padding: 12px;
                    border-radius: 6px;
                  }
                  .amount-lg {
                    font-size: 18px;
                    font-weight: 700;
                  }
                  .dot {
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    display: inline-block;
                    margin-bottom: 6px;
                  }
                  .timeline {
                    display: flex;
                    gap: 18px;
                    align-items: center;
                  }
                  .timeline .step {
                    text-align: center;
                    width: 110px;
                  }
                </style>

                <div class="order-card modal-order">
                  <div class="order-header">
                    <div>
                      <div
                        style="font-size: 18px; font-weight: 700"
                        id="detailCode"
                      >
                        Mã: -
                      </div>
                      <div class="order-meta">
                        <div>Ngày tạo: <span id="detailCreatedAt">-</span></div>
                        <div>
                          Cập nhật lần cuối: <span id="detailUpdatedAt">-</span>
                        </div>
                      </div>
                    </div>
                    <div style="text-align: right">
                      <div id="detailStatus"></div>
                    </div>
                  </div>

                  <div
                    class="order-section row"
                    style="align-items: flex-start"
                  >
                    <div
                      id="detailImageWrap"
                      class="d-none text-center col-md-5"
                    >
                      <div class="label-sm mb-3">
                        Hình ảnh người gửi cung cấp
                      </div>
                      <img
                        id="detailImage"
                        src=""
                        alt="Hình ảnh"
                        class="img-fluid rounded border"
                        style="max-height: 140px"
                      />
                    </div>

                    <div class="col-md-7">
                      <div class="row mb-2">
                        <div class="col-6">
                          <div class="label-sm">Người gửi</div>
                          <div class="value-sm" id="detailSender">-</div>
                          <div class="order-meta" id="detailSenderPhone">-</div>
                          <div
                            class="value-sm text-break"
                            id="detailSenderAddress"
                          >
                            -
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="label-sm">Người nhận</div>
                          <div class="value-sm" id="detailRecipient">-</div>
                          <div class="order-meta" id="detailRecipientPhone">
                            -
                          </div>
                          <div
                            class="value-sm text-break"
                            id="detailRecipientAddress"
                          >
                            -
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-6">
                          <div class="label-sm">Loại dịch vụ</div>
                          <div class="value-sm" id="detailServiceType">-</div>
                        </div>
                        <div class="col-6">
                          <div class="label-sm">Cân nặng (kg)</div>
                          <div class="value-sm" id="detailWeight">-</div>
                        </div>
                      </div>

                      <div class="row order-section">
                        <div class="col-12">
                          <div class="label-sm">Ghi chú</div>
                          <div class="value-sm text-break" id="detailNotes">
                            -
                          </div>
                        </div>
                      </div>
                    </div>

                    <div
                      class="col-md-5 d-flex flex-column justify-content-end"
                    >
                      <div class="amount-box">
                        <div class="label-sm">Phí vận chuyển</div>
                        <div class="amount-lg" id="detailShipmentFee">0 ₫</div>
                        <hr />
                        <div class="label-sm">Tiền COD</div>
                        <div class="value-sm" id="detailCodAmount">0 ₫</div>
                        <hr />
                        <div class="label-sm">Thuế</div>
                        <div class="value-sm" id="detailTaxAmount">0 ₫</div>
                        <hr />
                        <div class="label-sm">Tổng</div>
                        <div class="amount-lg" id="detailFinalAmount">0 ₫</div>
                      </div>

                      <div class="order-section mt-3">
                        <div class="d-flex justify-content-between">
                          <div class="label-sm">Ngày lấy hàng</div>
                          <div class="value-sm" id="detailPickupDate">-</div>
                        </div>
                        <div class="d-flex justify-content-between">
                          <div class="label-sm mt-2">Ngày giao dự kiến</div>
                          <div class="value-sm" id="detailDeliveryDate">-</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Invoice Information Section -->
                  <div id="invoiceSection" class="order-section mt-4 d-none">
                    <div class="card bg-light">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-file-invoice"></i> Thông tin hóa đơn</h6>
                        <span id="detailInvoiceStatus" class="badge fs-6"></span>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6">
                            <div class="mb-2">
                              <div class="label-sm">Số hóa đơn</div>
                              <div class="value-sm" id="detailInvoiceNumber">-</div>
                            </div>
                            <div class="mb-2">
                              <div class="label-sm">Ngày phát hành</div>
                              <div class="value-sm" id="detailIssuedDate">-</div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="mb-2">
                              <div class="label-sm">Tổng tiền hóa đơn</div>
                              <div class="value-sm" id="detailInvoiceTotal">-</div>
                            </div>
                            <div class="mb-2">
                              <div class="label-sm">Ngày đến hạn</div>
                              <div class="value-sm" id="detailDueDate">-</div>
                            </div>
                            <div class="mb-2">
                              <div class="label-sm">Ngày thanh toán</div>
                              <div class="value-sm" id="detailInvoicePaymentDate">-</div>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-12">
                            <div class="mb-2">
                              <div class="label-sm">Ghi chú</div>
                              <div class="value-sm" id="detailInvoiceNotes">-</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Payment Information Section -->
                  <div id="paymentSection" class="order-section mt-3 d-none">
                    <div class="card bg-light">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-credit-card"></i> Thông tin thanh toán</h6>
                        <span id="detailPaymentStatus" class="badge fs-6"></span>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6">
                            <div class="mb-2">
                              <div class="label-sm">Số tiền thanh toán</div>
                              <div class="value-sm" id="detailPaymentAmount">-</div>
                            </div>
                            <div class="mb-2">
                              <div class="label-sm">Phương thức thanh toán</div>
                              <div class="value-sm" id="detailPaymentMethod">-</div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="mb-2">
                              <div class="label-sm">Mã giao dịch</div>
                              <div class="value-sm" id="detailTransactionId">-</div>
                            </div>
                            <div class="mb-2">
                              <div class="label-sm">Ngày thanh toán</div>
                              <div class="value-sm" id="detailPaymentCreatedAt">-</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Đóng
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer th:replace="fragments/footer :: footer"></footer>

    <!-- Profile Script -->
    <script th:replace="fragments/header_customer :: profile-script"></script>

    <script>
      let allOrders = [];

      async function loadOrders(status) {
        try {
          let url = "/api/customer/orders";
          if (status) url += "?status=" + status;
          const res = await fetch(url, {
            credentials: "include",
          });
          if (!res.ok) {
            let text = "";
            try {
              text = await res.text();
            } catch (e) {
              text = "";
            }
            throw new Error(
              "Failed to load orders: " +
                res.status +
                " " +
                res.statusText +
                (text ? " - " + text : "")
            );
          }
          const data = await res.json();
          
          // Handle different response structures
          if (Array.isArray(data)) {
            allOrders = data;
          } else if (data && Array.isArray(data.orders)) {
            allOrders = data.orders;
          } else if (data && Array.isArray(data.invoices)) {
            allOrders = data.invoices;
          } else if (data && Array.isArray(data.data)) {
            allOrders = data.data;
          } else {
            // If it's a single object, wrap it in an array
            allOrders = [data];
          }
          
          displayOrders(allOrders);
        } catch (error) {
          console.error("Error loading orders:", error);
          document.getElementById("orders-table").innerHTML =
            '<tr><td colspan="6" class="text-center text-muted">Không có đơn hàng nào</td></tr>';
        }
      }

      function displayOrders(orders) {
        const tbody = document.getElementById("orders-table");
        if (!orders || orders.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center text-muted">Không có đơn hàng nào</td></tr>';
          return;
        }

        tbody.innerHTML = orders
          .map((o) => {
            // Handle different data structures from accountant API
            const statusBadge = getStatusBadge(o.status || o.orderStatus);
            
            // Try different field names for order code
            const code = o.orderCode || o.invoiceNumber || o.id || "N/A";
            
            // Try different field names for address
            const recipient_address = o.recipientAddress || o.deliveryAddress || "N/A";
            
            // Try different field names for amount
            const finalAmount = o.invoice?.finalAmount || 0;
            
            // Try different field names for date
            const created = o.createdAt 
              ? new Date(o.createdAt).toLocaleString("vi-VN")
              : "-";

            return `
        <tr>
          <td><strong>${code}</strong></td>
          <td class="text-truncate" style="max-width: 200px;">${recipient_address}</td>
          <td>${statusBadge}</td>
          <td><strong>${Number(finalAmount).toLocaleString(
            "vi-VN"
          )} ₫</strong></td>
          <td>${created}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="showOrderDetail('${encodeURIComponent(
              code
            )}')">Xem chi tiết</button>
          </td>
        </tr>
      `;
          })
          .join("");
      }

      function getStatusBadge(status) {
        const statusMap = {
          // English variants
          PENDING: '<span class="badge bg-warning">Chờ xử lý</span>',
          CONFIRMED: '<span class="badge bg-info">Đã xác nhận</span>',
          PICKING_UP: '<span class="badge bg-primary">Đang lấy hàng</span>',
          IN_TRANSIT: '<span class="badge bg-primary">Đang giao</span>',
          DELIVERING: '<span class="badge bg-primary">Đang giao</span>',
          DELIVERED: '<span class="badge bg-success">Hoàn thành</span>',
          CANCELLED: '<span class="badge bg-danger">Đã hủy</span>',
          RETURNED: '<span class="badge bg-secondary">Hoàn trả</span>',
          // Vietnamese enum names used in entity
          CHO_GIAO: '<span class="badge bg-warning">Chờ xử lý</span>',
          DANG_GIAO: '<span class="badge bg-primary">Đang giao</span>',
          HOAN_THANH: '<span class="badge bg-success">Hoàn thành</span>',
          THAT_BAI: '<span class="badge bg-danger">Thất bại</span>',
          HUY: '<span class="badge bg-danger">Đã hủy</span>',
        };
        return (
          statusMap[status] ||
          `<span class="badge bg-secondary">${status}</span>`
        );
      }

      function getInvoiceStatusText(status) {
        const statusMap = {
          DRAFT: 'Nháp',
          PENDING: 'Chờ xử lý',
          ISSUED: 'Đã phát hành',
          PAID: 'Đã thanh toán',
          OVERDUE: 'Quá hạn',
          CANCELLED: 'Đã hủy'
        };
        return statusMap[status] || status;
      }

      function getInvoiceStatusClass(status) {
        const classMap = {
          DRAFT: 'bg-secondary',
          PENDING: 'bg-warning',
          ISSUED: 'bg-info',
          PAID: 'bg-success',
          OVERDUE: 'bg-danger',
          CANCELLED: 'bg-danger'
        };
        return classMap[status] || 'bg-secondary';
      }

      function getPaymentStatusText(status) {
        const statusMap = {
          PENDING: 'Chờ thanh toán',
          PROCESSING: 'Đang xử lý',
          COMPLETED: 'Hoàn thành',
          FAILED: 'Thất bại',
          CANCELLED: 'Đã hủy',
          REFUNDED: 'Đã hoàn tiền'
        };
        return statusMap[status] || status;
      }

      function getPaymentStatusClass(status) {
        const classMap = {
          PENDING: 'bg-warning',
          PROCESSING: 'bg-info',
          COMPLETED: 'bg-success',
          FAILED: 'bg-danger',
          CANCELLED: 'bg-danger',
          REFUNDED: 'bg-secondary'
        };
        return classMap[status] || 'bg-secondary';
      }

      // Tab filtering
      document.getElementById("all-tab").addEventListener("click", () => {
        loadOrders();
      });

      // Chờ xử lý -> CHO_GIAO
      document.getElementById("pending-tab").addEventListener("click", () => {
        loadOrders("CHO_GIAO");
      });

      // Đang giao -> DANG_GIAO
      document.getElementById("shipping-tab").addEventListener("click", () => {
        loadOrders("DANG_GIAO");
      });

      // Hoàn thành -> HOAN_THANH
      document.getElementById("completed-tab").addEventListener("click", () => {
        loadOrders("HOAN_THANH");
      });

      // initial load: all orders
      loadOrders();

      // Fetch and show order detail in modal
      async function showOrderDetail(code) {
        try {
          const res = await fetch(
            `/api/customer/orders/${decodeURIComponent(code)}`,
            { credentials: "include" }
          );
          if (!res.ok) throw new Error("Không tìm thấy đơn hàng");
          const o = await res.json();

          // helper setters that check element exists
          const setText = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
            else console.warn("Missing element for id", id, "value", value);
          };
          const setHtml = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = value;
            else console.warn("Missing element for id", id, "html", value);
          };

          setText("detailCode", o.orderCode || "");
          setHtml("detailStatus", getStatusBadge(o.status || ""));

          setText("detailSender", o.senderName || "");
          setText("detailSenderPhone", o.senderPhone || "");
          setText("detailSenderAddress", o.senderAddress || "");

          setText("detailRecipient", o.recipientName || "");
          setText("detailRecipientPhone", o.recipientPhone || "");
          setText("detailRecipientAddress", o.recipientAddress || "");

          setText(
            "detailShipmentFee",
            (o.shipmentFee || 0).toLocaleString("vi-VN") + " ₫"
          );
          setText(
            "detailCodAmount",
            (o.codAmount || 0).toLocaleString("vi-VN") + " ₫"
          );
          setText(
            "detailTaxAmount",
            (o.invoice?.taxAmount || 0).toLocaleString("vi-VN") + " ₫"
          );
          setText(
            "detailFinalAmount",
            (o.invoice?.finalAmount || 0).toLocaleString("vi-VN") + " ₫"
          );
          setText("detailServiceType", o.serviceType || "");
          setText("detailWeight", o.weight || 0);
          setText("detailNotes", o.notes || "Không có");
          setText(
            "detailCreatedAt",
            o.createdAt ? new Date(o.createdAt).toLocaleString("vi-VN") : "-"
          );
          // Calculate the most recent updatedAt from order, invoice, and payment
          const orderUpdatedAt = o.updatedAt ? new Date(o.updatedAt) : null;
          const invoiceUpdatedAt = o.invoice?.updatedAt ? new Date(o.invoice.updatedAt) : null;
          const paymentUpdatedAt = o.payment?.updatedAt ? new Date(o.payment.updatedAt) : null;
          
          let mostRecentUpdatedAt = orderUpdatedAt;
          if (invoiceUpdatedAt && (!mostRecentUpdatedAt || invoiceUpdatedAt > mostRecentUpdatedAt)) {
            mostRecentUpdatedAt = invoiceUpdatedAt;
          }
          if (paymentUpdatedAt && (!mostRecentUpdatedAt || paymentUpdatedAt > mostRecentUpdatedAt)) {
            mostRecentUpdatedAt = paymentUpdatedAt;
          }
          
          setText(
            "detailUpdatedAt",
            mostRecentUpdatedAt ? mostRecentUpdatedAt.toLocaleString("vi-VN") : "-"
          );

          // Invoice information
          const invoiceSection = document.getElementById("invoiceSection");
          if (o.invoice) {
            setText("detailInvoiceNumber", o.invoice.invoiceNumber || "-");
            setText("detailIssuedDate", o.invoice.issuedDate ? new Date(o.invoice.issuedDate).toLocaleString("vi-VN") : "-");
            setText("detailInvoiceTotal", o.invoice.finalAmount ? o.invoice.finalAmount.toLocaleString("vi-VN") + " ₫" : "-");
            setText("detailDueDate", o.invoice.dueDate ? new Date(o.invoice.dueDate).toLocaleString("vi-VN") : "-");
            setText("detailInvoicePaymentDate", o.invoice.paymentDate ? new Date(o.invoice.paymentDate).toLocaleString("vi-VN") : "-");
            setText("detailInvoiceNotes", o.invoice.notes || "Không có");
            
            // Set invoice status badge with color
            const invoiceStatusElement = document.getElementById("detailInvoiceStatus");
            const invoiceStatus = o.invoice.status || "N/A";
            invoiceStatusElement.textContent = getInvoiceStatusText(invoiceStatus);
            invoiceStatusElement.className = "badge fs-6 " + getInvoiceStatusClass(invoiceStatus);
            
            invoiceSection.classList.remove("d-none");
          } else {
            invoiceSection.classList.add("d-none");
          }

          // Payment information
          const paymentSection = document.getElementById("paymentSection");
          if (o.payment) {
            setText("detailPaymentAmount", o.payment.amount ? o.payment.amount.toLocaleString("vi-VN") + " ₫" : "-");
            setText("detailPaymentMethod", o.payment.method || "-");
            setText("detailTransactionId", o.payment.transactionId || "-");
            setText("detailPaymentCreatedAt", o.payment.createdAt ? new Date(o.payment.createdAt).toLocaleString("vi-VN") : "-");
            
            // Set payment status badge with color
            const paymentStatusElement = document.getElementById("detailPaymentStatus");
            const paymentStatus = o.payment.status || "N/A";
            paymentStatusElement.textContent = getPaymentStatusText(paymentStatus);
            paymentStatusElement.className = "badge fs-6 " + getPaymentStatusClass(paymentStatus);
            
            paymentSection.classList.remove("d-none");
          } else {
            paymentSection.classList.add("d-none");
          }

          // image handling: show image if imageUrl exists, otherwise show fallback text
          const imgWrap = document.getElementById("detailImageWrap");
          const imgEl = document.getElementById("detailImage");
          // remove any previous fallback text
          const prevFallback = document.getElementById("detailImageFallback");
          if (prevFallback) prevFallback.remove();
          if (o.imageUrl) {
            if (imgEl) imgEl.src = o.imageUrl;
            if (imgWrap) imgWrap.classList.remove("d-none");
            if (imgEl) imgEl.style.display = "inline-block";
          } else {
            // hide image and show fallback text
            if (imgEl) imgEl.style.display = "none";
            if (imgWrap) {
              imgWrap.classList.remove("d-none");
              const span = document.createElement("div");
              span.id = "detailImageFallback";
              span.className = "text-muted mt-2 small";
              span.textContent = "Người gửi không cung cấp ảnh";
              imgWrap.appendChild(span);
            }
          }

          const modal = new bootstrap.Modal(
            document.getElementById("orderDetailModal")
          );
          modal.show();
        } catch (e) {
          console.error("Error loading order detail", e);
          alert(e.message || "Lỗi khi tải chi tiết đơn");
        }
      }

      // ========== QUICK TRACKING FEATURE ==========
      
      // Handle Enter key for quick search
      document.getElementById('quickSearchOrderCode').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
          await performTracking();
        }
      });

      // Function to perform tracking
      async function performTracking() {
        const code = document.getElementById('quickSearchOrderCode').value?.trim();
        const alertBox = document.getElementById('trackingAlert');
        const resultBox = document.getElementById('trackingResult');
        const loading = document.getElementById('trackingLoading');
        const ordersSection = document.getElementById('ordersListSection');
        const backBtn = document.getElementById('btnBackToOrders');
        
        if (!code) {
          alertBox.querySelector('span').textContent = 'Vui lòng nhập mã đơn hàng';
          alertBox.classList.remove('d-none');
          resultBox.classList.add('d-none');
          loading.classList.add('d-none');
          return;
        }

        try {
          // Show loading state
          alertBox.classList.add('d-none');
          resultBox.classList.add('d-none');
          ordersSection.classList.add('d-none');
          loading.classList.remove('d-none');
          backBtn.classList.add('d-none');
          
          const res = await fetch(`/api/customer/orders/${code}/tracking`, {
            credentials: 'include'
          });
          
          if (!res.ok) throw new Error('Không tìm thấy đơn hàng');
          
          const o = await res.json();
          
          // Build tracking result HTML
          resultBox.innerHTML = buildTrackingResultHTML(o, code);
          
          // Hide orders list, show tracking result
          ordersSection.classList.add('d-none');
          resultBox.classList.remove('d-none');
          loading.classList.add('d-none');
          backBtn.classList.remove('d-none');
          
        } catch (e) {
          alertBox.querySelector('span').textContent = e.message || 'Lỗi khi truy vấn trạng thái đơn hàng';
          alertBox.classList.remove('d-none');
          resultBox.classList.add('d-none');
          loading.classList.add('d-none');
          ordersSection.classList.remove('d-none');
          backBtn.classList.add('d-none');
        }
      }

      // Handle back to orders list button
      document.getElementById('btnBackToOrders').addEventListener('click', () => {
        document.getElementById('trackingResult').classList.add('d-none');
        document.getElementById('trackingAlert').classList.add('d-none');
        document.getElementById('ordersListSection').classList.remove('d-none');
        document.getElementById('btnBackToOrders').classList.add('d-none');
        document.getElementById('quickSearchOrderCode').value = '';
      });

      // Helper functions for status display
      function getStatusText(status) {
        const statusMap = {
          'CHO_GIAO': 'Chờ giao',
          'DANG_GIAO': 'Đang giao',
          'HOAN_THANH': 'Hoàn thành',
          'THAT_BAI': 'Thất bại',
          'HUY': 'Hủy'
        };
        return statusMap[status] || status;
      }
      
      function getStatusClass(status) {
        const classMap = {
          'CHO_GIAO': 'bg-warning',
          'DANG_GIAO': 'bg-info',
          'HOAN_THANH': 'bg-success',
          'THAT_BAI': 'bg-danger',
          'HUY': 'bg-secondary'
        };
        return classMap[status] || 'bg-secondary';
      }
      
      function getServiceTypeText(serviceType) {
        const serviceMap = {
          'CHUAN': 'Chuẩn',
          'NHANH': 'Nhanh',
          'TIET_KIEM': 'Tiết kiệm'
        };
        return serviceMap[serviceType] || serviceType;
      }
      
      function getInvoiceStatusText(status) {
        const statusMap = {
          'DRAFT': 'Nháp',
          'PENDING': 'Chờ xử lý',
          'ISSUED': 'Đã phát hành',
          'PAID': 'Đã thanh toán',
          'OVERDUE': 'Quá hạn',
          'CANCELLED': 'Đã hủy'
        };
        return statusMap[status] || status;
      }

      function getInvoiceStatusClass(status) {
        const classMap = {
          'DRAFT': 'bg-secondary',
          'PENDING': 'bg-warning',
          'ISSUED': 'bg-info',
          'PAID': 'bg-success',
          'OVERDUE': 'bg-danger',
          'CANCELLED': 'bg-danger'
        };
        return classMap[status] || 'bg-secondary';
      }

      function getPaymentStatusText(status) {
        const statusMap = {
          'PENDING': 'Chờ thanh toán',
          'PROCESSING': 'Đang xử lý',
          'COMPLETED': 'Hoàn thành',
          'FAILED': 'Thất bại',
          'CANCELLED': 'Đã hủy',
          'REFUNDED': 'Đã hoàn tiền'
        };
        return statusMap[status] || status;
      }

      function getPaymentStatusClass(status) {
        const classMap = {
          'PENDING': 'bg-warning',
          'PROCESSING': 'bg-info',
          'COMPLETED': 'bg-success',
          'FAILED': 'bg-danger',
          'CANCELLED': 'bg-danger',
          'REFUNDED': 'bg-secondary'
        };
        return classMap[status] || 'bg-secondary';
      }

      // Function to build tracking result HTML
      function buildTrackingResultHTML(o, code) {
        const mostRecentUpdatedAt = getMostRecentUpdatedAt(o);
        
        return `
          <div class="tracking-card">
            <div class="tracking-header">
              <i class="bi bi-box-seam me-2"></i>Thông tin chi tiết đơn hàng
            </div>
            <div class="card-body p-4">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="mb-3">
                    <div class="info-label">Mã đơn hàng</div>
                    <div class="info-value fw-bold text-primary">${o.orderCode || code}</div>
                  </div>
                  <div class="mb-3">
                    <div class="info-label">Trạng thái</div>
                    <div>
                      <span class="badge badge-clean ${getStatusClass(o.status)}">${getStatusText(o.status)}</span>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="info-label">Ngày tạo</div>
                    <div class="info-value">
                      ${o.createdAt ? new Date(o.createdAt).toLocaleString('vi-VN') : '-'}
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="info-label">Cập nhật lần cuối</div>
                    <div class="info-value">
                      ${mostRecentUpdatedAt ? mostRecentUpdatedAt.toLocaleString('vi-VN') : '-'}
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <div class="info-label">Loại dịch vụ</div>
                    <div class="info-value">${getServiceTypeText(o.serviceType) || 'N/A'}</div>
                  </div>
                  <div class="mb-3">
                    <div class="info-label">Cân nặng</div>
                    <div class="info-value">${o.weight ? o.weight + ' kg' : '0 kg'}</div>
                  </div>
                  <div class="mb-3">
                    <div class="info-label">Phí vận chuyển</div>
                    <div class="info-value text-primary fw-bold">
                      ${o.shipmentFee ? o.shipmentFee.toLocaleString('vi-VN') + ' ₫' : '0 ₫'}
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="info-label">Tổng tiền</div>
                    <div class="info-value text-success fw-bold">
                      ${o.invoice?.finalAmount ? o.invoice.finalAmount.toLocaleString('vi-VN') + ' ₫' : '0 ₫'}
                    </div>
                  </div>
                </div>
              </div>
              
              <hr class="my-4">
              
              <div class="row g-3">
                <div class="col-md-6">
                  <h6 class="mb-3" style="color: #2c3e50; font-weight: 600;">
                    <i class="bi bi-person-circle me-2"></i>Thông tin người gửi
                  </h6>
                  <div class="mb-2">
                    <div class="info-label">Họ tên</div>
                    <div class="info-value">${o.senderName || '-'}</div>
                  </div>
                  <div class="mb-2">
                    <div class="info-label">Số điện thoại</div>
                    <div class="info-value">${o.senderPhone || '-'}</div>
                  </div>
                  <div class="mb-2">
                    <div class="info-label">Địa chỉ</div>
                    <div class="info-value">${o.senderAddress || '-'}</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <h6 class="mb-3" style="color: #2c3e50; font-weight: 600;">
                    <i class="bi bi-geo-alt me-2"></i>Thông tin người nhận
                  </h6>
                  <div class="mb-2">
                    <div class="info-label">Họ tên</div>
                    <div class="info-value">${o.recipientName || '-'}</div>
                  </div>
                  <div class="mb-2">
                    <div class="info-label">Số điện thoại</div>
                    <div class="info-value">${o.recipientPhone || '-'}</div>
                  </div>
                  <div class="mb-2">
                    <div class="info-label">Địa chỉ</div>
                    <div class="info-value">${o.recipientAddress || '-'}</div>
                  </div>
                </div>
              </div>
              
              ${o.notes ? `
              <div class="row mt-2">
                <div class="col-12">
                  <div class="mb-3">
                    <label class="form-label fw-bold">Ghi chú:</label>
                    <div class="form-control-plaintext bg-light p-2 rounded">${o.notes}</div>
                  </div>
                </div>
              </div>
              ` : ''}
              
              ${o.notes ? `
              <hr class="my-4">
              <div class="mb-3">
                <div class="info-label">Ghi chú</div>
                <div class="info-value">${o.notes}</div>
              </div>
              ` : ''}
              
              ${o.invoice ? `
              <hr class="my-4">
              <h6 class="mb-3" style="color: #2c3e50; font-weight: 600;">
                <i class="bi bi-receipt me-2"></i>Thông tin hóa đơn
                <span class="badge badge-clean ${getInvoiceStatusClass(o.invoice.status)} ms-2">${getInvoiceStatusText(o.invoice.status)}</span>
              </h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="mb-2">
                    <div class="info-label">Số hóa đơn</div>
                    <div class="info-value">${o.invoice.invoiceNumber || '-'}</div>
                  </div>
                  <div class="mb-2">
                    <div class="info-label">Ngày phát hành</div>
                    <div class="info-value">${o.invoice.issuedDate ? new Date(o.invoice.issuedDate).toLocaleString('vi-VN') : '-'}</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-2">
                    <div class="info-label">Tổng tiền hóa đơn</div>
                    <div class="info-value fw-bold text-success">${o.invoice.finalAmount ? o.invoice.finalAmount.toLocaleString('vi-VN') + ' ₫' : '-'}</div>
                  </div>
                  <div class="mb-2">
                    <div class="info-label">Ngày thanh toán</div>
                    <div class="info-value">${o.invoice.paymentDate ? new Date(o.invoice.paymentDate).toLocaleString('vi-VN') : '-'}</div>
                  </div>
                </div>
              </div>
              ` : ''}
              
              ${o.payment ? `
              <hr class="my-4">
              <h6 class="mb-3" style="color: #2c3e50; font-weight: 600;">
                <i class="bi bi-credit-card me-2"></i>Thông tin thanh toán
                <span class="badge badge-clean ${getPaymentStatusClass(o.payment.status)} ms-2">${getPaymentStatusText(o.payment.status)}</span>
              </h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="mb-2">
                    <div class="info-label">Số tiền thanh toán</div>
                    <div class="info-value fw-bold text-success">${o.payment.amount ? o.payment.amount.toLocaleString('vi-VN') + ' ₫' : '-'}</div>
                  </div>
                  <div class="mb-2">
                    <div class="info-label">Phương thức</div>
                    <div class="info-value">${o.payment.method || '-'}</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-2">
                    <div class="info-label">Mã giao dịch</div>
                    <div class="info-value">${o.payment.transactionId || '-'}</div>
                  </div>
                  <div class="mb-2">
                    <div class="info-label">Ngày thanh toán</div>
                    <div class="info-value">${o.payment.createdAt ? new Date(o.payment.createdAt).toLocaleString('vi-VN') : '-'}</div>
                  </div>
                </div>
              </div>
              ` : ''}
              
              ${o.imageUrl ? `
              <hr class="my-4">
              <h6 class="mb-3" style="color: #2c3e50; font-weight: 600;">
                <i class="bi bi-image me-2"></i>Hình ảnh đơn hàng
              </h6>
              <div class="text-center p-3" style="background-color: #f8f9fa; border-radius: 10px;">
                <img src="${o.imageUrl}" alt="Hình ảnh đơn hàng" class="img-fluid rounded shadow-sm" style="max-height: 400px; border-radius: 8px !important;" />
              </div>
              ` : ''}
            </div>
          </div>
        `;
      }

      // Helper function to get most recent updated date
      function getMostRecentUpdatedAt(o) {
        const orderUpdatedAt = o.updatedAt ? new Date(o.updatedAt) : null;
        const invoiceUpdatedAt = o.invoice?.updatedAt ? new Date(o.invoice.updatedAt) : null;
        const paymentUpdatedAt = o.payment?.updatedAt ? new Date(o.payment.updatedAt) : null;
        
        let mostRecentUpdatedAt = orderUpdatedAt;
        if (invoiceUpdatedAt && (!mostRecentUpdatedAt || invoiceUpdatedAt > mostRecentUpdatedAt)) {
          mostRecentUpdatedAt = invoiceUpdatedAt;
        }
        if (paymentUpdatedAt && (!mostRecentUpdatedAt || paymentUpdatedAt > mostRecentUpdatedAt)) {
          mostRecentUpdatedAt = paymentUpdatedAt;
        }
        
        return mostRecentUpdatedAt;
      }

      // Ensure dropdown works on dashboard
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(() => {
          const trigger = document.getElementById("userAvatar");
          if (trigger && !trigger.dataset.dropdownInitialized) {
            try {
              if (window.bootstrap && bootstrap.Dropdown) {
                if (!bootstrap.Dropdown.getInstance(trigger)) {
                  new bootstrap.Dropdown(trigger, {
                    autoClose: "outside",
                  });
                }
              }
              trigger.dataset.dropdownInitialized = "true";
            } catch (e) {
              console.warn("Failed to initialize dropdown:", e);
            }
          }
        }, 500);
      });
    </script>
  </body>
</html>
