<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/header_customer :: head"></head>
  <body class="bg-light">
    <nav th:replace="fragments/header_customer :: navbar"></nav>

    <!-- Profile & Password Modals -->
    <!-- <div th:replace="fragments/header_customer :: profile-modal"></div> -->
    <div
      th:replace="fragments/change_password_modal :: change-password-modal"
    ></div>

    <div class="container mt-4">
      <!-- Page header_customer -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">üì¶ ƒê∆°n h√†ng c·ªßa t√¥i</h3>
        <div class="btn-group d-flex gap-1" role="group">
          <a href="/web/customer/orders/new" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> T·∫°o ƒë∆°n m·ªõi
          </a>
          <a href="/web/customer/tracking" class="btn btn-primary">
            <i class="bi bi-search"></i> Tra c·ª©u
          </a>
        </div>
      </div>

      <!-- Filter tabs -->
      <ul class="nav nav-tabs mb-3" id="orderTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="all-tab"
            data-bs-toggle="tab"
            data-bs-target="#all"
            type="button"
            role="tab"
          >
            T·∫•t c·∫£
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="pending-tab"
            data-bs-toggle="tab"
            data-bs-target="#pending"
            type="button"
            role="tab"
          >
            Ch·ªù x·ª≠ l√Ω
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="shipping-tab"
            data-bs-toggle="tab"
            data-bs-target="#shipping"
            type="button"
            role="tab"
          >
            ƒêang giao
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="completed-tab"
            data-bs-toggle="tab"
            data-bs-target="#completed"
            type="button"
            role="tab"
          >
            Ho√†n th√†nh
          </button>
        </li>
      </ul>

      <!-- Orders Table -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr class="table-light">
                  <th>M√£ ƒë∆°n</th>
                  <th>ƒê·ªãa ch·ªâ giao</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>T·ªïng ti·ªÅn</th>
                  <th>Ng√†y t·∫°o</th>
                  <th>&nbsp;</th>
                </tr>
              </thead>
              <tbody id="orders-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Order Detail Modal -->
      <div
        class="modal fade"
        id="orderDetailModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Chi ti·∫øt ƒë∆°n</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div id="orderDetailContent">
                <style>
                  .modal-order {
                    font-family: system-ui, -apple-system, "Segoe UI", Roboto,
                      "Helvetica Neue", Arial;
                  }
                  .order-card {
                    background: #fff;
                    border-radius: 8px;
                    padding: 18px;
                    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
                  }
                  .order-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 12px;
                  }
                  .order-meta {
                    color: #6c757d;
                    font-size: 13px;
                  }
                  .order-section {
                    margin-top: 14px;
                  }
                  .label-sm {
                    font-weight: 600;
                    color: #495057;
                    font-size: 13px;
                  }
                  .value-sm {
                    color: #212529;
                    font-size: 14px;
                  }
                  .amount-box {
                    background: linear-gradient(90deg, #f8f9fa, #fff);
                    padding: 12px;
                    border-radius: 6px;
                  }
                  .amount-lg {
                    font-size: 18px;
                    font-weight: 700;
                  }
                  .dot {
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    display: inline-block;
                    margin-bottom: 6px;
                  }
                  .timeline {
                    display: flex;
                    gap: 18px;
                    align-items: center;
                  }
                  .timeline .step {
                    text-align: center;
                    width: 110px;
                  }
                </style>

                <div class="order-card modal-order">
                  <div class="order-header">
                    <div>
                      <div
                        style="font-size: 18px; font-weight: 700"
                        id="detailCode"
                      >
                        M√£: -
                      </div>
                      <div class="order-meta">
                        <div>Ng√†y t·∫°o: <span id="detailCreatedAt">-</span></div>
                        <div>
                          C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="detailUpdatedAt">-</span>
                        </div>
                      </div>
                    </div>
                    <div style="text-align: right">
                      <div id="detailStatus"></div>
                    </div>
                  </div>

                  <div
                    class="order-section row"
                    style="align-items: flex-start"
                  >
                    <div
                      id="detailImageWrap"
                      class="d-none text-center col-md-5"
                    >
                      <div class="label-sm mb-3">
                        H√¨nh ·∫£nh ng∆∞·ªùi g·ª≠i cung c·∫•p
                      </div>
                      <img
                        id="detailImage"
                        src=""
                        alt="H√¨nh ·∫£nh"
                        class="img-fluid rounded border"
                        style="max-height: 140px"
                      />
                    </div>

                    <div class="col-md-7">
                      <div class="row mb-2">
                        <div class="col-6">
                          <div class="label-sm">Ng∆∞·ªùi g·ª≠i</div>
                          <div class="value-sm" id="detailSender">-</div>
                          <div class="order-meta" id="detailSenderPhone">-</div>
                          <div
                            class="value-sm text-break"
                            id="detailSenderAddress"
                          >
                            -
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="label-sm">Ng∆∞·ªùi nh·∫≠n</div>
                          <div class="value-sm" id="detailRecipient">-</div>
                          <div class="order-meta" id="detailRecipientPhone">
                            -
                          </div>
                          <div
                            class="value-sm text-break"
                            id="detailRecipientAddress"
                          >
                            -
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-6">
                          <div class="label-sm">Lo·∫°i d·ªãch v·ª•</div>
                          <div class="value-sm" id="detailServiceType">-</div>
                        </div>
                        <div class="col-6">
                          <div class="label-sm">C√¢n n·∫∑ng (kg)</div>
                          <div class="value-sm" id="detailWeight">-</div>
                        </div>
                      </div>

                      <div class="row order-section">
                        <div class="col-12">
                          <div class="label-sm">Ghi ch√∫</div>
                          <div class="value-sm text-break" id="detailNotes">
                            -
                          </div>
                        </div>
                      </div>
                    </div>

                    <div
                      class="col-md-5 d-flex flex-column justify-content-end"
                    >
                      <div class="amount-box">
                        <div class="label-sm">Ph√≠ v·∫≠n chuy·ªÉn</div>
                        <div class="amount-lg" id="detailShipmentFee">0 ‚Ç´</div>
                        <hr />
                        <div class="label-sm">Ti·ªÅn COD</div>
                        <div class="value-sm" id="detailCodAmount">0 ‚Ç´</div>
                        <hr />
                        <div class="label-sm">Thu·∫ø</div>
                        <div class="value-sm" id="detailTaxAmount">0 ‚Ç´</div>
                        <hr />
                        <div class="label-sm">T·ªïng</div>
                        <div class="amount-lg" id="detailFinalAmount">0 ‚Ç´</div>
                      </div>

                      <div class="order-section mt-3">
                        <div class="d-flex justify-content-between">
                          <div class="label-sm">Ng√†y l·∫•y h√†ng</div>
                          <div class="value-sm" id="detailPickupDate">-</div>
                        </div>
                        <div class="d-flex justify-content-between">
                          <div class="label-sm mt-2">Ng√†y giao d·ª± ki·∫øn</div>
                          <div class="value-sm" id="detailDeliveryDate">-</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Invoice Information Section -->
                  <div id="invoiceSection" class="order-section mt-4 d-none">
                    <div class="card bg-light">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-file-invoice"></i> Th√¥ng tin h√≥a ƒë∆°n</h6>
                        <span id="detailInvoiceStatus" class="badge fs-6"></span>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6">
                            <div class="mb-2">
                              <div class="label-sm">S·ªë h√≥a ƒë∆°n</div>
                              <div class="value-sm" id="detailInvoiceNumber">-</div>
                            </div>
                            <div class="mb-2">
                              <div class="label-sm">Ng√†y ph√°t h√†nh</div>
                              <div class="value-sm" id="detailIssuedDate">-</div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="mb-2">
                              <div class="label-sm">T·ªïng ti·ªÅn h√≥a ƒë∆°n</div>
                              <div class="value-sm" id="detailInvoiceTotal">-</div>
                            </div>
                            <div class="mb-2">
                              <div class="label-sm">Ng√†y ƒë·∫øn h·∫°n</div>
                              <div class="value-sm" id="detailDueDate">-</div>
                            </div>
                            <div class="mb-2">
                              <div class="label-sm">Ng√†y thanh to√°n</div>
                              <div class="value-sm" id="detailInvoicePaymentDate">-</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Payment Information Section -->
                  <div id="paymentSection" class="order-section mt-3 d-none">
                    <div class="card bg-light">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-credit-card"></i> Th√¥ng tin thanh to√°n</h6>
                        <span id="detailPaymentStatus" class="badge fs-6"></span>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6">
                            <div class="mb-2">
                              <div class="label-sm">S·ªë ti·ªÅn thanh to√°n</div>
                              <div class="value-sm" id="detailPaymentAmount">-</div>
                            </div>
                            <div class="mb-2">
                              <div class="label-sm">Ph∆∞∆°ng th·ª©c thanh to√°n</div>
                              <div class="value-sm" id="detailPaymentMethod">-</div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="mb-2">
                              <div class="label-sm">M√£ giao d·ªãch</div>
                              <div class="value-sm" id="detailTransactionId">-</div>
                            </div>
                            <div class="mb-2">
                              <div class="label-sm">Ng√†y thanh to√°n</div>
                              <div class="value-sm" id="detailPaymentCreatedAt">-</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ƒê√≥ng
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer th:replace="fragments/footer :: footer"></footer>

    <!-- Profile Script -->
    <script th:replace="fragments/header_customer :: profile-script"></script>

    <script>
      let allOrders = [];

      async function loadOrders(status) {
        try {
          let url = "/api/customer/orders";
          if (status) url += "?status=" + status;
          const res = await fetch(url, {
            credentials: "include",
          });
          if (!res.ok) {
            let text = "";
            try {
              text = await res.text();
            } catch (e) {
              text = "";
            }
            throw new Error(
              "Failed to load orders: " +
                res.status +
                " " +
                res.statusText +
                (text ? " - " + text : "")
            );
          }
          const data = await res.json();
          console.log("API Response:", data);
          
          // Handle different response structures
          if (Array.isArray(data)) {
            allOrders = data;
          } else if (data && Array.isArray(data.orders)) {
            allOrders = data.orders;
          } else if (data && Array.isArray(data.invoices)) {
            allOrders = data.invoices;
          } else if (data && Array.isArray(data.data)) {
            allOrders = data.data;
          } else {
            // If it's a single object, wrap it in an array
            allOrders = [data];
          }
          
          displayOrders(allOrders);
        } catch (error) {
          console.error("Error loading orders:", error);
          document.getElementById("orders-table").innerHTML =
            '<tr><td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
        }
      }

      function displayOrders(orders) {
        const tbody = document.getElementById("orders-table");
        if (!orders || orders.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
          return;
        }

        tbody.innerHTML = orders
          .map((o) => {
            console.log("Order data:", o);
            
            // Handle different data structures from accountant API
            const statusBadge = getStatusBadge(o.status || o.orderStatus);
            
            // Try different field names for order code
            const code = o.orderCode || o.invoiceNumber || o.id || "N/A";
            
            // Try different field names for address
            const recipient_address = o.recipientAddress || o.deliveryAddress || "N/A";
            
            // Try different field names for amount
            const total_amount = o.totalAmount || o.finalAmount || o.amount || 0;
            
            // Try different field names for date
            const created = o.createdAt || o.issueDate || o.createdDate
              ? new Date(o.createdAt || o.issueDate || o.createdDate).toLocaleString("vi-VN")
              : "-";

            return `
        <tr>
          <td><strong>${code}</strong></td>
          <td class="text-truncate" style="max-width: 200px;">${recipient_address}</td>
          <td>${statusBadge}</td>
          <td><strong>${Number(total_amount).toLocaleString(
            "vi-VN"
          )} ‚Ç´</strong></td>
          <td>${created}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="showOrderDetail('${encodeURIComponent(
              code
            )}')">Xem chi ti·∫øt</button>
          </td>
        </tr>
      `;
          })
          .join("");
      }

      function getStatusBadge(status) {
        const statusMap = {
          // English variants
          PENDING: '<span class="badge bg-warning">Ch·ªù x·ª≠ l√Ω</span>',
          CONFIRMED: '<span class="badge bg-info">ƒê√£ x√°c nh·∫≠n</span>',
          PICKING_UP: '<span class="badge bg-primary">ƒêang l·∫•y h√†ng</span>',
          IN_TRANSIT: '<span class="badge bg-primary">ƒêang giao</span>',
          DELIVERING: '<span class="badge bg-primary">ƒêang giao</span>',
          DELIVERED: '<span class="badge bg-success">Ho√†n th√†nh</span>',
          CANCELLED: '<span class="badge bg-danger">ƒê√£ h·ªßy</span>',
          RETURNED: '<span class="badge bg-secondary">Ho√†n tr·∫£</span>',
          // Vietnamese enum names used in entity
          CHO_GIAO: '<span class="badge bg-warning">Ch·ªù x·ª≠ l√Ω</span>',
          DANG_GIAO: '<span class="badge bg-primary">ƒêang giao</span>',
          HOAN_THANH: '<span class="badge bg-success">Ho√†n th√†nh</span>',
          THAT_BAI: '<span class="badge bg-danger">Th·∫•t b·∫°i</span>',
          HUY: '<span class="badge bg-danger">ƒê√£ h·ªßy</span>',
        };
        return (
          statusMap[status] ||
          `<span class="badge bg-secondary">${status}</span>`
        );
      }

      function getInvoiceStatusText(status) {
        const statusMap = {
          DRAFT: 'Nh√°p',
          PENDING: 'Ch·ªù x·ª≠ l√Ω',
          ISSUED: 'ƒê√£ ph√°t h√†nh',
          PAID: 'ƒê√£ thanh to√°n',
          OVERDUE: 'Qu√° h·∫°n',
          CANCELLED: 'ƒê√£ h·ªßy'
        };
        return statusMap[status] || status;
      }

      function getInvoiceStatusClass(status) {
        const classMap = {
          DRAFT: 'bg-secondary',
          PENDING: 'bg-warning',
          ISSUED: 'bg-info',
          PAID: 'bg-success',
          OVERDUE: 'bg-danger',
          CANCELLED: 'bg-danger'
        };
        return classMap[status] || 'bg-secondary';
      }

      function getPaymentStatusText(status) {
        const statusMap = {
          PENDING: 'Ch·ªù thanh to√°n',
          PROCESSING: 'ƒêang x·ª≠ l√Ω',
          COMPLETED: 'Ho√†n th√†nh',
          FAILED: 'Th·∫•t b·∫°i',
          CANCELLED: 'ƒê√£ h·ªßy',
          REFUNDED: 'ƒê√£ ho√†n ti·ªÅn'
        };
        return statusMap[status] || status;
      }

      function getPaymentStatusClass(status) {
        const classMap = {
          PENDING: 'bg-warning',
          PROCESSING: 'bg-info',
          COMPLETED: 'bg-success',
          FAILED: 'bg-danger',
          CANCELLED: 'bg-danger',
          REFUNDED: 'bg-secondary'
        };
        return classMap[status] || 'bg-secondary';
      }

      // Tab filtering
      document.getElementById("all-tab").addEventListener("click", () => {
        loadOrders();
      });

      // Ch·ªù x·ª≠ l√Ω -> CHO_GIAO
      document.getElementById("pending-tab").addEventListener("click", () => {
        loadOrders("CHO_GIAO");
      });

      // ƒêang giao -> DANG_GIAO
      document.getElementById("shipping-tab").addEventListener("click", () => {
        loadOrders("DANG_GIAO");
      });

      // Ho√†n th√†nh -> HOAN_THANH
      document.getElementById("completed-tab").addEventListener("click", () => {
        loadOrders("HOAN_THANH");
      });

      // initial load: all orders
      loadOrders();

      // Fetch and show order detail in modal
      async function showOrderDetail(code) {
        try {
          const res = await fetch(
            `/api/customer/orders/${decodeURIComponent(code)}`,
            { credentials: "include" }
          );
          if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng");
          const o = await res.json();

          // helper setters that check element exists
          const setText = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
            else console.warn("Missing element for id", id, "value", value);
          };
          const setHtml = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = value;
            else console.warn("Missing element for id", id, "html", value);
          };

          setText("detailCode", o.orderCode || "");
          setHtml("detailStatus", getStatusBadge(o.status || ""));

          setText("detailSender", o.senderName || "");
          setText("detailSenderPhone", o.senderPhone || "");
          setText("detailSenderAddress", o.senderAddress || "");

          setText("detailRecipient", o.recipientName || "");
          setText("detailRecipientPhone", o.recipientPhone || "");
          setText("detailRecipientAddress", o.recipientAddress || "");

          setText(
            "detailShipmentFee",
            (o.shipmentFee || 0).toLocaleString("vi-VN") + " ‚Ç´"
          );
          setText(
            "detailCodAmount",
            (o.codAmount || 0).toLocaleString("vi-VN") + " ‚Ç´"
          );
          setText(
            "detailTaxAmount",
            (o.invoice?.taxAmount || 0).toLocaleString("vi-VN") + " ‚Ç´"
          );
          setText(
            "detailFinalAmount",
            (o.invoice?.finalAmount || 0).toLocaleString("vi-VN") + " ‚Ç´"
          );
          setText("detailServiceType", o.serviceType || "");
          setText("detailWeight", o.weight || 0);
          setText("detailNotes", o.notes || "Kh√¥ng c√≥");
          setText(
            "detailCreatedAt",
            o.createdAt ? new Date(o.createdAt).toLocaleString("vi-VN") : "-"
          );
          // Calculate the most recent updatedAt from order, invoice, and payment
          const orderUpdatedAt = o.updatedAt ? new Date(o.updatedAt) : null;
          const invoiceUpdatedAt = o.invoice?.updatedAt ? new Date(o.invoice.updatedAt) : null;
          const paymentUpdatedAt = o.payment?.updatedAt ? new Date(o.payment.updatedAt) : null;
          
          let mostRecentUpdatedAt = orderUpdatedAt;
          if (invoiceUpdatedAt && (!mostRecentUpdatedAt || invoiceUpdatedAt > mostRecentUpdatedAt)) {
            mostRecentUpdatedAt = invoiceUpdatedAt;
          }
          if (paymentUpdatedAt && (!mostRecentUpdatedAt || paymentUpdatedAt > mostRecentUpdatedAt)) {
            mostRecentUpdatedAt = paymentUpdatedAt;
          }
          
          setText(
            "detailUpdatedAt",
            mostRecentUpdatedAt ? mostRecentUpdatedAt.toLocaleString("vi-VN") : "-"
          );

          // Invoice information
          const invoiceSection = document.getElementById("invoiceSection");
          if (o.invoice) {
            setText("detailInvoiceNumber", o.invoice.invoiceNumber || "-");
            setText("detailIssuedDate", o.invoice.issuedDate ? new Date(o.invoice.issuedDate).toLocaleString("vi-VN") : "-");
            setText("detailInvoiceTotal", o.invoice.finalAmount ? o.invoice.finalAmount.toLocaleString("vi-VN") + " ‚Ç´" : "-");
            setText("detailDueDate", o.invoice.dueDate ? new Date(o.invoice.dueDate).toLocaleString("vi-VN") : "-");
            setText("detailInvoicePaymentDate", o.invoice.paymentDate ? new Date(o.invoice.paymentDate).toLocaleString("vi-VN") : "-");
            
            // Set invoice status badge with color
            const invoiceStatusElement = document.getElementById("detailInvoiceStatus");
            const invoiceStatus = o.invoice.status || "N/A";
            invoiceStatusElement.textContent = getInvoiceStatusText(invoiceStatus);
            invoiceStatusElement.className = "badge fs-6 " + getInvoiceStatusClass(invoiceStatus);
            
            invoiceSection.classList.remove("d-none");
          } else {
            invoiceSection.classList.add("d-none");
          }

          // Payment information
          const paymentSection = document.getElementById("paymentSection");
          if (o.payment) {
            setText("detailPaymentAmount", o.payment.amount ? o.payment.amount.toLocaleString("vi-VN") + " ‚Ç´" : "-");
            setText("detailPaymentMethod", o.payment.method || "-");
            setText("detailTransactionId", o.payment.transactionId || "-");
            setText("detailPaymentCreatedAt", o.payment.createdAt ? new Date(o.payment.createdAt).toLocaleString("vi-VN") : "-");
            
            // Set payment status badge with color
            const paymentStatusElement = document.getElementById("detailPaymentStatus");
            const paymentStatus = o.payment.status || "N/A";
            paymentStatusElement.textContent = getPaymentStatusText(paymentStatus);
            paymentStatusElement.className = "badge fs-6 " + getPaymentStatusClass(paymentStatus);
            
            paymentSection.classList.remove("d-none");
          } else {
            paymentSection.classList.add("d-none");
          }

          // image handling: show image if imageUrl exists, otherwise show fallback text
          const imgWrap = document.getElementById("detailImageWrap");
          const imgEl = document.getElementById("detailImage");
          // remove any previous fallback text
          const prevFallback = document.getElementById("detailImageFallback");
          if (prevFallback) prevFallback.remove();
          if (o.imageUrl) {
            if (imgEl) imgEl.src = o.imageUrl;
            if (imgWrap) imgWrap.classList.remove("d-none");
            if (imgEl) imgEl.style.display = "inline-block";
          } else {
            // hide image and show fallback text
            if (imgEl) imgEl.style.display = "none";
            if (imgWrap) {
              imgWrap.classList.remove("d-none");
              const span = document.createElement("div");
              span.id = "detailImageFallback";
              span.className = "text-muted mt-2 small";
              span.textContent = "Ng∆∞·ªùi g·ª≠i kh√¥ng cung c·∫•p ·∫£nh";
              imgWrap.appendChild(span);
            }
          }

          const modal = new bootstrap.Modal(
            document.getElementById("orderDetailModal")
          );
          modal.show();
        } catch (e) {
          console.error("Error loading order detail", e);
          alert(e.message || "L·ªói khi t·∫£i chi ti·∫øt ƒë∆°n");
        }
      }

      // Ensure dropdown works on dashboard
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(() => {
          const trigger = document.getElementById("userAvatar");
          if (trigger && !trigger.dataset.dropdownInitialized) {
            try {
              if (window.bootstrap && bootstrap.Dropdown) {
                if (!bootstrap.Dropdown.getInstance(trigger)) {
                  new bootstrap.Dropdown(trigger, {
                    autoClose: "outside",
                  });
                }
              }
              trigger.dataset.dropdownInitialized = "true";
            } catch (e) {
              console.warn("Failed to initialize dropdown:", e);
            }
          }
        }, 500);
      });
    </script>
  </body>
</html>
