<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/header :: head"></head>
  <style th:replace="fragments/sidebar_accountant :: sidebar-styles"></style>
  <style>
    .table td {
      text-align: center !important;
      vertical-align: middle !important;
    }
  </style>
  <body class="bg-light">
    <nav th:replace="fragments/header :: navbar"></nav>

    <!-- Sidebar -->
    <div th:replace="fragments/sidebar_accountant :: sidebar-accountant"></div>

    <!-- Main Content -->
    <div class="main-content-with-sidebar">
      <div class="container-fluid p-4">
        <h3 class="mb-4">üßæ Qu·∫£n l√Ω h√≥a ƒë∆°n</h3>

      <table class="table table-hover">
        <thead>
          <tr class="table-primary text-center">
            <th>ID</th>
            <th>S·ªë h√≥a ƒë∆°n</th>
            <th>ƒê∆°n h√†ng</th>
            <th>T·ªïng ti·ªÅn</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="invoices-table"></tbody>
      </table>

      <script>
        async function loadInvoices() {
          const res = await fetch("/api/accountant/invoices", {
            credentials: "include",
          });
          if (!res.ok) {
            document.getElementById("invoices-table").innerHTML =
              '<tr><td colspan="6">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu h√≥a ƒë∆°n</td></tr>';
            return;
          }
          const data = await res.json();
          const tbody = document.getElementById("invoices-table");
          tbody.innerHTML = data
            .map(
              (inv) => {
                return `<tr>
                    <td>${inv.id}</td>
                    <td>${inv.invoiceNumber}</td>
                    <td>${inv.orderCode || "N/A"}</td>
                    <td>${formatCurrency(inv.finalAmount || 0)}</td>
                    <td><span class="badge bg-${getStatusBadge(inv.status)}">${inv.status}</span></td>
                    <td>
                        <button class='btn btn-info btn-sm' onclick='view(${inv.id})' title='Xem chi ti·∫øt'>
                            <i class='bi bi-eye'></i> Xem
                        </button>
                    </td>
                </tr>`;
              }
            )
            .join("");
        }

        function formatCurrency(amount) {
          return new Intl.NumberFormat("vi-VN", {
            style: "currency",
            currency: "VND",
          }).format(amount);
        }

        function getStatusBadge(status) {
          const badges = {
            PAID: "success",
            PENDING: "warning",
            OVERDUE: "danger",
            CANCELLED: "secondary",
          };
          return badges[status] || "secondary";
        }

        function view(id) {
          if (!id || id === 0) {
            alert('ID kh√¥ng h·ª£p l·ªá: ' + id);
            return;
          }
          window.location.href = `/web/accountant/invoices/${id}`;
        }

        loadInvoices();
      </script>
      </div>
    </div>

    <footer th:replace="fragments/footer :: footer"></footer>

    <!-- Sidebar Script -->
    <script th:replace="fragments/sidebar_accountant :: sidebar-script"></script>
  </body>
</html>
