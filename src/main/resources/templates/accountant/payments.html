<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head"></head>
<style th:replace="fragments/sidebar_accountant :: sidebar-styles"></style>
<style>
    .table td {
        text-align: center !important;
        vertical-align: middle !important;
    }
</style>
<body class="bg-light">

<nav th:replace="fragments/header :: navbar"></nav>

<!-- Sidebar -->
<div th:replace="fragments/sidebar_accountant :: sidebar-accountant"></div>

<!-- Main Content -->
<div class="main-content-with-sidebar">
    <div class="container-fluid p-4">
        <h3 class="mb-4">üí≥ Qu·∫£n l√Ω thanh to√°n</h3>

        <!-- Filter Section -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">B·ªô l·ªçc</h5>
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                        <select class="form-select" id="filterMethod">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="CASH">Ti·ªÅn m·∫∑t</option>
                            <option value="BANK_TRANSFER">Chuy·ªÉn kho·∫£n</option>
                            <option value="E_WALLET">V√≠ ƒëi·ªán t·ª≠</option>
                            <option value="CREDIT_CARD">Th·∫ª t√≠n d·ª•ng</option>
                            <option value="VNPAY">VNPay</option>
                            <option value="MOMO">MoMo</option>
                            <option value="COD">Thu h·ªô (COD)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tr·∫°ng th√°i</label>
                        <select class="form-select" id="filterStatus">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="PENDING">Ch·ªù x·ª≠ l√Ω</option>
                            <option value="COMPLETED">ƒê√£ ho√†n th√†nh</option>
                            <option value="FAILED">Th·∫•t b·∫°i</option>
                            <option value="REFUNDED">ƒê√£ ho√†n ti·ªÅn</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary" onclick="loadPayments()">
                            <i class="bi bi-funnel"></i> L·ªçc
                        </button>
                        <button class="btn btn-secondary" onclick="resetFilters()">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payments Table -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Danh s√°ch thanh to√°n</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr class="table-primary text-center">
                            <th>ID</th>
                            <th>ƒê∆°n h√†ng</th>
                            <th>S·ªë ti·ªÅn</th>
                            <th>Ph∆∞∆°ng th·ª©c</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>Thao t√°c</th>
                        </tr>
                        </thead>
                        <tbody id="payments-table">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> ƒêang t·∫£i d·ªØ li·ªáu...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadPayments() {
        try {
            const filterMethod = document.getElementById('filterMethod').value;
            const filterStatus = document.getElementById('filterStatus').value;
            
            let url = '/api/accountant/payments';
            
            // Apply filters
            if (filterMethod) {
                url = `/api/accountant/payments/method/${filterMethod}`;
            } else if (filterStatus) {
                url = `/api/accountant/payments/status/${filterStatus}`;
            }
            
            const res = await fetch(url, { credentials: 'include' });
            if (!res.ok) throw new Error('Failed to load payments');
            
            const data = await res.json();
            const tbody = document.getElementById('payments-table');
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="bi bi-inbox"></i> Kh√¥ng c√≥ d·ªØ li·ªáu thanh to√°n
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map(p => {
                const isCompleted = p.status === 'COMPLETED' || p.status === 'ƒê√£ thanh to√°n';
                const isPending = p.status === 'PENDING' || p.status === 'Ch·ªù thanh to√°n';
                
                return `<tr>
                    <td>${p.id}</td>
                    <td>${p.orderCode || "N/A"}</td>
                    <td><strong>${formatCurrency(p.amount || 0)}</strong></td>
                    <td><span class="badge bg-secondary">${getPaymentMethodDisplay(p.paymentMethod)}</span></td>
                    <td><span class="badge bg-${getPaymentStatusBadge(p.status)}">${getStatusDisplay(p.status)}</span></td>
                    <td>${formatDate(p.createdAt)}</td>
                    <td>
                        ${isPending ? `
                            <button class='btn btn-success btn-sm me-1' onclick='confirmPayment(${p.id})' title='X√°c nh·∫≠n thanh to√°n'>
                                <i class='bi bi-check-circle'></i> X√°c nh·∫≠n
                            </button>
                        ` : ''}
                        ${isCompleted ? `
                            <button class='btn btn-warning btn-sm' onclick='refund(${p.id})' title='Ho√†n ti·ªÅn'>
                                <i class='bi bi-arrow-counterclockwise'></i> Ho√†n ti·ªÅn
                            </button>
                        ` : ''}
                        ${!isCompleted && !isPending ? `
                            <span class='text-muted'><i class='bi bi-dash-circle'></i> N/A</span>
                        ` : ''}
                    </td>
                </tr>`;
            }).join('');
        } catch (error) {
            console.error('Error loading payments:', error);
            alert('L·ªói khi t·∫£i danh s√°ch thanh to√°n: ' + error.message);
        }
    }
    
    function resetFilters() {
        document.getElementById('filterMethod').value = '';
        document.getElementById('filterStatus').value = '';
        loadPayments();
    }
    
    function getPaymentMethodDisplay(method) {
        const methods = {
            'CASH': 'Ti·ªÅn m·∫∑t',
            'BANK_TRANSFER': 'Chuy·ªÉn kho·∫£n',
            'E_WALLET': 'V√≠ ƒëi·ªán t·ª≠',
            'CREDIT_CARD': 'Th·∫ª t√≠n d·ª•ng',
            'VNPAY': 'VNPay',
            'MOMO': 'MoMo',
            'COD': 'COD'
        };
        return methods[method] || method || 'N/A';
    }
    
    function getStatusDisplay(status) {
        const statuses = {
            'PENDING': 'Ch·ªù x·ª≠ l√Ω',
            'COMPLETED': 'ƒê√£ ho√†n th√†nh',
            'FAILED': 'Th·∫•t b·∫°i',
            'REFUNDED': 'ƒê√£ ho√†n ti·ªÅn'
        };
        return statuses[status] || status;
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleString('vi-VN');
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }

    function getPaymentStatusBadge(status) {
        const badges = {
            'COMPLETED': 'success',
            'PENDING': 'warning',
            'FAILED': 'danger',
            'REFUNDED': 'secondary'
        };
        return badges[status] || 'secondary';
    }

    async function confirmPayment(id) {
        await fetch(`/api/accountant/payments/${id}/confirm`, {
            method: 'POST',
            credentials: 'include'
        });
        alert('ƒê√£ x√°c nh·∫≠n thanh to√°n');
        loadPayments();
    }

    async function refund(id) {
        await fetch(`/api/accountant/payments/${id}/refund`, {
            method: 'POST',
            credentials: 'include'
        });
        alert('ƒê√£ ho√†n ti·ªÅn');
        loadPayments();
    }

    loadPayments();
</script>
    </div>
</div>

<footer th:replace="fragments/footer :: footer"></footer>

<!-- Sidebar Script -->
<script th:replace="fragments/sidebar_accountant :: sidebar-script"></script>

</body>
</html>
