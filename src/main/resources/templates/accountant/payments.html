<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head"></head>
<style th:replace="fragments/sidebar_accountant :: sidebar-styles"></style>
<style>
    .table td {
        text-align: center !important;
        vertical-align: middle !important;
    }
</style>
<body class="bg-light">

<nav th:replace="fragments/header :: navbar"></nav>

<!-- Sidebar -->
<div th:replace="fragments/sidebar_accountant :: sidebar-accountant"></div>

<!-- Main Content -->
<div class="main-content-with-sidebar">
    <div class="container-fluid p-4">
        <h3 class="mb-4">üí≥ Danh s√°ch thanh to√°n</h3>

<table class="table table-hover">
    <thead>
    <tr class="table-primary text-center">
        <th>ID</th>
        <th>ƒê∆°n h√†ng</th>
        <th>S·ªë ti·ªÅn</th>
        <th>Ph∆∞∆°ng th·ª©c</th>
        <th>Tr·∫°ng th√°i</th>
        <th>Thao t√°c</th>
    </tr>
    </thead>
    <tbody id="payments-table"></tbody>
</table>

<script>
    async function loadPayments() {
        const res = await fetch('/api/accountant/payments', {
            credentials: 'include'
        });
        const data = await res.json();
        const tbody = document.getElementById('payments-table');
        tbody.innerHTML = data.map(p => {
            const isCompleted = p.status === 'COMPLETED' || p.status === 'ƒê√£ thanh to√°n';
            const isPending = p.status === 'PENDING' || p.status === 'Ch·ªù thanh to√°n';
            
            return `<tr>
                <td>${p.id}</td>
                <td>${p.orderCode || "N/A"}</td>
                <td>${formatCurrency(p.amount || 0)}</td>
                <td>${p.paymentMethod || "N/A"}</td>
                <td><span class="badge bg-${getPaymentStatusBadge(p.status)}">${p.status}</span></td>
                <td>
                    ${isPending ? `
                        <button class='btn btn-success btn-sm me-1' onclick='confirmPayment(${p.id})' title='X√°c nh·∫≠n thanh to√°n'>
                            <i class='bi bi-check-circle'></i> X√°c nh·∫≠n
                        </button>
                    ` : ''}
                    ${isCompleted ? `
                        <button class='btn btn-warning btn-sm' onclick='refund(${p.id})' title='Ho√†n ti·ªÅn'>
                            <i class='bi bi-arrow-counterclockwise'></i> Ho√†n ti·ªÅn
                        </button>
                    ` : ''}
                    ${!isCompleted && !isPending ? `
                        <span class='text-muted'><i class='bi bi-dash-circle'></i> Kh√¥ng kh·∫£ d·ª•ng</span>
                    ` : ''}
                </td>
            </tr>`;
        }).join('');
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }

    function getPaymentStatusBadge(status) {
        const badges = {
            'COMPLETED': 'success',
            'PENDING': 'warning',
            'FAILED': 'danger',
            'REFUNDED': 'secondary'
        };
        return badges[status] || 'secondary';
    }

    async function confirmPayment(id) {
        await fetch(`/api/accountant/payments/${id}/confirm`, {
            method: 'POST',
            credentials: 'include'
        });
        alert('ƒê√£ x√°c nh·∫≠n thanh to√°n');
        loadPayments();
    }

    async function refund(id) {
        await fetch(`/api/accountant/payments/${id}/refund`, {
            method: 'POST',
            credentials: 'include'
        });
        alert('ƒê√£ ho√†n ti·ªÅn');
        loadPayments();
    }

    loadPayments();
</script>
    </div>
</div>

<footer th:replace="fragments/footer :: footer"></footer>

<!-- Sidebar Script -->
<script th:replace="fragments/sidebar_accountant :: sidebar-script"></script>

</body>
</html>
