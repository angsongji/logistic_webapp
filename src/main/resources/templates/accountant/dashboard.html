<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head"></head>
<style th:replace="fragments/sidebar_accountant :: sidebar-styles"></style>
<style>
    .table td {
        text-align: center !important;
        vertical-align: middle !important;
    }
    
    /* Beautiful Dashboard Cards */
    .dashboard-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .card-gradient-blue {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card-gradient-green {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .card-gradient-orange {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #333 !important;
    }
    .card-gradient-red {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
    }
    .card-icon {
        opacity: 0.3;
        font-size: 4rem !important;
    }
</style>
<body class="bg-light">

<nav th:replace="fragments/header :: navbar"></nav>

<!-- Sidebar -->
<div th:replace="fragments/sidebar_accountant :: sidebar-accountant"></div>

<!-- Main Content -->
<div class="main-content-with-sidebar">
    <div class="container-fluid p-4">
        <h3 class="mb-4">üíº Dashboard K·∫ø to√°n</h3>
        
        <!-- Financial Summary Cards -->
        <div class="row mb-4 g-3">
            <div class="col-md-3">
                <div class="card dashboard-card card-gradient-blue text-white">
                    <div class="card-body position-relative">
                        <i class="bi bi-graph-up-arrow position-absolute top-0 end-0 me-3 mt-2 card-icon"></i>
                        <div class="position-relative">
                            <h4 id="totalRevenue" class="fw-bold mb-1">0 VNƒê</h4>
                            <p class="mb-0 opacity-75">üí∞ T·ªïng doanh thu</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card card-gradient-green text-white">
                    <div class="card-body position-relative">
                        <i class="bi bi-credit-card position-absolute top-0 end-0 me-3 mt-2 card-icon"></i>
                        <div class="position-relative">
                            <h4 id="totalPayments" class="fw-bold mb-1">0</h4>
                            <p class="mb-0 opacity-75">üí≥ Thanh to√°n (30 ng√†y)</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card card-gradient-orange">
                    <div class="card-body position-relative">
                        <i class="bi bi-file-earmark-text position-absolute top-0 end-0 me-3 mt-2 card-icon"></i>
                        <div class="position-relative">
                            <h4 id="pendingInvoices" class="fw-bold mb-1">0</h4>
                            <p class="mb-0 opacity-75">üìÑ H√≥a ƒë∆°n ch·ªù thanh to√°n</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card card-gradient-red text-white">
                    <div class="card-body position-relative">
                        <i class="bi bi-exclamation-triangle position-absolute top-0 end-0 me-3 mt-2 card-icon"></i>
                        <div class="position-relative">
                            <h4 id="overdueDebts" class="fw-bold mb-1">0</h4>
                            <p class="mb-0 opacity-75">‚ö†Ô∏è C√¥ng n·ª£ qu√° h·∫°n</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6>Thanh to√°n g·∫ßn ƒë√¢y</h6>
                    </div>
                    <div class="card-body">
                        <div id="recentPayments">
                            <!-- Recent payments will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6>H√≥a ƒë∆°n ch·ªù x·ª≠ l√Ω</h6>
                    </div>
                    <div class="card-body">
                        <div id="pendingInvoicesList">
                            <!-- Pending invoices will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </main>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load financial summary
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const startDate = firstDayOfMonth.toISOString().split('T')[0];
                const endDate = today.toISOString().split('T')[0];
                
                const summaryResponse = await fetch(`/api/accountant/dashboard/summary`, {
                    credentials: 'include'
                });
                if (summaryResponse.ok) {
                    const summary = await summaryResponse.json();
                    document.getElementById('totalRevenue').textContent = formatCurrency(summary.totalRevenue);
                }

                // Load today's payments
                const paymentsResponse = await fetch('/api/accountant/payments/today', {
                    credentials: 'include'
                });
                if (paymentsResponse.ok) {
                    const payments = await paymentsResponse.json();
                    document.getElementById('totalPayments').textContent = payments.length;
                    loadRecentPayments(payments.slice(0, 5));
                }

                // Load pending invoices
                const invoicesResponse = await fetch('/api/accountant/invoices/pending', {
                    credentials: 'include'
                });
                if (invoicesResponse.ok) {
                    const invoices = await invoicesResponse.json();
                    document.getElementById('pendingInvoices').textContent = invoices.length;
                    loadPendingInvoices(invoices.slice(0, 5));
                }

                // Load overdue debts
                const debtsResponse = await fetch('/api/accountant/debts/overdue', {
                    credentials: 'include'
                });
                if (debtsResponse.ok) {
                    const overdueCount = await debtsResponse.json();
                    document.getElementById('overdueDebts').textContent = overdueCount;
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function loadRecentPayments(payments) {
            const container = document.getElementById('recentPayments');
            if (payments.length === 0) {
                container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ thanh to√°n g·∫ßn ƒë√¢y</p>';
                return;
            }

            container.innerHTML = payments.map(payment => `
                <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                    <div>
                        <div class="fw-bold">${formatCurrency(payment.amount)}</div>
                        <small class="text-muted">
                            <i class="bi bi-box"></i> ${payment.orderCode || 'N/A'} ‚Ä¢ 
                            <i class="bi bi-credit-card"></i> ${payment.paymentMethod || 'N/A'}
                        </small>
                    </div>
                    <span class="badge bg-${getPaymentStatusColor(payment.status)}">${payment.status}</span>
                </div>
            `).join('');
        }

        function loadPendingInvoices(invoices) {
            const container = document.getElementById('pendingInvoicesList');
            if (invoices.length === 0) {
                container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ h√≥a ƒë∆°n ch·ªù x·ª≠ l√Ω</p>';
                return;
            }

            container.innerHTML = invoices.map(invoice => `
                <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                    <div>
                        <div class="fw-bold">${formatCurrency(invoice.finalAmount || invoice.totalAmount)}</div>
                        <small class="text-muted">
                            <i class="bi bi-file-text"></i> ${invoice.invoiceNumber} ‚Ä¢ 
                            <i class="bi bi-box"></i> ${invoice.orderCode || 'N/A'}
                        </small>
                    </div>
                    <span class="badge bg-${getInvoiceStatusColor(invoice.status)}">${invoice.status}</span>
                </div>
            `).join('');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount || 0);
        }

        function getPaymentStatusColor(status) {
            const statusMap = {
                'COMPLETED': 'success',
                'PENDING': 'warning',
                'FAILED': 'danger',
                'REFUNDED': 'info'
            };
            return statusMap[status] || 'secondary';
        }

        function getInvoiceStatusColor(status) {
            const statusMap = {
                'PAID': 'success',
                'PENDING': 'warning',
                'OVERDUE': 'danger',
                'CANCELLED': 'secondary'
            };
            return statusMap[status] || 'warning';
        }

        // Load data on page load
        loadDashboardData();
    </script>
    </div>
</div>

<footer th:replace="fragments/footer :: footer"></footer>

<!-- Sidebar Script -->
<script th:replace="fragments/sidebar_accountant :: sidebar-script"></script>

</body>
</html>
