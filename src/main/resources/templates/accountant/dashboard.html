<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head"></head>
<style th:replace="fragments/sidebar_accountant :: sidebar-styles"></style>
<body class="bg-light">

<nav th:replace="fragments/header :: navbar"></nav>

<!-- Sidebar -->
<div th:replace="fragments/sidebar_accountant :: sidebar-accountant"></div>

<!-- Main Content -->
<div class="main-content-with-sidebar">
    <div class="container-fluid p-4">
        <h3 class="mb-4">üíº Dashboard K·∫ø to√°n</h3>
        
        <!-- Financial Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalRevenue">0 VNƒê</h4>
                                <p class="mb-0">T·ªïng doanh thu</p>
                            </div>
                            <i class="bi bi-currency-dollar fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalPayments">0</h4>
                                <p class="mb-0">Thanh to√°n h√¥m nay</p>
                            </div>
                            <i class="bi bi-credit-card fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="pendingInvoices">0</h4>
                                <p class="mb-0">H√≥a ƒë∆°n ch·ªù thanh to√°n</p>
                            </div>
                            <i class="bi bi-file-text fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="overdueDebts">0</h4>
                                <p class="mb-0">C√¥ng n·ª£ qu√° h·∫°n</p>
                            </div>
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <h5>Thao t√°c nhanh</h5>
                <div class="btn-group" role="group">
                    <a href="/web/accountant/payments" class="btn btn-outline-primary">
                        <i class="bi bi-credit-card"></i> Qu·∫£n l√Ω thanh to√°n
                    </a>
                    <a href="/web/accountant/invoices" class="btn btn-outline-success">
                        <i class="bi bi-file-text"></i> Qu·∫£n l√Ω h√≥a ƒë∆°n
                    </a>
                    <a href="/web/accountant/reports" class="btn btn-outline-info">
                        <i class="bi bi-graph-up"></i> B√°o c√°o t√†i ch√≠nh
                    </a>
                    <a href="/web/accountant/debts" class="btn btn-outline-warning">
                        <i class="bi bi-people"></i> Qu·∫£n l√Ω c√¥ng n·ª£
                    </a>
                    <a href="/web/accountant/commissions" class="btn btn-outline-secondary">
                        <i class="bi bi-cash-coin"></i> Hoa h·ªìng
                    </a>
                    <a href="/web/accountant/reconciliation" class="btn btn-outline-dark">
                        <i class="bi bi-bank"></i> ƒê·ªëi so√°t ng√¢n h√†ng
                    </a>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6>Thanh to√°n g·∫ßn ƒë√¢y</h6>
                    </div>
                    <div class="card-body">
                        <div id="recentPayments">
                            <!-- Recent payments will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6>H√≥a ƒë∆°n ch·ªù x·ª≠ l√Ω</h6>
                    </div>
                    <div class="card-body">
                        <div id="pendingInvoicesList">
                            <!-- Pending invoices will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </main>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load dashboard data
        async function loadDashboardData() {
            try {
                const token = localStorage.getItem('jwt');
                
                // Load financial summary
                const summaryResponse = await fetch('/api/accountant/reports/summary?startDate=2024-01-01&endDate=2024-12-31', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (summaryResponse.ok) {
                    const summary = await summaryResponse.json();
                    document.getElementById('totalRevenue').textContent = formatCurrency(summary.totalRevenue);
                }

                // Load recent payments
                const paymentsResponse = await fetch('/api/accountant/payments', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (paymentsResponse.ok) {
                    const payments = await paymentsResponse.json();
                    document.getElementById('totalPayments').textContent = payments.length;
                    loadRecentPayments(payments.slice(0, 5));
                }

                // Load pending invoices
                const invoicesResponse = await fetch('/api/accountant/invoices/status/PENDING', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (invoicesResponse.ok) {
                    const invoices = await invoicesResponse.json();
                    document.getElementById('pendingInvoices').textContent = invoices.length;
                    loadPendingInvoices(invoices.slice(0, 5));
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function loadRecentPayments(payments) {
            const container = document.getElementById('recentPayments');
            if (payments.length === 0) {
                container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ thanh to√°n g·∫ßn ƒë√¢y</p>';
                return;
            }

            container.innerHTML = payments.map(payment => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <small class="text-muted">ƒê∆°n #${payment.orderId}</small>
                        <div>${formatCurrency(payment.amount)}</div>
                    </div>
                    <span class="badge bg-${payment.status === 'COMPLETED' ? 'success' : 'warning'}">${payment.status}</span>
                </div>
            `).join('');
        }

        function loadPendingInvoices(invoices) {
            const container = document.getElementById('pendingInvoicesList');
            if (invoices.length === 0) {
                container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ h√≥a ƒë∆°n ch·ªù x·ª≠ l√Ω</p>';
                return;
            }

            container.innerHTML = invoices.map(invoice => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <small class="text-muted">${invoice.invoiceNumber}</small>
                        <div>${formatCurrency(invoice.totalAmount)}</div>
                    </div>
                    <span class="badge bg-warning">${invoice.status}</span>
                </div>
            `).join('');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount || 0);
        }

        // Load data on page load
        loadDashboardData();
    </script>
    </div>
</div>

<footer th:replace="fragments/footer :: footer"></footer>

<!-- Profile & Password Modals -->
<div th:replace="fragments/header :: profile-modal"></div>
<div th:replace="fragments/header :: password-modal"></div>

<!-- Profile Script -->
<script th:replace="fragments/header :: profile-script"></script>

<!-- Sidebar Script -->
<script th:replace="fragments/sidebar_accountant :: sidebar-script"></script>

</body>
</html>
