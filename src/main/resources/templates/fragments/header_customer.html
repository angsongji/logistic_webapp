<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:fragment="head">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${title} ?: 'UTEExpress - Customer'">UTEExpress</title>

    <!-- Bootstrap & Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>

    <style>
      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        cursor: pointer;
        border: 2px solid #fff;
      }
      .user-avatar.dropdown-toggle::after {
        display: none !important;
      }
      .badge {
        font-size: 0.7em;
      }
      .dropdown-header {
        font-size: 0.8em;
        font-weight: 600;
        color: #6c757d;
      }
      .dropdown-menu {
        z-index: 1050;
        min-width: 320px;
      }
    </style>
  </head>

  <body>
    <nav
      th:fragment="navbar"
      class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top"
    >
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/web/customer/dashboard">
          <i class="bi bi-box-seam"></i> UTEExpress
        </a>

        <div class="ms-auto d-flex align-items-center gap-3">
          <div id="userDropdown" class="dropdown d-none">
            <!-- LƯU Ý: thêm class dropdown-toggle để Bootstrap data API hoạt động ổn định -->
            <div
              id="userAvatar"
              class="user-avatar dropdown-toggle"
              role="button"
              data-bs-toggle="dropdown"
              data-bs-auto-close="outside"
              data-bs-offset="0,8"
              aria-expanded="false"
            >
              <span id="avatarInitial">U</span>
            </div>

            <ul
              class="dropdown-menu dropdown-menu-end shadow"
              aria-labelledby="userAvatar"
            >
              <li class="px-3 py-2 border-bottom">
                <div class="d-flex align-items-center">
                  <div class="user-avatar me-2">
                    <span id="avatarInitial2">U</span>
                  </div>
                  <div>
                    <div class="fw-bold" id="userName">Loading...</div>
                    <small class="text-muted" id="userEmail"
                      >loading@example.com</small
                    >
                    <small class="badge bg-primary ms-1">Khách hàng</small>
                  </div>
                </div>
              </li>
              <li>
                <a
                  class="dropdown-item"
                  href="/web/customer/profile"
                  id="profileLink"
                >
                  <i class="bi bi-person-circle me-2"></i>Tài khoản của tôi
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item"
                  href="#"
                  data-bs-toggle="modal"
                  data-bs-target="#changePasswordModal"
                >
                  <i class="bi bi-key me-2"></i>Đổi mật khẩu
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a
                  class="dropdown-item text-danger"
                  href="/auth/logout/clear-cookies"
                >
                  <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Script TỰ KHỞI TẠO ngay trong fragment -->
      <script>
        (function () {
          function getCookie(name) {
            const v = `; ${document.cookie}`;
            const p = v.split(`; ${name}=`);
            return p.length === 2 ? p.pop().split(";").shift() : null;
          }

          function setupDropdownFallback() {
            const trigger = document.getElementById("userAvatar");
            const menu = trigger ? trigger.nextElementSibling : null;
            if (!trigger || !menu) return;
            if (trigger.dataset.dropdownFallback === "1") return;

            trigger.addEventListener("click", function (e) {
              // Nếu đã có instance của Bootstrap thì để Bootstrap lo
              if (
                window.bootstrap &&
                bootstrap.Dropdown &&
                bootstrap.Dropdown.getInstance(trigger)
              )
                return;
              e.preventDefault();
              menu.classList.toggle("show");
              trigger.setAttribute(
                "aria-expanded",
                menu.classList.contains("show")
              );
            });

            document.addEventListener("click", function (e) {
              const inside =
                trigger.contains(e.target) || (menu && menu.contains(e.target));
              if (!inside && menu && menu.classList.contains("show")) {
                menu.classList.remove("show");
                trigger.setAttribute("aria-expanded", "false");
              }
            });

            trigger.dataset.dropdownFallback = "1";
          }

          function init() {
            const dd = document.getElementById("userDropdown");
            const trigger = document.getElementById("userAvatar");
            if (!dd || !trigger) return;

            // We'll try to reveal the dropdown if the profile API returns a user.
            // Fallback: if API doesn't respond, use the cookie check.
            let revealedByApi = false;
            try {
              fetch("/api/customer/profile", { credentials: "include" })
                .then((r) => {
                  if (!r.ok) return null;
                  return r.json();
                })
                .then((u) => {
                  if (!u) return;
                  // API active => reveal dropdown (ensures avatar is clickable immediately)
                  dd.classList.remove("d-none");
                  revealedByApi = true;

                  // Initialize Bootstrap dropdown instance now that element is visible
                  try {
                    if (window.bootstrap && bootstrap.Dropdown) {
                      if (!bootstrap.Dropdown.getInstance(trigger)) {
                        new bootstrap.Dropdown(trigger, {
                          autoClose: "outside",
                        });
                      }
                    }
                  } catch (e) {
                    console.warn("Bootstrap init failed", e);
                  }

                  // Ensure fallback click handler is attached
                  setupDropdownFallback();

                  const initial = (
                    u.fullName?.charAt(0) ||
                    u.username?.charAt(0) ||
                    "U"
                  ).toUpperCase();
                  const top = document.getElementById("userAvatar");
                  const inner = document.getElementById("avatarInitial2");
                  if (u.avatarUrl) {
                    if (top) {
                      top.style.background = `url('${u.avatarUrl}') center/cover`;
                      const s = document.getElementById("avatarInitial");
                      if (s) s.textContent = "";
                    }
                    if (inner && inner.parentElement) {
                      inner.parentElement.style.background = `url('${u.avatarUrl}') center/cover`;
                      inner.textContent = "";
                    }
                  } else {
                    const s1 = document.getElementById("avatarInitial");
                    const s2 = document.getElementById("avatarInitial2");
                    if (top) top.style.background = "";
                    if (inner && inner.parentElement)
                      inner.parentElement.style.background = "";
                    if (s1) s1.textContent = initial;
                    if (s2) s2.textContent = initial;
                  }
                  const nm = document.getElementById("userName");
                  const em = document.getElementById("userEmail");
                  if (nm) nm.textContent = u.fullName || u.username || "User";
                  if (em) em.textContent = u.email || "";
                })
                .catch(() => {
                  // ignore, we'll fallback to cookie check below
                });
            } catch (_) {
              // ignore
            }

            // If API didn't reveal the dropdown quickly, fallback to cookie-based check.
            setTimeout(() => {
              if (!revealedByApi) {
                const isAuth = getCookie("is_authenticated") === "true";
                if (isAuth || dd.hasAttribute("data-debug-force")) {
                  dd.classList.remove("d-none");

                  // ensure bootstrap instance + fallback are present
                  try {
                    if (window.bootstrap && bootstrap.Dropdown) {
                      if (!bootstrap.Dropdown.getInstance(trigger)) {
                        new bootstrap.Dropdown(trigger, {
                          autoClose: "outside",
                        });
                      }
                    }
                  } catch (e) {
                    console.warn("Bootstrap init failed", e);
                  }
                  setupDropdownFallback();
                }
              }
            }, 250);
          }

          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", init);
          } else {
            init();
          }
          window.addEventListener("load", init);
        })();
      </script>
    </nav>

    <!-- Profile Modal -->
    <div
      th:fragment="profile-modal"
      class="modal fade"
      id="profileModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tài khoản của tôi</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="profileForm">
              <div class="mb-3">
                <label class="form-label">Tên đăng nhập</label
                ><input
                  type="text"
                  class="form-control"
                  id="profileUsername"
                  readonly
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label
                ><input
                  type="email"
                  class="form-control"
                  id="profileEmail"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Họ và tên</label
                ><input
                  type="text"
                  class="form-control"
                  id="profileFullName"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Số điện thoại</label
                ><input type="tel" class="form-control" id="profilePhone" />
              </div>
              <div id="profileAlert" class="alert d-none"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveProfile()"
            >
              Lưu thay đổi
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div th:replace="fragments/change_password_modal :: change-password-modal"></div>

    <!-- Change Password Script -->
    <script th:replace="fragments/change_password_modal :: change-password-script"></script>

    <!-- Profile Script -->
    <script th:fragment="profile-script">
      // saveProfile function for modal
      async function saveProfile() {
        const alertBox = document.getElementById("profileAlert");
        const body = {
          email: document.getElementById("profileEmail").value,
          fullName: document.getElementById("profileFullName").value,
          phone: document.getElementById("profilePhone").value,
        };
        try {
          const r = await fetch("/api/customer/profile", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(body),
          });
          if (r.ok) {
            alertBox.className = "alert alert-success";
            alertBox.textContent = "Cập nhật thành công!";
            alertBox.classList.remove("d-none");
            setTimeout(() => {
              const inst = bootstrap.Modal.getInstance(
                document.getElementById("profileModal")
              );
              inst && inst.hide();
            }, 900);
          } else {
            alertBox.className = "alert alert-danger";
            alertBox.textContent = (await r.text()) || "Cập nhật thất bại";
            alertBox.classList.remove("d-none");
          }
        } catch (_) {
          alertBox.className = "alert alert-danger";
          alertBox.textContent = "Lỗi khi cập nhật";
          alertBox.classList.remove("d-none");
        }
      }

      // Load profile data into modal
      async function loadProfileModal() {
        try {
          const response = await fetch("/api/customer/profile", {
            credentials: "include",
          });
          if (response.ok) {
            const user = await response.json();
            document.getElementById("profileUsername").value = user.username || "";
            document.getElementById("profileEmail").value = user.email || "";
            document.getElementById("profileFullName").value = user.fullName || "";
            document.getElementById("profilePhone").value = user.phone || "";
          }
        } catch (error) {
          console.error("Error loading profile:", error);
        }
      }

      // Initialize dropdown functionality
      document.addEventListener("DOMContentLoaded", function() {
        const profileLink = document.getElementById("profileLink");
        if (profileLink) {
          // Always let the link work normally - no modal override
          // The link will navigate to /web/customer/profile as intended
        }
      });
    </script>
  </body>
</html>
