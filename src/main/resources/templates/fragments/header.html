<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:fragment="head">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${title} ?: 'UTEExpress'">UTEExpress</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        cursor: pointer;
        border: 2px solid white;
      }
      .dropdown-menu {
        min-width: 320px;
      }
      .badge {
        font-size: 0.7em;
      }
      .dropdown-header {
        font-size: 0.8em;
        font-weight: 600;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <nav
      th:fragment="navbar"
      class="navbar navbar-expand-lg navbar-dark bg-primary"
    >
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/web/customer/dashboard">
          <i class="bi bi-box-seam"></i> UTEExpress
        </a>
        <div class="d-flex align-items-center gap-3">
          <!-- User Profile Dropdown when authenticated -->
          <div id="userDropdown" class="dropdown d-none">
            <div
              class="user-avatar"
              id="userAvatar"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span id="avatarInitial">U</span>
            </div>
            <ul
              class="dropdown-menu dropdown-menu-end shadow"
              aria-labelledby="userAvatar"
            >
              <li class="px-3 py-2 border-bottom">
                <div class="d-flex align-items-center">
                  <div class="user-avatar me-2">
                    <span id="avatarInitial2">U</span>
                  </div>
                  <div>
                    <div class="fw-bold" id="userName">Loading...</div>
                    <small class="text-muted" id="userEmail"
                      >loading@example.com</small
                    >
                    <small class="badge bg-primary ms-1" id="userRole"
                      >User</small
                    >
                  </div>
                </div>
              </li>
              <li>
                <a class="dropdown-item" href="#" id="profileLink">
                  <i class="bi bi-person-circle me-2"></i>Tài khoản của tôi
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item"
                  href="#"
                  data-bs-toggle="modal"
                  data-bs-target="#changePasswordModal"
                >
                  <i class="bi bi-key me-2"></i>Đổi mật khẩu
                </a>
              </li>
              <!-- Role-specific menu items -->
              <li id="accountantMenu" class="d-none">
                <hr class="dropdown-divider" />
                <h6 class="dropdown-header">Kế toán</h6>
                <a class="dropdown-item" href="/web/accountant/dashboard">
                  <i class="bi bi-calculator me-2"></i>Dashboard Kế toán
                </a>
                <a class="dropdown-item" href="/web/accountant/payments">
                  <i class="bi bi-receipt me-2"></i>Quản lý thanh toán
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a
                  class="dropdown-item text-danger"
                  href="/auth/logout/clear-cookies"
                >
                  <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- Profile Modal -->
    <div
      th:fragment="profile-modal"
      class="modal fade"
      id="profileModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tài khoản của tôi</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="profileForm">
              <div class="mb-3">
                <label class="form-label">Tên đăng nhập</label>
                <input
                  type="text"
                  class="form-control"
                  id="profileUsername"
                  readonly
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="profileEmail"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Họ và tên</label>
                <input
                  type="text"
                  class="form-control"
                  id="profileFullName"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Số điện thoại</label>
                <input type="tel" class="form-control" id="profilePhone" />
              </div>
              <div id="profileAlert" class="alert d-none"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveProfile()"
            >
              Lưu thay đổi
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div
      th:fragment="password-modal"
      class="modal fade"
      id="changePasswordModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Đổi mật khẩu</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="passwordForm">
              <div class="mb-3">
                <label class="form-label">Mật khẩu hiện tại</label>
                <input
                  type="password"
                  class="form-control"
                  id="currentPassword"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Mật khẩu mới</label>
                <input
                  type="password"
                  class="form-control"
                  id="newPassword"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Xác nhận mật khẩu mới</label>
                <input
                  type="password"
                  class="form-control"
                  id="confirmNewPassword"
                  required
                />
              </div>
              <div id="passwordAlert" class="alert d-none"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="changePassword()"
            >
              Đổi mật khẩu
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- User Profile Script -->
    <script th:fragment="profile-script">
      // Utility function to get cookie value
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
        return null;
      }

      // Debug function to show all cookies
      function debugCookies() {
        console.log("All cookies:", document.cookie);
        console.log("is_authenticated:", getCookie("is_authenticated"));
        console.log("user_role:", getCookie("user_role"));
      }

      // Check authentication status
      function checkAuthStatus() {
        debugCookies(); // Debug all cookies
        const isAuthenticated = getCookie("is_authenticated");
        const role = getCookie("user_role");

        console.log("Checking auth status:", { isAuthenticated, role });

        if (isAuthenticated === "true") {
          // User is authenticated
          console.log("User is authenticated, showing dropdown");
          const userDropdown = document.getElementById("userDropdown");
          if (userDropdown) {
            userDropdown.classList.remove("d-none");
            console.log("Dropdown shown successfully");

            // Initialize Bootstrap dropdown after showing. Add a fallback toggle if initialization fails.
            setTimeout(() => {
              const userAvatar = document.getElementById("userAvatar");
              const dropdownMenu = userAvatar
                ? userAvatar.nextElementSibling
                : null;
              try {
                if (userAvatar && typeof bootstrap !== "undefined") {
                  // Prefer Bootstrap's JS API
                  // Avoid double-initialization by checking for existing dropdown instance
                  if (!bootstrap.Dropdown.getInstance(userAvatar)) {
                    new bootstrap.Dropdown(userAvatar);
                    console.log("Bootstrap dropdown initialized");
                  } else {
                    console.log("Bootstrap dropdown instance already exists");
                  }
                } else if (userAvatar && dropdownMenu) {
                  // Fallback: toggle `show` class on menu when avatar clicked
                  console.warn(
                    "Bootstrap not available; attaching fallback click handler for dropdown"
                  );
                  userAvatar.addEventListener("click", (e) => {
                    e.preventDefault();
                    dropdownMenu.classList.toggle("show");
                    const expanded = dropdownMenu.classList.contains("show");
                    userAvatar.setAttribute("aria-expanded", expanded);
                  });
                }
              } catch (err) {
                console.error("Error initializing dropdown:", err);
                if (userAvatar && dropdownMenu) {
                  userAvatar.addEventListener("click", (e) => {
                    e.preventDefault();
                    dropdownMenu.classList.toggle("show");
                    const expanded = dropdownMenu.classList.contains("show");
                    userAvatar.setAttribute("aria-expanded", expanded);
                  });
                }
              }
            }, 100);
            // Ensure avatar click toggles dropdown instance explicitly (fixes cases where data-api doesn't fire)
            if (userAvatar && !userAvatar.dataset.dropdownHandlerBound) {
              try {
                userAvatar.dataset.dropdownHandlerBound = "true";
                userAvatar.addEventListener("click", (e) => {
                  const inst =
                    typeof bootstrap !== "undefined" && bootstrap.Dropdown
                      ? bootstrap.Dropdown.getInstance(userAvatar)
                      : null;
                  if (inst && typeof inst.toggle === "function") {
                    // Let Bootstrap manage toggle
                    inst.toggle();
                    console.log(
                      "Toggled dropdown via explicit bootstrap instance toggle"
                    );
                    e.preventDefault();
                    return;
                  }
                  // Fallback to class toggle
                  if (dropdownMenu) {
                    dropdownMenu.classList.toggle("show");
                    const expanded = dropdownMenu.classList.contains("show");
                    userAvatar.setAttribute("aria-expanded", expanded);
                    console.log("Toggled dropdown via fallback class toggle");
                    e.preventDefault();
                  }
                });

                // Close dropdown when clicking outside
                document.addEventListener("click", (docEvt) => {
                  const target = docEvt.target;
                  const isClickInside =
                    userAvatar.contains(target) ||
                    (dropdownMenu && dropdownMenu.contains(target));
                  const inst =
                    typeof bootstrap !== "undefined" && bootstrap.Dropdown
                      ? bootstrap.Dropdown.getInstance(userAvatar)
                      : null;
                  if (!isClickInside) {
                    if (inst && typeof inst.hide === "function") {
                      try {
                        inst.hide();
                      } catch (e) {
                        /* ignore */
                      }
                    }
                    if (
                      dropdownMenu &&
                      dropdownMenu.classList.contains("show")
                    ) {
                      dropdownMenu.classList.remove("show");
                      userAvatar.setAttribute("aria-expanded", "false");
                    }
                  }
                });
              } catch (bindErr) {
                console.error(
                  "Error binding explicit dropdown handlers:",
                  bindErr
                );
              }
            }
          } else {
            console.error("userDropdown element not found!");
          }

          // Show role-specific menus
          if (role === "ROLE_ACCOUNTANT") {
            const accountantMenu = document.getElementById("accountantMenu");
            if (accountantMenu) {
              accountantMenu.classList.remove("d-none");
              console.log("Accountant menu shown");
            } else {
              console.error("accountantMenu element not found!");
            }
            document.getElementById("userRole").textContent = "Kế toán";
            document.getElementById("userRole").className =
              "badge bg-warning ms-1";
          } else {
            document.getElementById("userRole").textContent = "Khách hàng";
            document.getElementById("userRole").className =
              "badge bg-primary ms-1";
          }

          // Load user profile
          loadUserProfile();
        } else {
          // User is not authenticated
          console.log("User is not authenticated, hiding dropdown");
          const userDropdown = document.getElementById("userDropdown");
          if (userDropdown) {
            userDropdown.classList.add("d-none");
            console.log("Dropdown hidden successfully");
          } else {
            console.error("userDropdown element not found!");
          }
        }
      }

      // Load user profile on page load
      async function loadUserProfile() {
        try {
          const res = await fetch("/api/customer/profile", {
            credentials: "include",
          });
          if (res.ok) {
            const user = await res.json();

            // Update avatar initials
            const initial = user.fullName
              ? user.fullName.charAt(0).toUpperCase()
              : user.username.charAt(0).toUpperCase();
            document.getElementById("avatarInitial").textContent = initial;
            document.getElementById("avatarInitial2").textContent = initial;

            // Update dropdown info
            document.getElementById("userName").textContent =
              user.fullName || user.username;
            document.getElementById("userEmail").textContent = user.email;

            // Update profile form
            document.getElementById("profileUsername").value =
              user.username || "";
            document.getElementById("profileEmail").value = user.email || "";
            document.getElementById("profileFullName").value =
              user.fullName || "";
            document.getElementById("profilePhone").value = user.phone || "";
          } else {
            // If profile load fails, show basic info from cookies
            showBasicUserInfo();
          }
        } catch (error) {
          console.error("Error loading user profile:", error);
          // Show basic info from cookies
          showBasicUserInfo();
        }
      }

      // Show basic user info when API is not available
      function showBasicUserInfo() {
        // Get username from role or use default
        const role = getCookie("user_role");

        // Use role to determine display name
        let username = "User";
        if (role === "ROLE_CUSTOMER") {
          username = "Khách hàng";
        } else if (role === "ROLE_ACCOUNTANT") {
          username = "Kế toán";
        }

        // Update avatar initials
        const initial = username.charAt(0).toUpperCase();
        document.getElementById("avatarInitial").textContent = initial;
        document.getElementById("avatarInitial2").textContent = initial;

        // Update dropdown info
        document.getElementById("userName").textContent = username;
        document.getElementById("userEmail").textContent = "Loading...";

        // Update profile form with basic info
        document.getElementById("profileUsername").value = username;
        document.getElementById("profileEmail").value = "";
        document.getElementById("profileFullName").value = "";
        document.getElementById("profilePhone").value = "";
      }

      // Save profile changes
      async function saveProfile() {
        const alertBox = document.getElementById("profileAlert");
        const formData = {
          email: document.getElementById("profileEmail").value,
          fullName: document.getElementById("profileFullName").value,
          phone: document.getElementById("profilePhone").value,
        };

        try {
          const res = await fetch("/api/customer/profile", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify(formData),
          });

          if (res.ok) {
            alertBox.className = "alert alert-success";
            alertBox.textContent = "Cập nhật thành công!";
            alertBox.classList.remove("d-none");

            // Reload profile
            await loadUserProfile();

            setTimeout(() => {
              bootstrap.Modal.getInstance(
                document.getElementById("profileModal")
              ).hide();
            }, 1500);
          } else {
            const error = await res.text();
            alertBox.className = "alert alert-danger";
            alertBox.textContent = error || "Cập nhật thất bại";
            alertBox.classList.remove("d-none");
          }
        } catch (error) {
          console.error("Error saving profile:", error);
          alertBox.className = "alert alert-danger";
          alertBox.textContent = "Lỗi khi cập nhật thông tin";
          alertBox.classList.remove("d-none");
        }
      }

      // Change password
      async function changePassword() {
        const alertBox = document.getElementById("passwordAlert");
        const currentPassword =
          document.getElementById("currentPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmNewPassword").value;

        if (newPassword !== confirmPassword) {
          alertBox.className = "alert alert-danger";
          alertBox.textContent = "Mật khẩu mới không khớp";
          alertBox.classList.remove("d-none");
          return;
        }

        try {
          const res = await fetch("/api/customer/change-password", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify({
              currentPassword,
              newPassword,
            }),
          });

          if (res.ok) {
            alertBox.className = "alert alert-success";
            alertBox.textContent = "Đổi mật khẩu thành công!";
            alertBox.classList.remove("d-none");

            document.getElementById("passwordForm").reset();

            setTimeout(() => {
              bootstrap.Modal.getInstance(
                document.getElementById("changePasswordModal")
              ).hide();
            }, 1500);
          } else {
            const error = await res.text();
            alertBox.className = "alert alert-danger";
            alertBox.textContent = error || "Đổi mật khẩu thất bại";
            alertBox.classList.remove("d-none");
          }
        } catch (error) {
          console.error("Error changing password:", error);
          alertBox.className = "alert alert-danger";
          alertBox.textContent = "Lỗi khi đổi mật khẩu";
          alertBox.classList.remove("d-none");
        }
      }

      // Check authentication status on page load
      console.log("Header script loaded, checking auth status...");

      // Force check after a short delay to ensure DOM is ready
      setTimeout(() => {
        console.log("Delayed auth check...");
        checkAuthStatus();
      }, 100);

      // Also check immediately
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", checkAuthStatus);
      } else {
        checkAuthStatus();
      }

      // Additional check after page is fully loaded
      window.addEventListener("load", () => {
        console.log("Page fully loaded, checking auth status again...");
        checkAuthStatus();
      });

      // Function to clear non-HTTP-only authentication cookies
      function clearAuthCookies() {
        // Only clear cookies that are not HTTP-only (jwt_token is HTTP-only, so skip it)
        const cookies = ["is_authenticated", "user_role"];
        cookies.forEach((cookieName) => {
          // Clear with different path combinations
          document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
          document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=localhost;`;
          document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.localhost;`;
          document.cookie = `${cookieName}=; max-age=0; path=/;`;
          document.cookie = `${cookieName}=; max-age=-1; path=/;`;
        });
        console.log(
          "Cleared non-HTTP-only auth cookies (jwt_token is HTTP-only, so server must clear it)"
        );
      }

      // Handle profile link click based on role
      function handleProfileClick(event) {
        event.preventDefault();
        const role = getCookie("user_role");

        if (role === "ROLE_ACCOUNTANT") {
          // Show modal for accountant
          const modal = new bootstrap.Modal(
            document.getElementById("profileModal")
          );
          modal.show();
        } else {
          // Redirect to profile page for customer
          window.location.href = "/web/customer/profile";
        }
      }

      // Add event listener to profile link
      document.addEventListener("DOMContentLoaded", function () {
        const profileLink = document.getElementById("profileLink");
        if (profileLink) {
          profileLink.addEventListener("click", handleProfileClick);
        }
      });

      // Make functions available globally for debugging
      window.checkAuthStatus = checkAuthStatus;
      window.debugCookies = debugCookies;
      window.clearAuthCookies = clearAuthCookies;
    </script>
  </body>
</html>
